<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>이벤트 데이터 조회 + OCR</title>
<style>
  :root{--pri:#2563eb;--text:#2c3e50;--bg:#f4f7f9;--b:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#333;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif}
  .page{display:flex;gap:18px;padding:14px}
  .pane{flex:1;background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:14px}
  h2{margin:0 0 10px;color:var(--text);font-size:18px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input,select,button,textarea{font-size:14px}
  input,select,textarea{border:1px solid var(--b);border-radius:8px;padding:9px}
  button{background:var(--pri);color:#fff;border:0;border-radius:8px;padding:9px 12px;cursor:pointer}
  button.ghost{background:#eef2ff;color:#1f34a2}
  button.light{background:#e5e7eb;color:#333}
  .tag{background:#eef6ff;border:1px solid #cfe3ff;color:#1f6feb;border-radius:999px;padding:3px 8px;font-size:12px}
  .table-wrap{overflow:auto;border:1px solid var(--b);border-radius:8px}
  table{width:100%;border-collapse:collapse;min-width:720px}
  th,td{border-bottom:1px solid #f0f2f5;padding:8px;white-space:nowrap}
  th{background:#f6f8fa;text-align:left;font-weight:600;color:#334155}
  tr:nth-child(even) td{background:#fafafa}
  td input{width:100%;padding:7px;border:1px solid #e5e7eb;border-radius:6px;background:#fff}
  .chk{text-align:center;width:36px}
  .right{display:flex;flex-direction:column;gap:12px}
  .ocr-box{display:flex;gap:12px}
  .ocr-left{flex:0 0 260px;border:1px dashed var(--b);border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:360px;overflow:hidden;background:#fbfbfd}
  .ocr-left img{max-width:100%;max-height:100%}
  .ocr-right{flex:1;display:flex;flex-direction:column;gap:8px}
  textarea{width:100%;min-height:180px;resize:vertical}
  .small{font-size:12px;color:#64748b}
  .ok{color:#0a7a28}
  .err{color:#b91c1c}
  .pill{padding:3px 8px;border-radius:999px;background:#f1f5f9}
  .grid2{display:grid;grid-template-columns:1fr auto auto auto;gap:8px}
  .flex-gap{display:flex;gap:6px;align-items:center}
  .manual{display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:8px}
</style>
</head>
<body>

<div class="page">
  <!-- LEFT: DATA TABLE -->
  <div class="pane">
    <h2>이벤트 데이터 조회</h2>

    <div class="row">
      <input id="uidInput" placeholder="고유번호 (예: AH1018)" style="width:220px"/>
      <button id="btnLoad">불러오기</button>
      <span class="tag" id="countTag" style="display:none"></span>
      <span class="small" id="loadInfo"></span>
    </div>

    <div class="row">
      <div class="flex-gap">
        <button class="ghost" id="btnAddRow">행 추가</button>
        <button class="light" id="btnDeleteSel">선택 삭제</button>
        <button id="btnApply">DB 반영</button>
      </div>
      <span class="small">※ 표에서 값 직접 수정 가능(UID/날짜/시간/시리얼). ‘DB 반영’ 눌러야 저장됩니다.</span>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th class="chk"><input type="checkbox" id="chkAll"/></th>
            <th>고유번호</th>
            <th>날짜(YYYY.MM.DD)</th>
            <th>시간(HH:MM)</th>
            <th>인증샷 시리얼넘버</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- rows -->
        </tbody>
      </table>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="light" id="btnMakeMsg">메시지 생성</button>
      <button class="ghost" id="btnCopyMsg">복사</button>
      <span class="small" id="msgInfo"></span>
    </div>
    <textarea id="messageBox" placeholder="‘메시지 생성’ 누르면 자동으로 채워집니다."></textarea>
  </div>

  <!-- RIGHT: OCR -->
  <div class="pane right">
    <h2>인증서 OCR 업로드 (붙여넣기)</h2>

    <div class="ocr-box">
      <div class="ocr-left" id="ocrPreview"><span class="small">여기에 캡처 이미지를 붙여넣기(Ctrl+V)</span></div>
      <div class="ocr-right">
        <div class="grid2">
          <div class="small">엔진: <span class="pill">Google Vision (DOCUMENT_TEXT_DETECTION)</span></div>
          <button class="ghost" id="btnPickLang">ko / en</button>
          <button class="light" id="btnClearOcr">지우기</button>
          <button id="btnPushToTable">왼쪽 표로 추가</button>
        </div>

        <!-- OCR 원문/파싱 로그 -->
        <textarea id="ocrLog" placeholder="OCR 원문과 파싱 로그가 여기에 표시됩니다."></textarea>

        <!-- 파싱된 값 뱃지 -->
        <div class="row" style="margin:0">
          <div class="flex-gap">
            <span class="small">파싱값</span>
            <span class="tag" id="p_date">date: -</span>
            <span class="tag" id="p_time">time: -</span>
            <span class="tag" id="p_serial">serial: -</span>
          </div>
          <span class="small" id="ocrInfo"></span>
        </div>

        <!-- ★ 수동 입력 라인(추가) -->
        <div class="manual">
          <input id="m_date"  placeholder="YYYY.MM.DD (없으면 직접 입력)"/>
          <input id="m_time"  placeholder="HH:MM (예: 0:1 → 00:01 자동보정)"/>
          <input id="m_serial" placeholder="M-... (시리얼)"/>
          <button class="light" id="btnUseParsed">파싱값 채우기</button>
        </div>
        <span class="small">※ 파싱이 틀리거나 비었다면 위 칸을 직접 채우고 ‘왼쪽 표로 추가’를 누르세요.</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= 하드코딩 설정 ========= */
const BASE_URL     = 'https://my-search-backend.onrender.com';
const API_SEARCH   = BASE_URL + '/admin/records';
const API_BULK     = BASE_URL + '/admin/records/bulk';
const ADMIN_TOKEN  = 'PHMsVsRmR1ONtsaI';

/* Google Vision */
const VISION_API_KEY = 'AIzaSyCVDnT8-FoaSFG3VJKRsz0O_g8XNpJWS-w';
const VISION_ENDPOINT = 'https://vision.googleapis.com/v1/images:annotate?key=' + encodeURIComponent((VISION_API_KEY||'').trim());
let VISION_LANG = ['ko','en'];

/* ========= 상태 ========= */
const $ = (id)=>document.getElementById(id);
const state = {
  rows: [], baseById: {}, uid: '',
  ocr: {text:'', date:null, time:null, serial:null, imgUrl:null}
};

/* ========= 도우미 ========= */
function esc(s){ return String(s==null?'':s); }
function pad2(n){ return String(n).padStart(2,'0'); }
function isYmd(s){ return /^\d{4}\.(0[1-9]|1[0-2])\.(0[1-9]|[12]\d|3[01])$/.test(s||''); }
function isHm(s){ return /^([01]\d|2[0-3]):[0-5]\d$/.test(s||''); }
function renderCountTag(){
  if(!state.rows.length){ $('countTag').style.display='none'; return; }
  $('countTag').style.display='inline-block';
  $('countTag').textContent = `${state.uid} · ${state.rows.length}건`;
}

/* ========= 테이블 렌더 ========= */
function renderTable(){
  const tb = $('tbody'); tb.innerHTML='';
  for(const row of state.rows){
    const tr = document.createElement('tr');
    tr.dataset.id = row._id || '';

    const tdChk = document.createElement('td'); tdChk.className='chk';
    const ck = document.createElement('input'); ck.type='checkbox'; ck.className='rowchk';
    tdChk.appendChild(ck);

    function mkCell(key, width){
      const td = document.createElement('td');
      const ip = document.createElement('input');
      ip.value = esc(row[key]||'');
      ip.oninput = e => row[key] = e.target.value;
      if(width) ip.style.width = width;
      td.appendChild(ip);
      return td;
    }

    tr.appendChild(tdChk);
    tr.appendChild(mkCell('unique_id','140px'));
    tr.appendChild(mkCell('날짜','130px'));
    tr.appendChild(mkCell('시간','100px'));
    tr.appendChild(mkCell('인증샷 시리얼넘버','320px'));

    tb.appendChild(tr);
  }
  renderCountTag();
}

/* ========= 로드 ========= */
async function loadUID(){
  const raw = ($('uidInput').value||'').trim(); if(!raw){ alert('고유번호를 입력하세요.'); return; }
  const uid = raw.toUpperCase(); state.uid = uid;
  $('loadInfo').textContent = '로딩 중…';

  const url = new URL(API_SEARCH);
  url.searchParams.set('unique_id', uid);
  const res = await fetch(url.toString(), { headers: {'X-Admin-Token': ADMIN_TOKEN} });
  const j = await res.json();
  if(!j.ok){ $('loadInfo').textContent = '오류'; alert(j.error||'조회 실패'); return; }

  state.rows = j.rows.map(r=>({ ...r }));
  state.baseById = {};
  for(const r of j.rows){ if(r._id) state.baseById[r._id]=JSON.parse(JSON.stringify(r)); }
  renderTable();
  $('loadInfo').textContent = '완료';
  dispatchUIDSearched(uid);
}

/* ========= 행 추가/삭제 ========= */
function addRow(prefill={}){
  const row = {_id:null, unique_id:prefill.unique_id||state.uid||'', 날짜:prefill.날짜||'', 시간:prefill.시간||'', '인증샷 시리얼넘버':prefill['인증샷 시리얼넘버']||''};
  state.rows.push(row);
  renderTable();
}
function deleteSelectedLocally(){
  const ids = [];
  document.querySelectorAll('.rowchk:checked').forEach(ck=>{
    const tr = ck.closest('tr'); const id=tr?.dataset?.id||'';
    const idx = Array.from($('tbody').children).indexOf(tr);
    if(idx>=0){ state.rows.splice(idx,1); if(id) ids.push(id); }
  });
  renderTable();
  if(ids.length) $('loadInfo').textContent = `삭제표시 ${ids.length}건 (DB 반영시 실제 삭제)`;
}

/* ========= DB 반영 ========= */
async function applyChanges(){
  if(!state.uid){ alert('먼저 고유번호를 불러오세요.'); return; }
  const inserts=[], updates=[], deletes=[];
  const currentIds = new Set(state.rows.map(r=>r._id).filter(Boolean));
  for(const _id of Object.keys(state.baseById)){ if(!currentIds.has(_id)) deletes.push(_id); }

  for(const r of state.rows){
    const uid=(r.unique_id||'').trim().toUpperCase();
    const d=(r['날짜']||'').trim();
    const t=(r['시간']||'').trim();
    const s=(r['인증샷 시리얼넘버']||'').trim();
    if(!uid || !d || !t || !s){ continue; }

    if(!r._id){ inserts.push({unique_id:uid,'날짜':d,'시간':t,'인증샷 시리얼넘버':s}); }
    else{
      const base = state.baseById[r._id]||{};
      const payload = {};
      if(uid !== (base.unique_id||'')) payload.unique_id = uid;
      if(d   !== (base['날짜']||''))   payload['날짜'] = d;
      if(t   !== (base['시간']||''))   payload['시간'] = t;
      if(s   !== (base['인증샷 시리얼넘버']||'')) payload['인증샷 시리얼넘버']=s;
      if(Object.keys(payload).length) updates.push({_id:r._id, ...payload});
    }
  }

  if(!inserts.length && !updates.length && !deletes.length){ alert('변경 사항이 없습니다.'); return; }

  $('loadInfo').textContent = 'DB 반영 중…';
  const res = await fetch(API_BULK, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Admin-Token':ADMIN_TOKEN},
    body: JSON.stringify({ insert: inserts, update: updates, delete: deletes })
  });
  const j = await res.json();
  if(!j.ok){ $('loadInfo').textContent='오류'; alert(j.error||'반영 실패'); return; }

  $('loadInfo').textContent = `반영됨: upsert ${j.upserts}, update ${j.modified}, delete ${j.deleted}`;
  loadUID().catch(()=>{});
}

/* ========= 메시지 생성 ========= */
function hmToMin(s){ const m=(s||'').match(/^(\d{1,2}):(\d{2})$/); if(!m) return null; const h=+m[1], mm=+m[2]; if(h>23||mm>59) return null; return h*60+mm; }
function computeSummary(){
  const want = new Set(['2025.09.19','2025.09.20','2025.09.21','2025.09.22','2025.09.23','2025.09.24','2025.09.25']);
  const rows = state.rows.filter(r=>want.has((r['날짜']||'').trim()));
  let cnt={'2025.09.19':0,'2025.09.20':0,'2025.09.21':0,'2025.09.22':0,'2025.09.23':0,'2025.09.24':0}, first25=0, live=0;
  for(const r of rows){
    const d=(r['날짜']||'').trim(); const t=(r['시간']||'').trim();
    if(d==='2025.09.25'){ const m=hmToMin(t); if(m!=null){ if(m<=599) first25++; else if(m>=720) live++; } }
    else if(cnt.hasOwnProperty(d)){ cnt[d]++; }
  }
  const preTotal=Object.values(cnt).reduce((a,b)=>a+b,0)+first25;
  const perfect=Object.values(cnt).every(v=>v>0)&&first25>0;
  return {...cnt, first25, live, preTotal, perfect};
}
function makeMessage(){
  const uid=state.uid||'고유번호';
  const S=computeSummary(); const w=S.perfect?(S.live*8):S.live;
  const msg =
`📢 ${uid} 님, 최종 집계 안내입니다.

✔전체 투표 참여내역
(09.19 - 09.25)
19일 - ${S['2025.09.19']}건
20일 - ${S['2025.09.20']}건
21일 - ${S['2025.09.21']}건
22일 - ${S['2025.09.22']}건
23일 - ${S['2025.09.23']}건
24일 - ${S['2025.09.24']}건
25일 사전투표 - ${S.first25}건
25일 생방투표 - ${S.live}건

🍀 사전 투표기간 총 누적투표수 : ${S.preTotal}건
(생방 투표는 누적투표수에 포함되지 않습니다.)

${uid} 님은 ${S.perfect ? '개근에 해당됩니다.' : '개근에 해당되지 않습니다.'}
개근은 19일 투표부터 25일 오전 투표까지 모두 해주신 분들만 해당됩니다.

25일 생방 투표 참여내역은 ${S.live}건입니다.
개근 여부에 따른 생방 이벤트 총 가중치는 ${S.perfect ? `${S.live} → 8×${S.live} = ${w}` : `${w}`} 입니다.

씬롱이에게 투표해주셔서 감사드립니다😺
원활한 검수를 위해 답장은 보내지 말아주세요🙏

누락 및 정정 문의는 이곳이 아닌 문의 채널 "허씬롱 갤러리 Q&A"로 부탁드립니다.
반드시 문의 전 문의 채널 하단의 양식을 참고해서 문의해주세요🙏
문의 채널 링크 📍
http://pf.kakao.com/_cFxexcn`;
  $('messageBox').value = msg;
  $('msgInfo').textContent = '생성 완료';
}
function copyMsg(){ const ta=$('messageBox'); ta.focus(); ta.select(); document.execCommand('copy'); $('msgInfo').textContent='복사됨'; setTimeout(()=>$('msgInfo').textContent='',1200); }

/* ========= OCR: Google Vision ========= */
async function blobToBase64(blob){
  const arr = new Uint8Array(await blob.arrayBuffer());
  let bin=''; const CHUNK=0x8000;
  for(let i=0;i<arr.length;i+=CHUNK){ bin+=String.fromCharCode.apply(null, arr.subarray(i,i+CHUNK)); }
  return btoa(bin);
}
async function visionOCRFromBlob(blob){
  const content = await blobToBase64(blob);
  const body = { requests: [{ image:{ content }, features:[{type:'DOCUMENT_TEXT_DETECTION'}], imageContext:{ languageHints: VISION_LANG } }] };
  const resp = await fetch(VISION_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const raw = await resp.text(); let json=null; try{ json=JSON.parse(raw) }catch{}
  if(!resp.ok){ const ge=json?.error; throw new Error((ge?.message)||raw||`HTTP ${resp.status}`); }
  return json?.responses?.[0]?.fullTextAnnotation?.text
      || json?.responses?.[0]?.textAnnotations?.[0]?.description
      || '';
}

/* 시간 후보 추출(콜론 앞/뒤 숫자 1~2자리 → HH:MM 보정) */
function extractTimesColon2(text){
  const out=new Set(); const s=String(text||'');
  for(let i=0;i<s.length;i++){
    if(s[i]!==':') continue;
    const preMatch = s.slice(Math.max(0,i-2), i).match(/\d{1,2}$/);
    const post = s.slice(i+1, i+3);
    if(!preMatch) continue;
    if(!/^\d{2}$/.test(post)) continue;
    const hh = parseInt(preMatch[0],10), mm = parseInt(post,10);
    if(hh>=0&&hh<=23 && mm>=0&&mm<=59) out.add(`${pad2(hh)}:${post}`);
  }
  return [...out];
}
function parseOCRText(allText){
  const text=String(allText||'');
  const dateRe=/\b20\d{2}\.(0[1-9]|1[0-2])\.(0[1-9]|[12]\d|3[01])\b/g;
  const serialRe=/No\.\s*(M-[A-Za-z0-9\-_]+)|\b(M-[A-Za-z0-9\-_]+)\b/g;
  const uniq=a=>[...new Set(a)];
  const dates = uniq([...text.matchAll(dateRe)].map(m=>m[0]));
  const times = extractTimesColon2(text);
  const ser   = uniq([...text.matchAll(serialRe)].map(m=>m[1]||m[2]).filter(Boolean));
  return {dates, times, serials:ser};
}
function setParsedBadges(p){
  $('p_date').textContent = 'date: ' + (p.dates[0]||'-');
  $('p_time').textContent = 'time: ' + (p.times[0]||'-');
  $('p_serial').textContent= 'serial: ' + (p.serials[0]||'-');
}

/* 붙여넣기 핸들러 */
document.addEventListener('paste', async (e)=>{
  const cd = e.clipboardData || window.clipboardData;
  let file=null;
  if(cd?.items){ for(const it of cd.items){ if(it.type?.startsWith('image/')){ file = it.getAsFile?.(); break; } } }
  if(!file && cd?.files?.length){ const f=cd.files[0]; if(f.type?.startsWith('image/')) file=f; }
  if(!file) return;

  e.preventDefault();
  const url = URL.createObjectURL(file); state.ocr.imgUrl=url;
  $('ocrPreview').innerHTML = `<img src="${url}">`;
  $('ocrInfo').textContent = 'OCR 처리 중…';

  try{
    const fullText = await visionOCRFromBlob(file);
    const raw = fullText.trim();
    const parsed = parseOCRText(raw);

    $('ocrLog').value = `【RAW】\n${raw}\n\n【PARSED】\n날짜: ${parsed.dates.join(', ')||'-'}\n시간: ${parsed.times.join(', ')||'-'}\n시리얼: ${parsed.serials.join(', ')||'-'}`;
    setParsedBadges(parsed);

    // 기본값 저장 + 수동 입력칸에 채우기
    state.ocr.text = raw;
    state.ocr.date = parsed.dates[0] || '';
    state.ocr.time = parsed.times[0] || '';
    state.ocr.serial = parsed.serials[0] || '';

    $('m_date').value  = state.ocr.date;
    $('m_time').value  = state.ocr.time;
    $('m_serial').value= state.ocr.serial;

    $('ocrInfo').textContent = '완료. 값이 비거나 틀리면 아래 칸을 수정 후 [왼쪽 표로 추가]를 누르세요.';
  }catch(err){
    $('ocrInfo').innerHTML = `<span class="err">${esc(err.message||String(err))}</span>`;
  }
}, {capture:true});

/* 파싱값 채우기(버튼) */
$('btnUseParsed').onclick = ()=>{
  $('m_date').value  = state.ocr.date || '';
  $('m_time').value  = state.ocr.time || '';
  $('m_serial').value= state.ocr.serial || '';
};

/* 시간 보정: "H:M" / "H:MM" / "HH:M" → "HH:MM" */
function normalizeHm(s){
  const m = String(s||'').trim().match(/^(\d{1,2})\s*[:시]\s*(\d{1,2})$/);
  if(!m) return null;
  let h=+m[1], mm=+m[2];
  if(h<0||h>23||mm<0||mm>59) return null;
  return `${pad2(h)}:${pad2(mm)}`;
}

/* OCR → 테이블로 추가 (수동 입력 지원) */
function pushOcrToTable(){
  const uid = (state.uid||'').trim().toUpperCase();
  if(!uid){ alert('먼저 왼쪽에서 고유번호를 불러오세요.'); return; }

  let d = $('m_date').value.trim() || state.ocr.date || '';
  let t = $('m_time').value.trim() || state.ocr.time || '';
  let s = $('m_serial').value.trim() || state.ocr.serial || '';

  // 날짜/시간 최종 검증 + 보정
  if(!isYmd(d)){ alert('날짜를 YYYY.MM.DD 형식으로 입력하세요.'); return; }
  const tFix = normalizeHm(t);
  if(!tFix){ alert('시간을 HH:MM 형식으로 입력하세요. (예: 0:1 → 00:01)'); return; }
  t = tFix;
  if(!s){ alert('시리얼(M-...)을 입력하세요.'); return; }

  addRow({unique_id:uid,'날짜':d,'시간':t,'인증샷 시리얼넘버':s});
  $('ocrInfo').innerHTML = `<span class="ok">왼쪽 표에 1행 추가됨</span>`;
}

/* 유틸: 전체 선택 */
$('chkAll').addEventListener('change', e=>{
  document.querySelectorAll('.rowchk').forEach(c=>c.checked=e.target.checked);
});

/* 버튼 바인딩 */
$('btnLoad').onclick = loadUID;
$('btnAddRow').onclick = ()=>addRow({unique_id:state.uid});
$('btnDeleteSel').onclick = deleteSelectedLocally;
$('btnApply').onclick = applyChanges;
$('btnMakeMsg').onclick = makeMessage;
$('btnCopyMsg').onclick = copyMsg;
$('btnPushToTable').onclick = pushOcrToTable;
$('btnClearOcr').onclick = ()=>{
  state.ocr={text:'',date:'',time:'',serial:'',imgUrl:null};
  $('ocrPreview').innerHTML = `<span class="small">여기에 캡처 이미지를 붙여넣기(Ctrl+V)</span>`;
  $('ocrLog').value=''; setParsedBadges({dates:[],times:[],serials:[]}); $('ocrInfo').textContent='';
  $('m_date').value=''; $('m_time').value=''; $('m_serial').value='';
};
$('btnPickLang').onclick = ()=>{
  VISION_LANG = (VISION_LANG[0]==='ko') ? ['en','ko'] : ['ko','en'];
  $('btnPickLang').textContent = VISION_LANG.join(' / ');
};

/* 브로드캐스트(연동 대비) */
function dispatchUIDSearched(uid){
  window.dispatchEvent(new CustomEvent('uidSearched',{detail:{uid}}));
}

/* 초기 포커스 */
$('uidInput').focus();
</script>
</body>
</html>
