<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>이벤트 조회·관리 + OCR 일체형</title>
  <style>
/* 바디/컨테이너 */
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;margin:0;padding:16px;background:#f4f7f9;color:#333}
.container{max-width:1300px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
h1{margin:0 0 12px;color:#2c3e50;font-size:22px}

/* 입력행/버튼 */
.row{display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:12px}
input,select,textarea{padding:10px;font-size:14px;border:1px solid #d1d5db;border-radius:8px;width:100%}
.btn{padding:10px 14px;background:#2563eb;color:#fff;border:0;border-radius:8px;cursor:pointer}
.btn.secondary{background:#6b7280}
.btn.danger{background:#b91c1c}
.btn:hover{filter:brightness(.95)}
.meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:#666;font-size:13px;margin:6px 0}
.tag{background:#eef6ff;color:#1f6feb;border:1px solid #d0e7ff;border-radius:999px;padding:4px 10px;font-size:12px}
.error{color:#d91e18}
.center{text-align:center}
.strong{font-weight:600}

/* 테이블 */
.table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;min-width:760px}
th,td{border:1px solid #eee;padding:8px;white-space:nowrap}
th{background:#f6f8fa}
tr:nth-child(even){background:#fafafa}
td input{width:100%;box-sizing:border-box;padding:6px}

/* 2단 레이아웃 */
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
.card h2{margin:0 0 8px;font-size:18px;color:#2c3e50}

/* 채팅/OCR 영역 */
.chat-box{height:220px;overflow-y:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:90%;padding:8px 12px;border-radius:12px;line-height:1.4;word-break:break-word;white-space:pre-wrap}
.msg.me{align-self:flex-end;background:#1f6feb;color:#fff;border-bottom-right-radius:4px}
.msg.bot{align-self:flex-start;background:#e5e7eb;color:#333;border-bottom-left-radius:4px}
.msg img{max-width:240px;border-radius:8px;border:1px solid #e5e7eb}

/* 반응형 */
@media (max-width: 1100px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>이벤트 조회·관리 + OCR 일체형</h1>

    <div class="grid">
      <!-- 좌: 검색 + 관리(수정) -->
      <div class="card">
        <h2>① 고유번호 검색 & 관리</h2>
        <div class="meta">
          <span class="tag">한 화면에서 검색→수정→반영→메시지까지</span>
          <span class="tag" id="modeBadge">관리자 모드</span>
        </div>

        <!-- 검색줄 -->
        <div class="row" style="grid-template-columns: 1fr auto auto auto auto;">
          <input id="uidInput" placeholder="고유번호(unique_id)" />
          <button class="btn" onclick="searchByUID()">검색(공개)</button>
          <button class="btn secondary" onclick="loadForEdit()">불러오기(관리)</button>
          <button class="btn" onclick="addBlankRow()">행 추가</button>
          <button class="btn danger" onclick="deleteChecked()">선택 삭제</button>
        </div>

        <!-- 페이지/제한 -->
        <div class="meta">
          <span id="pageInfo" class="tag">page 1</span>
          <button class="btn secondary" onclick="prevPage()">◀</button>
          <button class="btn secondary" onclick="nextPage()">▶</button>
          <select id="limitSel" onchange="changeLimit()">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500" selected>500</option>
          </select>
          <span id="loader" style="display:none">검색 중… <b id="timer">0.0</b>s</span>
        </div>

        <!-- 요약(원본) -->
        <div id="summaryBox" class="table-wrap"></div>

        <!-- 관리 테이블 -->
        <div class="table-wrap" id="editTableWrap"></div>

        <!-- 반영 + 메시지 -->
        <div class="meta">
          <button class="btn" id="applyBtn" onclick="applyBulk()">DB 반영</button>
          <button class="btn secondary" onclick="generateAndCopy()">메시지 생성 & 복사</button>
          <span id="flash" class="tag" style="display:none"></span>
        </div>

        <!-- 최종 메시지 -->
        <textarea id="messageBox" rows="10" placeholder="최종안내 메시지" style="width:100%;margin-top:6px;"></textarea>
      </div>

      <!-- 우: OCR + 로그 -->
      <div class="card">
        <h2>② 인증서 OCR 붙여넣기</h2>
        <div class="meta"><span class="tag">캡처를 복사(Ctrl+C) → 이 페이지에 붙여넣기(Ctrl+V)</span></div>
        <div id="chatBox" class="chat-box"></div>
        <div class="meta">
          <input type="file" id="fileInput" accept="image/*" />
          <button class="btn" onclick="ocrFromFile()">파일 OCR</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/** =========================
 *  상수(보안 무시 버전)
 *  ========================= */
const baseUrl      = 'https://my-search-backend.onrender.com'; // ← 백엔드 주소
const apiSearch    = `${baseUrl}/search`;
const apiAdminList = `${baseUrl}/admin/records`;
const apiBulk      = `${baseUrl}/admin/records/bulk`;

const ADMIN_TOKEN  = 'PASTE_YOUR_ADMIN_TOKEN_HERE'; // ← 관리자 고유키(파일 안에 박아둠)
const OCRSPACE_KEY = 'K81476248188957';             // ← OCR.space 키(파일 안에 박아둠)

/** =========================
 *  상태/유틸
 *  ========================= */
let timerInterval;
let state = { page:1, limit:500, lastSearchRows:[], editRows:[], inserts:[], updates:{}, deletes:new Set() };

function qs(id){ return document.getElementById(id); }
function escapeHtml(x){ return String(x).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
function startTimer(){ let s=Date.now(); qs('timer').textContent='0.0'; qs('loader').style.display='inline-block'; timerInterval=setInterval(()=>{ qs('timer').textContent=((Date.now()-s)/1000).toFixed(1); },100); }
function stopTimer(){ clearInterval(timerInterval); qs('loader').style.display='none'; }
function flash(msg){ const el=qs('flash'); el.textContent=msg; el.style.display='inline-block'; setTimeout(()=>{el.style.display='none'},1800); }
function toUpper(s){ return (s||'').trim().toUpperCase(); }
function v(v){ return (v||'').trim(); }

/** 날짜범위/라벨/시간파서 (요약 계산용) */
function getDateRange(startStr, endStr) {
  const toDate = (s) => { const [Y, M, D] = s.split('.').map(Number); return new Date(Y, M - 1, D); };
  const fmt = (d) => { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}.${m}.${day}`; };
  const res = []; let cur = toDate(startStr); const end = toDate(endStr);
  while (cur <= end) { res.push(fmt(cur)); cur.setDate(cur.getDate() + 1); }
  return res;
}
function toMD(dateStr) { const parts = dateStr.split('.').map(Number); return `${parts[1]}/${parts[2]}`; }
function timeToMinutes(t) {
  if (!t) return null;
  const s = String(t).trim();
  const ampmMatch = s.match(/오전|오후|AM|PM/i);
  const ampm = ampmMatch ? ampmMatch[0].toLowerCase() : null;
  const cleaned = s.replace(/\s+/g,'');
  const m = cleaned.match(/(\d{1,2})[:시](\d{1,2})/);
  if (!m) return null;
  let h = parseInt(m[1], 10);
  let mm = parseInt(m[2], 10);
  if (Number.isNaN(h) || Number.isNaN(mm)) return null;
  if (ampm) {
    const isPM = /pm|오후/i.test(ampm);
    const isAM = /am|오전/i.test(ampm);
    if (isPM && h < 12) h += 12;
    if (isAM && h === 12) h = 0;
  }
  if (h < 0 || h > 23 || mm < 0 || mm > 59) return null;
  return h * 60 + mm;
}

/** =========================
 *  공개 검색(API /search)
 *  ========================= */
async function fetchRows(uid, page, limit) {
  const safeLimit = Math.max(1, Math.min(limit, 500));
  const u = new URL(apiSearch);
  u.searchParams.set('unique_id', uid);
  u.searchParams.set('page', page);
  u.searchParams.set('limit', safeLimit);
  const res = await fetch(u, { mode:'cors' });
  if (!res.ok) throw new Error('서버 오류');
  return await res.json();
}

async function searchByUID(page=null){
  const idRaw = qs('uidInput').value.trim();
  if(!idRaw){ alert('고유번호를 입력하세요.'); return; }
  const uid = toUpper(idRaw);

  state.page = page ?? state.page;
  qs('limitSel').value = String(state.limit);
  qs('pageInfo').textContent = `page ${state.page}`;

  try{
    startTimer();
    const [pageRows, allRows] = await Promise.all([
      fetchRows(uid, state.page, state.limit),
      fetchRows(uid, 1, 500)
    ]);
    stopTimer();
    state.lastSearchRows = pageRows;
    renderSummary(allRows.length ? allRows : pageRows);
    // 관리 테이블도 검색 결과 기반으로 보여주도록 초기화
    state.editRows = (allRows.length ? allRows : pageRows).map(r => ({...r, _id:null}));
    state.inserts = []; state.updates={}; state.deletes.clear?.();
    renderEditTable();
  }catch(e){
    stopTimer();
    qs('summaryBox').innerHTML = `<p class="error">오류: ${escapeHtml(e.message)}</p>`;
  }
}

function prevPage(){ if(state.page>1) searchByUID(state.page-1); }
function nextPage(){ searchByUID(state.page+1); }
function changeLimit(){ state.limit = Number(qs('limitSel').value || 500); state.page=1; searchByUID(1); }

/** =========================
 *  관리자 조회(/admin/records) & 반영(/admin/records/bulk)
 *  ========================= */
async function loadForEdit(){
  const uid = toUpper(qs('uidInput').value);
  if(!uid){ alert('고유번호를 입력하세요.'); return; }

  const u = new URL(apiAdminList);
  u.searchParams.set('unique_id', uid);

  const res = await fetch(u, {
    method: 'GET',
    headers: { 'X-Admin-Token': ADMIN_TOKEN },
    mode: 'cors'
  });
  if(!res.ok){ alert('관리 조회 실패(토큰/서버 확인)'); return; }
  const j = await res.json();
  const rows = (j.rows||[]).map(r => ({
    _id: r._id || null,
    unique_id: r.unique_id || uid,
    '날짜': r['날짜'] || '',
    '시간': r['시간'] || '',
    '인증샷 시리얼넘버': r['인증샷 시리얼넘버'] || r['인증샷시리얼넘버'] || ''
  }));
  state.editRows = rows;
  state.inserts = []; state.updates={}; state.deletes = new Set();
  renderEditTable();
  renderSummary(rows);
  flash('관리 데이터 불러옴');
}

async function applyBulk(){
  const payload = {
    insert: state.inserts.map(x => ({
      unique_id: toUpper(x.unique_id),
      '날짜': v(x['날짜']),
      '시간': v(x['시간']),
      '인증샷 시리얼넘버': v(x['인증샷 시리얼넘버'])
    })),
    update: Object.values(state.updates).map(x => ({
      _id: x._id,
      unique_id: toUpper(x.unique_id),
      '날짜': v(x['날짜']),
      '시간': v(x['시간']),
      '인증샷 시리얼넘버': v(x['인증샷 시리얼넘버'])
    })),
    delete: Array.from(state.deletes)
  };

  const res = await fetch(apiBulk, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Admin-Token': ADMIN_TOKEN
    },
    body: JSON.stringify(payload),
    mode: 'cors'
  });
  if(!res.ok){ alert('DB 반영 실패'); return; }
  const r = await res.json();
  flash(`반영 완료 (matched:${r.matched||0} / modified:${r.modified||0} / upserts:${r.upserts||0} / deleted:${r.deleted||0})`);

  // 반영 후 최신 데이터로 재조회 → 요약/메시지 업데이트
  await loadForEdit();
  generateMessage(); // 최신 rows 기준 메시지 자동 생성
}

/** =========================
 *  요약 렌더 & 메시지 생성
 *  ========================= */
function renderSummary(rows){
  // 1) 날짜 범위
  const df = '2025.09.19', dt = '2025.09.25', day25 = '2025.09.25';
  const days = getDateRange(df, dt);

  // 2) 집계
  const counts = Object.fromEntries(days.map(d => [d, 0]));
  let count25_first=0, countLive=0;
  rows.forEach(r=>{
    const d = String(r['날짜']||'').trim();
    const t = String(r['시간']||'').trim();
    if(!d || !counts.hasOwnProperty(d)) return;
    if(d===day25){
      const mins = timeToMinutes(t);
      if(mins!==null){
        if(mins<=9*60+59) count25_first += 1;
        else if(mins>=12*60) countLive += 1;
      }
    }else{
      counts[d]+=1;
    }
  });

  // 3) 표
  const headerLabels=[], headerKeys=[];
  days.forEach(d=>{
    if(d===day25){ headerLabels.push('9/25(1차)'); headerKeys.push(d+'_first'); headerLabels.push('생방'); headerKeys.push(d+'_live'); }
    else { headerLabels.push(toMD(d)); headerKeys.push(d); }
  });
  const summaryCells = headerKeys.map(k=>{
    if(k.endsWith('_first')) return count25_first;
    if(k.endsWith('_live'))  return countLive;
    return counts[k]||0;
  });

  let perfect = true;
  for(const d of days){ if(d===day25) continue; if((counts[d]||0)<1){ perfect=false; break; } }
  if(count25_first<1) perfect=false;

  let html = '<table><thead><tr><th style="min-width:140px">참여 요약(최신)</th>';
  headerLabels.forEach(lbl=> html+=`<th>${lbl}</th>`);
  html += '</tr></thead><tbody>';
  html += `<tr><td>건수</td>${summaryCells.map(c=>`<td class="center">${c}</td>`).join('')}</tr>`;
  html += `<tr><td>개근</td><td class="center strong" colspan="${headerLabels.length}">${perfect?'o':'x'}</td></tr>`;
  html += '</tbody></table>';

  qs('summaryBox').innerHTML = html;

  // 메시지용 상태 저장
  state.summaryForMsg = {
    a: counts['2025.09.19']||0, b: counts['2025.09.20']||0, c: counts['2025.09.21']||0,
    d: counts['2025.09.22']||0, e: counts['2025.09.23']||0, f: counts['2025.09.24']||0,
    g: count25_first, n: countLive, perfect
  };
}

function generateMessage(){
  const uid = toUpper(qs('uidInput').value) || '고유번호';
  const s = state.summaryForMsg || {a:0,b:0,c:0,d:0,e:0,f:0,g:0,n:0,perfect:false};
  const k = s.a+s.b+s.c+s.d+s.e+s.f+s.g;
  const weight = s.perfect ? (s.n*8) : s.n;

  const msg =
`📢 ${uid} 님, 최종 집계 안내입니다.

✔전체 투표 참여내역
(09.19 - 09.25)
19일 - ${s.a}건 
20일 - ${s.b}건 
21일 - ${s.c}건 
22일 - ${s.d}건 
23일 - ${s.e}건 
24일 - ${s.f}건 
25일 사전투표 - ${s.g}건 
25일 생방투표 - ${s.n}건

🍀 사전 투표기간 총 누적투표수 : ${k}건 
(생방 투표는 누적투표수에 포함되지 않습니다.)

${uid} 님은 ${s.perfect ? '개근에 해당됩니다.' : '개근에 해당되지 않습니다.'}
개근은 19일 투표부터 25일 오전 투표까지 모두 해주신 분들만 해당됩니다.

25일 생방 투표 참여내역은 ${s.n}건입니다.
개근 여부에 따른 생방 이벤트 총 가중치는 ${s.perfect ? `${s.n}→ 8×${s.n} = ${weight}` : `${weight}`} 입니다.

씬롱이에게 투표해주셔서 감사드립니다😺
원활한 검수를 위해 답장은 보내지 말아주세요🙏

누락 및 정정 문의는 이곳이 아닌 문의 채널 "허씬롱 갤러리 Q&A"로 부탁드립니다.
반드시 문의 전 문의 채널 하단의 양식을 참고해서 문의해주세요🙏
문의 채널 링크 📍 
http://pf.kakao.com/_cFxexcn `;
  qs('messageBox').value = msg;
}

function copyMessage(){
  const ta = qs('messageBox');
  ta.select(); ta.setSelectionRange(0, 99999);
  document.execCommand('copy');
  flash('메시지를 클립보드에 복사했습니다.');
}
function generateAndCopy(){ generateMessage(); setTimeout(copyMessage, 80); }

/** =========================
 *  관리 테이블 렌더/조작
 *  ========================= */
function renderEditTable(){
  const rows = state.editRows;
  let html = '<table><thead><tr>' +
    '<th><input type="checkbox" id="chkAll" onchange="toggleAll(this)"/></th>' +
    '<th>고유번호</th><th>날짜</th><th>시간</th><th>인증샷 시리얼넘버</th><th>_id</th>' +
    '</tr></thead><tbody>';

  rows.forEach((r, idx)=>{
    html += `<tr>
      <td><input type="checkbox" class="rowchk" data-idx="${idx}" ${state.deletes.has(r._id)?'checked':''}></td>
      <td><input value="${escapeHtml(r.unique_id||'')}" oninput="onCellEdit(${idx}, 'unique_id', this.value)" /></td>
      <td><input value="${escapeHtml(r['날짜']||'')}" oninput="onCellEdit(${idx}, '날짜', this.value)" /></td>
      <td><input value="${escapeHtml(r['시간']||'')}" oninput="onCellEdit(${idx}, '시간', this.value)" /></td>
      <td><input value="${escapeHtml(r['인증샷 시리얼넘버']||'')}" oninput="onCellEdit(${idx}, '인증샷 시리얼넘버', this.value)" /></td>
      <td>${r._id ? escapeHtml(r._id) : ''}</td>
    </tr>`;
  });
  html += '</tbody></table>';

  qs('editTableWrap').innerHTML = html;
  const applyBtn = qs('applyBtn'); if(applyBtn) applyBtn.disabled = false;
}

function toggleAll(box){
  const chks = document.querySelectorAll('.rowchk');
  chks.forEach(c => { c.checked = box.checked; const idx = Number(c.dataset.idx); const r=state.editRows[idx]; if(r._id){ if(c.checked) state.deletes.add(r._id); else state.deletes.delete(r._id);} });
}

function onCellEdit(idx, key, value){
  const row = state.editRows[idx];
  row[key] = value;
  if(row._id){ // 기존행 → 업데이트 큐
    state.updates[row._id] = {
      _id: row._id,
      unique_id: toUpper(row.unique_id),
      '날짜': v(row['날짜']),
      '시간': v(row['시간']),
      '인증샷 시리얼넘버': v(row['인증샷 시리얼넘버'])
    };
  }else{
    // 신규행은 inserts 배열 내부 원본을 갱신
    const found = state.inserts.find(x=>x._tmpId===row._tmpId);
    if(found){ found[key]=value; } // 동일 참조 보장 안돼서 동기화
  }
}

function addBlankRow(){
  const uid = toUpper(qs('uidInput').value);
  if(!uid){ alert('고유번호를 먼저 입력하세요.'); return; }
  const tmpId = 'tmp_'+Math.random().toString(36).slice(2,8);
  const row = {_tmpId: tmpId, _id:null, unique_id: uid, '날짜':'', '시간':'', '인증샷 시리얼넘버':''};
  state.editRows.push(row);
  state.inserts.push({...row});
  renderEditTable();
}

function deleteChecked(){
  const chks = document.querySelectorAll('.rowchk:checked');
  if(chks.length===0){ alert('선택된 행이 없습니다.'); return; }
  // 표시상 제거 + 큐 반영
  const toDeleteIdx = new Set(Array.from(chks).map(c=>Number(c.dataset.idx)));
  const remain = [];
  state.editRows.forEach((r,i)=>{
    if(toDeleteIdx.has(i)){
      if(r._id) state.deletes.add(r._id);
      // 신규행인 경우 inserts에서 제거
      if(r._tmpId) state.inserts = state.inserts.filter(x=>x._tmpId!==r._tmpId);
      delete state.updates[r._id];
    }else{
      remain.push(r);
    }
  });
  state.editRows = remain;
  renderEditTable();
}

/** =========================
 *  OCR: 붙여넣기/파일 → OCR.space → 파싱 → 표 자동 추가
 *  ========================= */
function chatAdd(text, who='bot'){
  const box = qs('chatBox');
  const d = document.createElement('div');
  d.className = 'msg ' + (who==='me' ? 'me' : 'bot');
  d.textContent = text;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}
function chatAddImage(url){
  const box = qs('chatBox');
  const d = document.createElement('div'); d.className='msg me';
  const img = new Image(); img.src=url; d.appendChild(img);
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}

async function toPngBlob(file){
  if(file.type==='image/png') return file;
  const bmp = await createImageBitmap(file);
  const canvas = document.createElement('canvas'); canvas.width=bmp.width; canvas.height=bmp.height;
  const ctx = canvas.getContext('2d'); ctx.drawImage(bmp,0,0);
  return await new Promise(res => canvas.toBlob(b => res(b),'image/png',0.95));
}

async function ocrWithOCRSpace(origFile){
  const pngBlob = await toPngBlob(origFile);
  const form = new FormData();
  form.append('apikey', OCRSPACE_KEY);
  form.append('language', 'eng');
  form.append('scale', 'true');
  form.append('detectOrientation', 'true');
  form.append('OCREngine','2');
  form.append('file', pngBlob, 'paste.png');

  const res = await fetch('https://api.ocr.space/parse/image', { method:'POST', body: form });
  if(!res.ok) throw new Error('네트워크 오류(' + res.status + ')');
  const data = await res.json();
  if(data.IsErroredOnProcessing){
    const em = Array.isArray(data.ErrorMessage) ? data.ErrorMessage.join(', ') : (data.ErrorMessage || '처리 에러');
    throw new Error(em);
  }
  const text = (data?.ParsedResults?.[0]?.ParsedText || '').trim();
  if(!text) throw new Error('빈 결과');
  return text;
}

function parseOCRText(raw){
  const text = raw.replace(/^RAW:\s*/,'');
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let date = '', time = '', serial='';

  for(const l of lines){
    const m = l.match(/(\d{4}\.\d{2}\.\d{2})\s+(\d{1,2}:\d{2})/);
    if(m){ date=m[1]; time=m[2]; }
    const srl = l.match(/No\.\s*([A-Za-z0-9\-\_]+)/i);
    if(srl){ serial=srl[1]; }
  }
  return { date, time, serial };
}

function autoAddOCRRow({ date, time, serial }){
  const uid = toUpper(qs('uidInput').value);
  if(!uid){ chatAdd('⚠️ 고유번호를 먼저 입력하세요.', 'bot'); return; }
  if(!date || !time || !serial){ chatAdd('⚠️ OCR에서 필드 추출 실패(날짜/시간/시리얼).', 'bot'); return; }

  const tmpId = 'ocr_'+Math.random().toString(36).slice(2,8);
  const row = {_tmpId:tmpId,_id:null,unique_id:uid,'날짜':date,'시간':time,'인증샷 시리얼넘버':serial};
  state.editRows.push(row);
  state.inserts.push({...row});
  renderEditTable();
  chatAdd(`✅ OCR 추가: ${date} ${time} / ${serial}`, 'bot');
}

const chatBox = qs('chatBox');
const observer = new MutationObserver(()=>{ /* hook reserved */ });
observer.observe(chatBox,{childList:true});

window.addEventListener('paste', async (e)=>{
  const item = [...(e.clipboardData?.items || [])].find(i => i.kind==='file' && i.type.startsWith('image/'));
  if(!item) return;
  const file = item.getAsFile();
  const url = URL.createObjectURL(file);
  chatAddImage(url);
  chatAdd('이미지 접수됨. OCR 처리 중…', 'bot');
  try{
    const text = await ocrWithOCRSpace(file);
    const shown = text.length>500 ? text.slice(0,500)+' …' : text;
    chatAdd('RAW: ' + shown, 'bot');
    const p = parseOCRText(text);
    autoAddOCRRow(p);
  }catch(err){
    chatAdd('OCR 에러: ' + (err?.message || String(err)), 'bot');
  }finally{
    setTimeout(()=>URL.revokeObjectURL(url),3000);
  }
});

async function ocrFromFile(){
  const inp = qs('fileInput');
  const file = inp.files?.[0];
  if(!file){ alert('이미지 파일을 선택하세요.'); return; }
  const url = URL.createObjectURL(file);
  chatAddImage(url);
  chatAdd('파일 OCR 처리 중…', 'bot');
  try{
    const text = await ocrWithOCRSpace(file);
    chatAdd('RAW: ' + (text.length>500?text.slice(0,500)+' …':text), 'bot');
    autoAddOCRRow(parseOCRText(text));
  }catch(e){
    chatAdd('OCR 에러: ' + (e?.message||String(e)), 'bot');
  }finally{
    setTimeout(()=>URL.revokeObjectURL(url),3000);
  }
}

/** 초기 모드 뱃지/엔터 키 */
document.addEventListener('DOMContentLoaded', ()=>{
  qs('modeBadge').textContent = '관리자 모드(보안 무시)';
  qs('uidInput').addEventListener('keydown', e=>{ if(e.key==='Enter') searchByUID(1); });
});
  </script>
</body>
</html>
