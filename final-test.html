<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì´ë²¤íŠ¸ ë°ì´í„° ì¡°íšŒ</title>
  <style>
/* ë°”ë””/ì»¨í…Œì´ë„ˆ */
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;margin:0;padding:16px;background:#f4f7f9;color:#333}
.container{max-width:1100px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06)}

/* ì œëª©/íƒ­ */
h1{margin:0 0 12px;color:#2c3e50;font-size:22px}
.tabs{display:flex;flex-wrap:wrap;border-bottom:1px solid #e5e7eb;margin-bottom:12px;gap:6px}
.tab{padding:10px 14px;cursor:pointer;border-radius:8px 8px 0 0;font-size:14px}
.tab.active{background:#eaf3ff;color:#1f6feb;border:1px solid #cfe3ff;border-bottom-color:#eaf3ff}
.tabpanel{display:none}
.tabpanel.active{display:block}

/* ì…ë ¥í–‰ */
.row{display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:12px}
input,select{padding:10px;font-size:14px;border:1px solid #d1d5db;border-radius:8px;width:100%}
.btn{padding:10px 14px;background:#3498db;color:#fff;border:0;border-radius:8px;cursor:pointer}
.btn:hover{background:#2980b9}
.meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px;color:#666;font-size:13px;gap:8px}
.tag{background:#eef6ff;color:#1f6feb;border:1px solid #d0e7ff;border-radius:999px;padding:4px 10px;font-size:12px}
.error{color:#d91e18}
.center{text-align:center}
.strong{font-weight:600}

/* í…Œì´ë¸” + ë˜í¼(ê°€ë¡œ ìŠ¤í¬ë¡¤) */
.table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;min-width:640px}
th,td{border:1px solid #eee;padding:10px;text-align:left;white-space:nowrap}
th{background:#f6f8fa}
tr:nth-child(even){background:#fafafa}

/* ë°˜ì‘í˜• */
@media (max-width: 900px){
  .row{grid-template-columns:1fr;grid-auto-rows:auto}
}
@media (max-width: 600px){
  body{padding:10px}
  .container{margin:10px auto;padding:14px}
  h1{font-size:18px}
  .tab{font-size:13px}
  table{min-width:520px}
  input,select,.btn{font-size:15px;padding:12px}
}

/* === ì¢Œìš° 5:5 ë ˆì´ì•„ì›ƒ(ê¸°ì¡´ ê¸°ëŠ¥ì€ ê·¸ëŒ€ë¡œ) === */
.page-split { display:flex; gap:24px; align-items:flex-start; }
.page-left, .page-right { flex:1 1 0; }

/* ê¸°ì¡´ .containerê°€ column ë„ˆë¹„ë¥¼ ê½‰ ì±„ìš°ë„ë¡(ê°€ë¡œ ì¤‘ì•™ max-width í•´ì œ) */
.page-left .container { max-width:unset; margin:0; }

/* === ì˜¤ë¥¸ìª½ ì±„íŒ… ì¹´ë“œ === */
.chat-card {
  background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.06);
  padding:14px; width:100%;
  height: 70vh;
  display:flex; flex-direction:column;
}
.chat-title { font-weight:700; font-size:16px; margin-bottom:8px; color:#2c3e50; }
.chat-box {
  flex:1; overflow-y:auto; background:#f9fafb; border:1px solid #e5e7eb;
  border-radius:8px; padding:12px; display:flex; flex-direction:column; gap:8px;
}
.chat-row { display:flex; gap:8px; margin-top:10px; }
#chatInput {
  flex:1; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px;
  background:#fff;
}
#chatSend {
  background:#2563eb; color:#fff; border:none; border-radius:8px; padding:10px 16px; cursor:pointer;
}
#chatSend:hover { background:#1d4ed8; }

/* ë§í’ì„  */
.msg { max-width:80%; padding:8px 12px; border-radius:12px; line-height:1.4; word-break:break-word; white-space:pre-wrap; }
.msg.me { align-self:flex-end; background:#1f6feb; color:#fff; border-bottom-right-radius:4px; }
.msg.bot{ align-self:flex-start; background:#e5e7eb; color:#333; border-bottom-left-radius:4px; }

/* ë°˜ì‘í˜•(í•„ìš” ì‹œ) */
@media (max-width: 1100px){
  .page-split { flex-direction:column; }
  .chat-card { height: 56vh; }
}
  </style>
</head>
<body>
  <div class="page-split">
    <div class="page-left">
      <div class="container">
        <h1>ì´ë²¤íŠ¸ ë°ì´í„° ì¡°íšŒ</h1>

        <div class="tabs">
          <div class="tab active" data-tab="uid">ê³ ìœ ë²ˆí˜¸ ê²€ìƒ‰</div>
          <div class="tab" data-tab="serial">ì‹œë¦¬ì–¼ ê²€ìƒ‰</div>
          <!-- ì¶”ê°€: ê´€ë¦¬(ìˆ˜ì •) -->
          <div class="tab" data-tab="edit">ê´€ë¦¬(ìˆ˜ì •)</div>
        </div>

        <!-- ê³ ìœ ë²ˆí˜¸ ê²€ìƒ‰ íƒ­ -->
        <div id="panel-uid" class="tabpanel active">
          <div class="row">
            <input id="uidInput" placeholder="ê³ ìœ ë²ˆí˜¸(unique_id)" />
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn" onclick="searchByUID()">ê²€ìƒ‰</button>
              <span class="tag" id="pageInfo">page 1</span>
              <button class="btn" onclick="prevPage()">â—€</button>
              <button class="btn" onclick="nextPage()">â–¶</button>
              <select id="limitSel" onchange="changeLimit()">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500" selected>500</option>
              </select>
            </div>
          </div>
          <div class="meta">
            <div id="loader" style="display:none">ê²€ìƒ‰ ì¤‘â€¦ <span id="timer">0.0</span>ì´ˆ</div>
          </div>
          <div id="uidResults"></div>
        </div>

        <!-- ì‹œë¦¬ì–¼ ê²€ìƒ‰ íƒ­ -->
        <div id="panel-serial" class="tabpanel">
          <div class="row" style="grid-template-columns:1fr 1fr 1fr auto;">
            <input id="serialInput" placeholder="ì‹œë¦¬ì–¼ë²ˆí˜¸ ì •í™•íˆ ì…ë ¥" />
            <input id="serialDateFrom" placeholder="ì‹œì‘ì¼ì YYYY.MM.DD (ì„ íƒ)" />
            <input id="serialDateTo" placeholder="ì¢…ë£Œì¼ì YYYY.MM.DD (ì„ íƒ)" />
            <button class="btn" onclick="searchBySerial()">ê²€ìƒ‰</button>
          </div>
          <div id="serialInfo" class="tag" style="display:none;"></div>
          <div id="serialResults"></div>
        </div>

        <!-- ê´€ë¦¬(ìˆ˜ì •) íƒ­ -->
        <div id="panel-edit" class="tabpanel">
          <div class="row" style="grid-template-columns:1fr auto auto 1fr auto;">
            <input id="editUid" placeholder="ê³ ìœ ë²ˆí˜¸ (ì˜ˆ: AA0001)" />
            <input id="editFrom" placeholder="ì‹œì‘ì¼ì YYYY.MM.DD (ì„ íƒ)" />
            <input id="editTo" placeholder="ì¢…ë£Œì¼ì YYYY.MM.DD (ì„ íƒ)" />
            <input id="editToken" placeholder="ê´€ë¦¬ì í† í°" />
            <button class="btn" onclick="loadEditable()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>

          <div class="meta">
            <span class="tag" id="editMeta" style="display:none;"></span>
            <div style="display:flex; gap:8px;">
              <button class="btn" onclick="addRow()">í–‰ ì¶”ê°€</button>
              <button class="btn" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
              <button class="btn" onclick="saveEdits()">ë°˜ì˜</button>
            </div>
          </div>

          <div class="table-wrap" id="editTableWrap" style="margin-top:10px;"></div>
          <div id="editMsg" class="meta" style="color:#666;"></div>
        </div>
      </div>
    </div>

    <div class="page-right">
      <div class="chat-card">
        <div class="chat-title">ì±„íŒ…</div>
        <div id="chatBox" class="chat-box"></div>
        <div class="chat-row">
          <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”â€¦" />
          <button id="chatSend">ì…ë ¥</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/* ===== ì„¤ì • ===== */
const baseUrl   = 'https://my-search-backend.onrender.com'; // â† ë°±ì—”ë“œ ì£¼ì†Œ
const apiSearch = `${baseUrl}/search`;         // unique_id ê²€ìƒ‰ (ë°°ì—´ ë°˜í™˜)
const apiSerial = `${baseUrl}/search-serial`;  // ì‹œë¦¬ì–¼ ê²€ìƒ‰
const apiList   = `${baseUrl}/admin/records`;  // í¸ì§‘ìš© ëª©ë¡
const apiBulk   = `${baseUrl}/admin/records/bulk`; // ë²Œí¬ ì €ì¥

/* ===== ìƒíƒœ/ìœ í‹¸ ===== */
let timerInterval;
let state = { page:1, limit:500, lastData:null };

function wrapTable(html){ return `<div class="table-wrap">${html}</div>`; }
function qs(id){ return document.getElementById(id); }
function escapeHtml(x){ return String(x).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
function startTimer(){ let s=Date.now(); qs('timer').textContent='0.0'; qs('loader').style.display='block'; timerInterval=setInterval(()=>{ qs('timer').textContent=((Date.now()-s)/1000).toFixed(1); },100);} 
function stopTimer(){ clearInterval(timerInterval); qs('loader').style.display='none'; }

// ë‚ ì§œ ë°°ì—´
function getDateRange(startStr, endStr) {
  const toDate = (s) => { const [Y, M, D] = s.split('.').map(Number); return new Date(Y, M - 1, D); };
  const fmt = (d) => { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}.${m}.${day}`; };
  const res = []; let cur = toDate(startStr); const end = toDate(endStr);
  while (cur <= end) { res.push(fmt(cur)); cur.setDate(cur.getDate() + 1); }
  return res;
}
// "YYYY.MM.DD" â†’ "M/D"
function toMD(dateStr) { const parts = dateStr.split('.').map(Number); return `${parts[1]}/${parts[2]}`; }

// ê°•í™”ëœ ì‹œê°„ íŒŒì„œ
function timeToMinutes(t) {
  if (!t) return null;
  const s = String(t).trim();
  const ampmMatch = s.match(/ì˜¤ì „|ì˜¤í›„|AM|PM/i);
  const ampm = ampmMatch ? s.toLowerCase() : null;
  const cleaned = s.replace(/\s+/g,'');
  const m = cleaned.match(/(\d{1,2})[:ì‹œ](\d{1,2})/);
  if (!m) return null;
  let h = parseInt(m[1], 10);
  let mm = parseInt(m[2], 10);
  if (Number.isNaN(h) || Number.isNaN(mm)) return null;
  if (ampm) {
    const isPM = /pm|ì˜¤í›„/i.test(ampm);
    const isAM = /am|ì˜¤ì „/i.test(ampm);
    if (isPM && h < 12) h += 12;
    if (isAM && h === 12) h = 0;
  }
  if (h < 0 || h > 23 || mm < 0 || mm > 59) return null;
  return h * 60 + mm;
}

/* ===== íƒ­ ì „í™˜ ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tabpanel').forEach(x=>x.classList.remove('active'));
    t.classList.add('active'); qs('panel-'+t.dataset.tab).classList.add('active');
  });
});

/* ===== ê³µí†µ í˜ì¹˜ ===== */
async function fetchRows(uid, page, limit) {
  const safeLimit = Math.max(1, Math.min(limit, 500)); // 1~500
  const u = new URL(apiSearch);
  u.searchParams.set('unique_id', uid);
  u.searchParams.set('page', page);
  u.searchParams.set('limit', safeLimit);
  const res = await fetch(u, { mode:'cors' });
  if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
  return await res.json();
}

/* ===== ê³ ìœ ë²ˆí˜¸ ê²€ìƒ‰ ===== */
async function searchByUID(page=null){
  const idRaw = qs('uidInput').value.trim();
  if(!idRaw){ alert('ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const uid = idRaw.toUpperCase();

  state.page = page ?? state.page;
  qs('limitSel').value = String(state.limit);
  qs('pageInfo').textContent = `page ${state.page}`;

  try{
    startTimer();
    const [pageRows, allRows] = await Promise.all([
      fetchRows(uid, state.page, state.limit),
      fetchRows(uid, 1, 500)
    ]);
    stopTimer();
    state.lastData = pageRows;
    renderUIDTable(pageRows, allRows);
  }catch(e){
    stopTimer();
    qs('uidResults').innerHTML = `<p class="error">ì˜¤ë¥˜: ${escapeHtml(e.message)}</p>`;
  }
}

function prevPage(){ if(state.page>1) searchByUID(state.page-1); }
function nextPage(){ searchByUID(state.page+1); }
function changeLimit(){ state.limit = Number(qs('limitSel').value || 500); state.page=1; searchByUID(1); }
qs('uidInput').addEventListener('keydown',e=>{ if(e.key==='Enter') searchByUID(1); });

/* ===== ìš”ì•½+ìƒì„¸ ë Œë” ===== */
function renderUIDTable(pageRows, allRows){
  const wrap = qs('uidResults');
  const rowsForSummary = (allRows && allRows.length) ? allRows : pageRows;
  if ((!pageRows || pageRows.length===0) && (!rowsForSummary || rowsForSummary.length===0)) {
    wrap.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; 
    return;
  }

  const df = '2025.09.19';
  const dt = '2025.09.25';
  const days = getDateRange(df, dt);
  const day25 = '2025.09.25';

  const counts = Object.fromEntries(days.map(d => [d, 0]));
  let count25_first = 0;
  let countLive     = 0;

  rowsForSummary.forEach(r => {
    const d = String(r['ë‚ ì§œ'] ?? '').trim();
    const t = String(r['ì‹œê°„'] ?? '').trim();
    if (!d || !counts.hasOwnProperty(d)) return;
    if (d === day25) {
      const mins = timeToMinutes(t);
      if (mins !== null) {
        if (mins <= 9*60 + 59)      count25_first += 1;
        else if (mins >= 12*60)     countLive     += 1;
      }
    } else {
      counts[d] += 1;
    }
  });

  const headerLabels = [], headerKeys = [];
  days.forEach(d => {
    if (d === day25) {
      headerLabels.push('9/25(1ì°¨)'); headerKeys.push(d + '_first');
      headerLabels.push('ìƒë°©');       headerKeys.push(d + '_live');
    } else {
      headerLabels.push(toMD(d));      headerKeys.push(d);
    }
  });
  const summaryCells = headerKeys.map(key => {
    if (key.endsWith('_first')) return count25_first;
    if (key.endsWith('_live'))  return countLive;
    return counts[key] ?? 0;
  });

  let perfectOriginal = true;
  for (const d of days) {
    if (d === day25) continue;
    if ((counts[d] || 0) < 1) { perfectOriginal = false; break; }
  }
  if (count25_first < 1) perfectOriginal = false;

  let summary = '<table><thead><tr><th style="min-width:110px">ì°¸ì—¬ ìš”ì•½(ì›ë³¸)</th>';
  headerLabels.forEach(lbl => { summary += `<th>${lbl}</th>`; });
  summary += '</tr></thead><tbody>';
  summary += `<tr><td>ê±´ìˆ˜</td>${summaryCells.map(c => `<td class="center">${c}</td>`).join('')}</tr>`;
  summary += `<tr><td>ê°œê·¼(ì›ë³¸)</td><td colspan="${headerLabels.length}" class="center strong">${perfectOriginal ? 'o' : 'x'}</td></tr>`;
  summary += '</tbody></table>';

  // ë©”ì‹œì§€ íŒ¨ë„(ê¸°ì¡´ ë™ì‘ ìœ ì§€)
  const editableHTML = renderEditPanel({
    days, day25,
    baseCounts: counts,
    base25First: count25_first,
    baseLive: countLive
  });

  let detail = '<table style="margin-top:12px"><thead><tr>' +
    '<th>ê³ ìœ ë²ˆí˜¸</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„</th>' +
    '</tr></thead><tbody>';
  pageRows.forEach(r => {
    const serial = r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'] ?? r['ì¸ì¦ìƒ·ì‹œë¦¬ì–¼ë„˜ë²„'] ?? '';
    detail += `<tr>
      <td>${escapeHtml(r.unique_id ?? '')}</td>
      <td>${escapeHtml(String(r['ë‚ ì§œ'] ?? '').trim())}</td>
      <td>${escapeHtml(String(r['ì‹œê°„'] ?? '').trim())}</td>
      <td>${escapeHtml(serial)}</td>
    </tr>`;
  });
  detail += '</tbody></table>';

  wrap.innerHTML = wrapTable(summary) + wrapTable(editableHTML) + wrapTable(detail);
}

/* ===== ë©”ì‹œì§€ íŒ¨ë„(ê¸°ì¡´) ===== */
function renderEditPanel({ days, day25, baseCounts, base25First, baseLive }) {
  const v = {
    '2025.09.19': baseCounts['2025.09.19'] || 0,
    '2025.09.20': baseCounts['2025.09.20'] || 0,
    '2025.09.21': baseCounts['2025.09.21'] || 0,
    '2025.09.22': baseCounts['2025.09.22'] || 0,
    '2025.09.23': baseCounts['2025.09.23'] || 0,
    '2025.09.24': baseCounts['2025.09.24'] || 0,
    '25_first': base25First || 0,
    'live': baseLive || 0
  };

  const k = v['2025.09.19'] + v['2025.09.20'] + v['2025.09.21'] +
            v['2025.09.22'] + v['2025.09.23'] + v['2025.09.24'] + v['25_first'];
  const n = v['live'];
  const perfect = [v['2025.09.19'], v['2025.09.20'], v['2025.09.21'],
                   v['2025.09.22'], v['2025.09.23'], v['2025.09.24']]
                   .every(x => x >= 1) && v['25_first'] >= 1;
  const weight = perfect ? (n * 8) : n;

  state.lastSummary = v;

  let html = `
  <div style="margin-top:16px">
    <h3 style="margin:6px 0 4px; color:#2c3e50;">ë©”ì‹œì§€ ìƒì„±</h3>
    <div class="meta" style="margin-top:8px">
      <div id="editedInfo" class="tag">
        ì‚¬ì „ í•©ê³„: ${k}ê±´ Â· ìƒë°©: ${n}ê±´ Â· ê°œê·¼: ${perfect ? 'o' : 'x'} Â· ê°€ì¤‘ì¹˜: ${weight}
      </div>
      <div>
        <button class="btn" onclick="generateAndCopy()">ë©”ì‹œì§€ ìƒì„± & ë³µì‚¬</button>
      </div>
    </div>
    <textarea id="messageBox" rows="10" style="width:100%; margin-top:8px; font-family:inherit;"></textarea>
  </div>`;
  return html;
}

function getEditedCounts() {
  return state.lastSummary || {
    '2025.09.19': 0,'2025.09.20': 0,'2025.09.21': 0,
    '2025.09.22': 0,'2025.09.23': 0,'2025.09.24': 0,
    '25_first': 0,'live': 0
  };
}
function updateEditedSummary() {
  const v = getEditedCounts();
  const k = v['2025.09.19']+v['2025.09.20']+v['2025.09.21']+v['2025.09.22']+v['2025.09.23']+v['2025.09.24']+v['25_first'];
  const n = v['live'];
  const perfect = [v['2025.09.19'],v['2025.09.20'],v['2025.09.21'],v['2025.09.22'],v['2025.09.23'],v['2025.09.24']].every(x=>x>=1) && v['25_first']>=1;
  const weight = perfect ? (n*8) : n;
  qs('editedInfo').textContent = `ì‚¬ì „ í•©ê³„: ${k}ê±´ Â· ìƒë°©: ${n}ê±´ Â· ê°œê·¼: ${perfect ? 'o' : 'x'} Â· ê°€ì¤‘ì¹˜: ${weight}`;
}
function generateMessage() {
  const uid = (qs('uidInput').value || '').trim().toUpperCase();
  const v = getEditedCounts();
  const a=v['2025.09.19'], b=v['2025.09.20'], c=v['2025.09.21'],
        d=v['2025.09.22'], e=v['2025.09.23'], f=v['2025.09.24'],
        g=v['25_first'],   n=v['live'];
  const k = a+b+c+d+e+f+g;
  const perfect = [a,b,c,d,e,f].every(x=>x>=1) && g>=1;
  const weight = perfect ? (n*8) : n;

  const msg =
`ğŸ“¢ ê³ ìœ ë²ˆí˜¸ ë‹˜, ìµœì¢… ì§‘ê³„ ì•ˆë‚´ì…ë‹ˆë‹¤.

âœ”ì „ì²´ íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­
(09.19 - 09.25)
19ì¼ - ${a}ê±´ 
20ì¼ - ${b}ê±´ 
21ì¼ - ${c}ê±´ 
22ì¼ - ${d}ê±´ 
23ì¼ - ${e}ê±´ 
24ì¼ - ${f}ê±´ 
25ì¼ ì‚¬ì „íˆ¬í‘œ - ${g}ê±´ 
25ì¼ ìƒë°©íˆ¬í‘œ - ${n}ê±´

ğŸ€ ì‚¬ì „ íˆ¬í‘œê¸°ê°„ ì´ ëˆ„ì íˆ¬í‘œìˆ˜ : ${k}ê±´ 
(ìƒë°© íˆ¬í‘œëŠ” ëˆ„ì íˆ¬í‘œìˆ˜ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

ê³ ìœ ë²ˆí˜¸ ë‹˜ì€ ${perfect ? 'ê°œê·¼ì— í•´ë‹¹ë©ë‹ˆë‹¤.' : 'ê°œê·¼ì— í•´ë‹¹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}
ê°œê·¼ì€ 19ì¼ íˆ¬í‘œë¶€í„° 25ì¼ ì˜¤ì „ íˆ¬í‘œê¹Œì§€ ëª¨ë‘ í•´ì£¼ì‹  ë¶„ë“¤ë§Œ í•´ë‹¹ë©ë‹ˆë‹¤.

25ì¼ ìƒë°© íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­ì€ ${n}ê±´ì…ë‹ˆë‹¤.
ê°œê·¼ ì—¬ë¶€ì— ë”°ë¥¸ ìƒë°© ì´ë²¤íŠ¸ ì´ ê°€ì¤‘ì¹˜ëŠ” ${perfect ? `${n}â†’ 8Ã—${n} = ${weight}` : `${weight}`} ì…ë‹ˆë‹¤.

ì”¬ë¡±ì´ì—ê²Œ íˆ¬í‘œí•´ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤ğŸ˜º
ì›í™œí•œ ê²€ìˆ˜ë¥¼ ìœ„í•´ ë‹µì¥ì€ ë³´ë‚´ì§€ ë§ì•„ì£¼ì„¸ìš”ğŸ™

ëˆ„ë½ ë° ì •ì • ë¬¸ì˜ëŠ” ì´ê³³ì´ ì•„ë‹Œ ë¬¸ì˜ ì±„ë„ "í—ˆì”¬ë¡± ê°¤ëŸ¬ë¦¬ Q&A"ë¡œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ë°˜ë“œì‹œ ë¬¸ì˜ ì „ ë¬¸ì˜ ì±„ë„ í•˜ë‹¨ì˜ ì–‘ì‹ì„ ì°¸ê³ í•´ì„œ ë¬¸ì˜í•´ì£¼ì„¸ìš”ğŸ™
ë¬¸ì˜ ì±„ë„ ë§í¬ ğŸ“ 
http://pf.kakao.com/_cFxexcn `;
  qs('messageBox').value = msg.replaceAll('ê³ ìœ ë²ˆí˜¸', uid || 'ê³ ìœ ë²ˆí˜¸');
}
function copyMessage(){
  const ta = qs('messageBox');
  ta.select(); ta.setSelectionRange(0, 99999);
  document.execCommand('copy');
  const prev = qs('editedInfo').textContent;
  qs('editedInfo').textContent = 'ë©”ì‹œì§€ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.';
  setTimeout(()=> qs('editedInfo').textContent = prev, 1500);
}
function generateAndCopy() {
  generateMessage();
  setTimeout(copyMessage, 100);
}

/* ===== ì‹œë¦¬ì–¼ ê²€ìƒ‰ ===== */
async function searchBySerial(){
  const serial = qs('serialInput').value.trim();
  const df = qs('serialDateFrom').value.trim();
  const dt = qs('serialDateTo').value.trim();
  if(!serial){ alert('ì‹œë¦¬ì–¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const u = new URL(apiSerial);
  u.searchParams.set('serial', serial);
  if(df) u.searchParams.set('date_from', df);
  if(dt) u.searchParams.set('date_to', dt);
  qs('serialInfo').style.display='none';
  qs('serialResults').innerHTML = 'ì¡°íšŒ ì¤‘â€¦';
  try{
    const res = await fetch(u, {mode:'cors'});
    if(!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
    const arr = await res.json();
    renderSerial(arr);
    qs('serialInfo').textContent = `${serial} Â· ${arr.length}ê±´`;
    qs('serialInfo').style.display='inline-block';
  }catch(e){
    qs('serialResults').innerHTML = `<p class="error">ì˜¤ë¥˜: ${escapeHtml(e.message)}</p>`;
  }
}
function renderSerial(rows){
  const div = qs('serialResults');
  if(!rows || rows.length===0){ div.innerHTML='<p>í•´ë‹¹ ì‹œë¦¬ì–¼ë²ˆí˜¸ë¡œ ì¡°íšŒëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  const byUID = {};
  rows.forEach(r=>{ const k = r.unique_id || '(unknown)'; (byUID[k] ||= []).push(r); });
  let html = '<table><thead><tr><th>ê³ ìœ ë²ˆí˜¸</th><th>ë‚ ì§œÂ·ì‹œê°„ ëª©ë¡</th></tr></thead><tbody>';
  Object.keys(byUID).sort().forEach(uid=>{
    const lines = byUID[uid].map(r=> `${escapeHtml((r['ë‚ ì§œ']||'').trim())} ${escapeHtml((r['ì‹œê°„']||'').trim())}`).join('<br/>');
    html += `<tr><td>${escapeHtml(uid)}</td><td>${lines}</td></tr>`;
  });
  html += '</tbody></table>';
  div.innerHTML = wrapTable(html);
}

/* ===== URL ?uid=AA0001 â†’ ìë™ ì¡°íšŒ ===== */
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);
  const uid = params.get('uid');
  if (uid) {
    const tabBtn = document.querySelector('.tab[data-tab="uid"]');
    if (tabBtn) tabBtn.click?.();
    const input = qs('uidInput');
    if (input) {
      input.value = decodeURIComponent(uid).toUpperCase();
      searchByUID(1);
    }
  }
});
  </script>

  <!-- ì±„íŒ… ë°ëª¨(ê·¸ëŒ€ë¡œ ìœ ì§€) -->
  <script>
(() => {
  const box  = document.getElementById('chatBox');
  const input= document.getElementById('chatInput');
  const btn  = document.getElementById('chatSend');
  if (!box || !input || !btn) return;

  function addMsg(text, me=true){
    const d = document.createElement('div');
    d.className = 'msg ' + (me ? 'me' : 'bot');
    d.textContent = text;
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
  }
  function send(){
    const t = (input.value || '').trim();
    if(!t) return;
    addMsg(t, true);
    input.value = '';
  }
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
  btn.addEventListener('click', send);
})();
  </script>

  <!-- ë¶™ì—¬ë„£ê¸° OCR ë„êµ¬(ê·¸ëŒ€ë¡œ ìœ ì§€) -->
  <script>
function chatAdd(text, who='bot') {
  const box = document.getElementById('chatBox');
  if (!box) return;
  const d = document.createElement('div');
  d.className = 'msg ' + (who === 'me' ? 'me' : 'bot');
  d.textContent = text;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}
function chatAddImage(url){
  const box = document.getElementById('chatBox');
  if (!box) return;
  const d = document.createElement('div');
  d.className = 'msg me';
  const img = new Image();
  img.src = url;
  img.style.maxWidth = '240px';
  img.style.borderRadius = '8px';
  img.style.border = '1px solid #e5e7eb';
  d.appendChild(img);
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}
async function toPngBlob(file) {
  if (file.type === 'image/png') return file;
  const bmp = await createImageBitmap(file);
  const canvas = document.createElement('canvas');
  canvas.width = bmp.width; canvas.height = bmp.height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(bmp, 0, 0);
  return await new Promise(res => canvas.toBlob(b => res(b), 'image/png', 0.95));
}
const OCRSPACE_KEY = 'K81476248188957'; // êµì²´ í•„ìš”
async function ocrWithOCRSpace(origFile) {
  const pngBlob = await toPngBlob(origFile);
  const form = new FormData();
  form.append('apikey', OCRSPACE_KEY);
  form.append('language', 'eng');
  form.append('scale', 'true');
  form.append('detectOrientation', 'true');
  form.append('OCREngine','2');
  form.append('file', pngBlob, 'paste.png');

  const res = await fetch('https://api.ocr.space/parse/image', { method:'POST', body:form });
  if (!res.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜(' + res.status + ')');
  const data = await res.json();

  if (data.IsErroredOnProcessing) {
    const em = Array.isArray(data.ErrorMessage) ? data.ErrorMessage.join(', ') : (data.ErrorMessage || 'ì²˜ë¦¬ ì—ëŸ¬');
    throw new Error(em);
  }
  const text = (data?.ParsedResults?.[0]?.ParsedText || '').trim();
  if (!text) throw new Error('ë¹ˆ ê²°ê³¼');
  return text;
}
window.addEventListener('paste', async (e) => {
  const item = [...(e.clipboardData?.items || [])].find(i => i.kind === 'file' && i.type.startsWith('image/'));
  if (!item) return;
  const file = item.getAsFile();
  const url = URL.createObjectURL(file);
  chatAddImage(url);
  chatAdd('ì´ë¯¸ì§€ ì ‘ìˆ˜ë¨. OCR ì²˜ë¦¬ ì¤‘â€¦', 'bot');
  try {
    const text = await ocrWithOCRSpace(file);
    const shown = text.length > 500 ? text.slice(0, 500) + ' â€¦' : text;
    chatAdd('RAW: ' + shown, 'bot');
  } catch (err) {
    chatAdd('OCR ì—ëŸ¬: ' + (err?.message || String(err)), 'bot');
  } finally {
    setTimeout(() => URL.revokeObjectURL(url), 3000);
  }
});
  </script>

  <!-- ===== ê´€ë¦¬(ìˆ˜ì •) íƒ­ ìŠ¤í¬ë¦½íŠ¸: ì¸ë¼ì¸ í¸ì§‘/ë²Œí¬ ì €ì¥ ===== -->
  <script>
const editState = {
  rows: [],          // ì„œë²„ì—ì„œ ë°›ì€ ì›ë³¸ í–‰ë“¤
  inserts: [],       // ìƒˆë¡œ ì¶”ê°€ëœ ì„ì‹œ í–‰ë“¤({_tmpId, unique_id, ë‚ ì§œ, ì‹œê°„, ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„})
  updates: {},       // ìˆ˜ì •ëœ í•„ë“œ ë§µ: id -> {í•„ë“œ:ê°’...}
  deletes: new Set() // ì‚­ì œ ëŒ€ìƒ _id ë“¤
};

function E(id){ return document.getElementById(id); }
function h(x){ return String(x ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function val(id){ return (E(id).value || '').trim(); }

// ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadEditable(){
  const uid   = val('editUid').toUpperCase();
  const from  = val('editFrom');
  const to    = val('editTo');
  const token = val('editToken');
  if(!token){ alert('ê´€ë¦¬ì í† í°ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if(!uid){ alert('ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }

  const u = new URL(apiList);
  u.searchParams.set('token', token);
  u.searchParams.set('unique_id', uid);
  if(from) u.searchParams.set('from', from);
  if(to)   u.searchParams.set('to', to);

  E('editMsg').textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
  try{
    const res = await fetch(u, {mode:'cors'});
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
    editState.rows   = j.rows || [];
    editState.inserts= [];
    editState.updates= {};
    editState.deletes= new Set();

    renderEditTable();
    E('editMeta').style.display='inline-block';
    E('editMeta').textContent = `${uid} Â· ${editState.rows.length}ê±´ ë¡œë“œë¨`;
    E('editMsg').textContent = '';
  }catch(e){
    E('editMsg').textContent = `ì˜¤ë¥˜: ${e.message}`;
  }
}

// í…Œì´ë¸” ë Œë”
function renderEditTable(){
  const cols = [
    { key: 'select', label: '', width: 30 },
    { key: 'unique_id', label: 'ê³ ìœ ë²ˆí˜¸', width: 120 },
    { key: 'ë‚ ì§œ', label: 'ë‚ ì§œ', width: 110 },
    { key: 'ì‹œê°„', label: 'ì‹œê°„', width: 90 },
    { key: 'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„', label: 'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„', width: 200 },
  ];

  let html = '<table><thead><tr>';
  cols.forEach(c => {
    html += `<th ${c.width?`style="min-width:${c.width}px"`:''}>${c.label}</th>`;
  });
  html += '</tr></thead><tbody>';

  for(const r of editState.rows){
    if(editState.deletes.has(r._id)) continue;
    html += rowHtml(r, false);
  }
  for(const r of editState.inserts){
    html += rowHtml(r, true);
  }

  html += '</tbody></table>';
  E('editTableWrap').innerHTML = html;
  bindCellHandlers();
}

function rowHtml(r, isNew){
  const rowId = isNew ? r._tmpId : r._id;
  const uid = r.unique_id ?? '';
  const d   = r['ë‚ ì§œ'] ?? '';
  const t   = r['ì‹œê°„'] ?? '';
  const srl = r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'] ?? '';
  const trAttr = `data-rowid="${h(rowId)}" data-new="${isNew?'1':'0'}"`;
  const cell = (key, value) => `<td contenteditable="true" data-key="${key}">${h(value)}</td>`;
  return `<tr ${trAttr}>
    <td style="text-align:center"><input type="checkbox" class="row-check"/></td>
    ${cell('unique_id', uid)}
    ${cell('ë‚ ì§œ', d)}
    ${cell('ì‹œê°„', t)}
    ${cell('ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„', srl)}
  </tr>`;
}

function bindCellHandlers(){
  const wrap = E('editTableWrap');
  wrap.querySelectorAll('td[contenteditable="true"]').forEach(td=>{
    td.addEventListener('input', ()=>{
      const tr = td.closest('tr');
      const key = td.dataset.key;
      const rowId = tr.dataset.rowid;
      const isNew = tr.dataset.new === '1';
      const v = td.textContent.trim();

      if(isNew){
        const i = editState.inserts.findIndex(x=> x._tmpId===rowId);
        if(i>=0) editState.inserts[i][key] = v;
      }else{
        const m = (editState.updates[rowId] ||= {});
        m[key] = v;
      }
    });
  });
}

// í–‰ ì¶”ê°€/ì‚­ì œ
function addRow(){
  const uid = val('editUid').toUpperCase();
  if(!uid){ alert('ë¨¼ì € ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥/ë¶ˆëŸ¬ì˜¤ê¸° í•˜ì„¸ìš”'); return; }
  const tmpId = 'new_' + Math.random().toString(36).slice(2, 9);
  editState.inserts.push({
    _tmpId: tmpId,
    unique_id: uid,
    'ë‚ ì§œ': '',
    'ì‹œê°„': '',
    'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„': ''
  });
  renderEditTable();
}
function deleteSelected(){
  const wrap = E('editTableWrap');
  const checks = [...wrap.querySelectorAll('.row-check')];
  let delCount = 0;

  for(const chk of checks){
    if(!chk.checked) continue;
    const tr = chk.closest('tr');
    const rowId = tr.dataset.rowid;
    const isNew = tr.dataset.new === '1';
    if(isNew){
      editState.inserts = editState.inserts.filter(x=> x._tmpId !== rowId);
    }else{
      editState.deletes.add(rowId);
      delete editState.updates[rowId];
    }
    delCount++;
  }
  if(delCount===0) { alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  renderEditTable();
}

// ì €ì¥(ë°˜ì˜)
async function saveEdits(){
  const token = val('editToken');
  if(!token){ alert('ê´€ë¦¬ì í† í°ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

  const inserts = [];
  for(const r of editState.inserts){
    const uid = (r.unique_id||'').trim().toUpperCase();
    const d   = (r['ë‚ ì§œ']||'').trim();
    const t   = (r['ì‹œê°„']||'').trim();
    const srl = (r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']||'').trim();
    if(!uid || !d || !t || !srl){
      E('editMsg').textContent = 'ì¶”ê°€ í–‰ì— ë¹„ì–´ìˆëŠ” ê°’ì´ ìˆìŠµë‹ˆë‹¤.';
      return;
    }
    inserts.push({ unique_id: uid, 'ë‚ ì§œ': d, 'ì‹œê°„': t, 'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„': srl });
  }

  const updates = Object.entries(editState.updates).map(([id, fields])=>{
    const out = { _id: id };
    if('unique_id' in fields) out.unique_id = (fields.unique_id||'').trim().toUpperCase();
    if('ë‚ ì§œ' in fields) out['ë‚ ì§œ'] = (fields['ë‚ ì§œ']||'').trim();
    if('ì‹œê°„' in fields) out['ì‹œê°„'] = (fields['ì‹œê°„']||'').trim();
    if('ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„' in fields) out['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'] = (fields['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']||'').trim();
    return out;
  });

  const deletes = Array.from(editState.deletes);

  const payload = { insert: inserts, update: updates, delete: deletes };

  E('editMsg').textContent = 'ë°˜ì˜ ì¤‘â€¦';
  try{
    const u = new URL(apiBulk);
    u.searchParams.set('token', token);
    const res = await fetch(u, {
      method:'POST',
      mode:'cors',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!res.ok || !j.ok){
      throw new Error(j.error || `ì €ì¥ ì‹¤íŒ¨ (HTTP ${res.status})`);
    }
    E('editMsg').textContent = `ì„±ê³µ: matched ${j.matched}, modified ${j.modified}, upserts ${j.upserts}, deleted ${j.deleted}`;
    await loadEditable();
  }catch(e){
    // ë°±ì—”ë“œê°€ BulkWriteError ë©”ì‹œì§€ë¥¼ errorì— ë„£ì–´ì£¼ë©´ ê·¸ëŒ€ë¡œ í‘œì‹œë¨
    E('editMsg').textContent = `ì˜¤ë¥˜: ${e.message}`;
  }
}

    /* ==== OCR â†’ ê´€ë¦¬í…Œì´ë¸” ìë™ ì±„ìš°ê¸° ==== */
// OCR í…ìŠ¤íŠ¸ íŒŒì‹± í•¨ìˆ˜
function parseOCRText(raw) {
  const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  let date = '', time = '', serial = '';

  // ë‚ ì§œÂ·ì‹œê°„ íŒ¨í„´ ì°¾ê¸°
  for (const l of lines) {
    const m = l.match(/(\d{4}\.\d{2}\.\d{2})\s+(\d{1,2}:\d{2})/);
    if (m) {
      date = m[1];
      time = m[2];
    }
    const srl = l.match(/No\.\s*([A-Za-z0-9\-_]+)/);
    if (srl) serial = srl[1];
  }

  return { date, time, serial };
}

// OCR ê²°ê³¼ ì±„íŒ… ê°ì‹œ í›„ ìë™ ë°˜ì˜
const chatBox = document.getElementById('chatBox');
const observer = new MutationObserver(() => {
  const msgs = [...chatBox.querySelectorAll('.msg.bot')];
  if (msgs.length === 0) return;
  const last = msgs[msgs.length - 1];
  const txt = last.textContent || '';
  if (txt.startsWith('RAW:')) {
    const parsed = parseOCRText(txt);
    if (parsed.date && parsed.time && parsed.serial) {
      // ê´€ë¦¬ íƒ­ í…Œì´ë¸”ì— ìë™ ì¶”ê°€
      autoAddOCRRow(parsed);
    }
  }
});
observer.observe(chatBox, { childList: true });

// ê´€ë¦¬ í…Œì´ë¸”ì— OCR í–‰ ì¶”ê°€
function autoAddOCRRow({ date, time, serial }) {
  const uid = (document.getElementById('editUid')?.value || '').trim().toUpperCase();
  if (!uid) {
    chatAdd('âš ï¸ ê´€ë¦¬ íƒ­ì— ê³ ìœ ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'bot');
    return;
  }

  const tmpId = 'ocr_' + Math.random().toString(36).slice(2, 8);
  editState.inserts.push({
    _tmpId: tmpId,
    unique_id: uid,
    'ë‚ ì§œ': date,
    'ì‹œê°„': time,
    'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„': serial
  });

  renderEditTable();
  chatAdd(`âœ… OCR ë°ì´í„° ìë™ ì¶”ê°€ë¨: ${date} ${time} / ${serial}`, 'bot');
}
  </script>
</body>
</html>
