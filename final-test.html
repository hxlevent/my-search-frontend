<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì´ë²¤íŠ¸ ì¡°íšŒÂ·ê´€ë¦¬ + OCR ì¼ì²´í˜•</title>
  <style>
/* ë°”ë””/ì»¨í…Œì´ë„ˆ */
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;margin:0;padding:16px;background:#f4f7f9;color:#333}
.container{max-width:1300px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
h1{margin:0 0 12px;color:#2c3e50;font-size:22px}

/* ì…ë ¥í–‰/ë²„íŠ¼ */
.row{display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:12px}
input,select,textarea{padding:10px;font-size:14px;border:1px solid #d1d5db;border-radius:8px;width:100%}
.btn{padding:10px 14px;background:#2563eb;color:#fff;border:0;border-radius:8px;cursor:pointer}
.btn.secondary{background:#6b7280}
.btn.danger{background:#b91c1c}
.btn:hover{filter:brightness(.95)}
.meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:#666;font-size:13px;margin:6px 0}
.tag{background:#eef6ff;color:#1f6feb;border:1px solid #d0e7ff;border-radius:999px;padding:4px 10px;font-size:12px}
.error{color:#d91e18}
.center{text-align:center}
.strong{font-weight:600}

/* í…Œì´ë¸” */
.table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;min-width:760px}
th,td{border:1px solid #eee;padding:8px;white-space:nowrap}
th{background:#f6f8fa}
tr:nth-child(even){background:#fafafa}
td input{width:100%;box-sizing:border-box;padding:6px}

/* 2ë‹¨ ë ˆì´ì•„ì›ƒ */
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
.card h2{margin:0 0 8px;font-size:18px;color:#2c3e50}

/* ì±„íŒ…/OCR ì˜ì—­ */
.chat-box{height:220px;overflow-y:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:90%;padding:8px 12px;border-radius:12px;line-height:1.4;word-break:break-word;white-space:pre-wrap}
.msg.me{align-self:flex-end;background:#1f6feb;color:#fff;border-bottom-right-radius:4px}
.msg.bot{align-self:flex-start;background:#e5e7eb;color:#333;border-bottom-left-radius:4px}
.msg img{max-width:240px;border-radius:8px;border:1px solid #e5e7eb}

/* ë°˜ì‘í˜• */
@media (max-width: 1100px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì´ë²¤íŠ¸ ì¡°íšŒÂ·ê´€ë¦¬ + OCR ì¼ì²´í˜•</h1>

    <div class="grid">
      <!-- ì¢Œ: ê²€ìƒ‰ + ê´€ë¦¬(ìˆ˜ì •) -->
      <div class="card">
        <h2>â‘  ê³ ìœ ë²ˆí˜¸ ê²€ìƒ‰ & ê´€ë¦¬</h2>
        <div class="meta">
          <span class="tag">í•œ í™”ë©´ì—ì„œ ê²€ìƒ‰â†’ìˆ˜ì •â†’ë°˜ì˜â†’ë©”ì‹œì§€ê¹Œì§€</span>
          <span class="tag" id="modeBadge">ê´€ë¦¬ì ëª¨ë“œ</span>
        </div>

        <!-- ê²€ìƒ‰ì¤„ -->
        <div class="row" style="grid-template-columns: 1fr auto auto auto auto;">
          <input id="uidInput" placeholder="ê³ ìœ ë²ˆí˜¸(unique_id)" />
          <button class="btn" onclick="searchByUID()">ê²€ìƒ‰(ê³µê°œ)</button>
          <button class="btn secondary" onclick="loadForEdit()">ë¶ˆëŸ¬ì˜¤ê¸°(ê´€ë¦¬)</button>
          <button class="btn" onclick="addBlankRow()">í–‰ ì¶”ê°€</button>
          <button class="btn danger" onclick="deleteChecked()">ì„ íƒ ì‚­ì œ</button>
        </div>

        <!-- í˜ì´ì§€/ì œí•œ -->
        <div class="meta">
          <span id="pageInfo" class="tag">page 1</span>
          <button class="btn secondary" onclick="prevPage()">â—€</button>
          <button class="btn secondary" onclick="nextPage()">â–¶</button>
          <select id="limitSel" onchange="changeLimit()">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500" selected>500</option>
          </select>
          <span id="loader" style="display:none">ê²€ìƒ‰ ì¤‘â€¦ <b id="timer">0.0</b>s</span>
        </div>

        <!-- ìš”ì•½(ì›ë³¸) -->
        <div id="summaryBox" class="table-wrap"></div>

        <!-- ê´€ë¦¬ í…Œì´ë¸” -->
        <div class="table-wrap" id="editTableWrap"></div>

        <!-- ë°˜ì˜ + ë©”ì‹œì§€ -->
        <div class="meta">
          <button class="btn" id="applyBtn" onclick="applyBulk()">DB ë°˜ì˜</button>
          <button class="btn secondary" onclick="generateAndCopy()">ë©”ì‹œì§€ ìƒì„± & ë³µì‚¬</button>
          <span id="flash" class="tag" style="display:none"></span>
        </div>

        <!-- ìµœì¢… ë©”ì‹œì§€ -->
        <textarea id="messageBox" rows="10" placeholder="ìµœì¢…ì•ˆë‚´ ë©”ì‹œì§€" style="width:100%;margin-top:6px;"></textarea>
      </div>

      <!-- ìš°: OCR + ë¡œê·¸ -->
      <div class="card">
        <h2>â‘¡ ì¸ì¦ì„œ OCR ë¶™ì—¬ë„£ê¸°</h2>
        <div class="meta"><span class="tag">ìº¡ì²˜ë¥¼ ë³µì‚¬(Ctrl+C) â†’ ì´ í˜ì´ì§€ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)</span></div>
        <div id="chatBox" class="chat-box"></div>
        <div class="meta">
          <input type="file" id="fileInput" accept="image/*" />
          <button class="btn" onclick="ocrFromFile()">íŒŒì¼ OCR</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/** =========================
 *  ìƒìˆ˜(ë³´ì•ˆ ë¬´ì‹œ ë²„ì „)
 *  ========================= */
const baseUrl      = 'https://my-search-backend.onrender.com'; // â† ë°±ì—”ë“œ ì£¼ì†Œ
const apiSearch    = `${baseUrl}/search`;
const apiAdminList = `${baseUrl}/admin/records`;
const apiBulk      = `${baseUrl}/admin/records/bulk`;

const ADMIN_TOKEN  = 'PASTE_YOUR_ADMIN_TOKEN_HERE'; // â† ê´€ë¦¬ì ê³ ìœ í‚¤(íŒŒì¼ ì•ˆì— ë°•ì•„ë‘ )
const OCRSPACE_KEY = 'K81476248188957';             // â† OCR.space í‚¤(íŒŒì¼ ì•ˆì— ë°•ì•„ë‘ )

/** =========================
 *  ìƒíƒœ/ìœ í‹¸
 *  ========================= */
let timerInterval;
let state = { page:1, limit:500, lastSearchRows:[], editRows:[], inserts:[], updates:{}, deletes:new Set() };

function qs(id){ return document.getElementById(id); }
function escapeHtml(x){ return String(x).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
function startTimer(){ let s=Date.now(); qs('timer').textContent='0.0'; qs('loader').style.display='inline-block'; timerInterval=setInterval(()=>{ qs('timer').textContent=((Date.now()-s)/1000).toFixed(1); },100); }
function stopTimer(){ clearInterval(timerInterval); qs('loader').style.display='none'; }
function flash(msg){ const el=qs('flash'); el.textContent=msg; el.style.display='inline-block'; setTimeout(()=>{el.style.display='none'},1800); }
function toUpper(s){ return (s||'').trim().toUpperCase(); }
function v(v){ return (v||'').trim(); }

/** ë‚ ì§œë²”ìœ„/ë¼ë²¨/ì‹œê°„íŒŒì„œ (ìš”ì•½ ê³„ì‚°ìš©) */
function getDateRange(startStr, endStr) {
  const toDate = (s) => { const [Y, M, D] = s.split('.').map(Number); return new Date(Y, M - 1, D); };
  const fmt = (d) => { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}.${m}.${day}`; };
  const res = []; let cur = toDate(startStr); const end = toDate(endStr);
  while (cur <= end) { res.push(fmt(cur)); cur.setDate(cur.getDate() + 1); }
  return res;
}
function toMD(dateStr) { const parts = dateStr.split('.').map(Number); return `${parts[1]}/${parts[2]}`; }
function timeToMinutes(t) {
  if (!t) return null;
  const s = String(t).trim();
  const ampmMatch = s.match(/ì˜¤ì „|ì˜¤í›„|AM|PM/i);
  const ampm = ampmMatch ? ampmMatch[0].toLowerCase() : null;
  const cleaned = s.replace(/\s+/g,'');
  const m = cleaned.match(/(\d{1,2})[:ì‹œ](\d{1,2})/);
  if (!m) return null;
  let h = parseInt(m[1], 10);
  let mm = parseInt(m[2], 10);
  if (Number.isNaN(h) || Number.isNaN(mm)) return null;
  if (ampm) {
    const isPM = /pm|ì˜¤í›„/i.test(ampm);
    const isAM = /am|ì˜¤ì „/i.test(ampm);
    if (isPM && h < 12) h += 12;
    if (isAM && h === 12) h = 0;
  }
  if (h < 0 || h > 23 || mm < 0 || mm > 59) return null;
  return h * 60 + mm;
}

/** =========================
 *  ê³µê°œ ê²€ìƒ‰(API /search)
 *  ========================= */
async function fetchRows(uid, page, limit) {
  const safeLimit = Math.max(1, Math.min(limit, 500));
  const u = new URL(apiSearch);
  u.searchParams.set('unique_id', uid);
  u.searchParams.set('page', page);
  u.searchParams.set('limit', safeLimit);
  const res = await fetch(u, { mode:'cors' });
  if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
  return await res.json();
}

async function searchByUID(page=null){
  const idRaw = qs('uidInput').value.trim();
  if(!idRaw){ alert('ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const uid = toUpper(idRaw);

  state.page = page ?? state.page;
  qs('limitSel').value = String(state.limit);
  qs('pageInfo').textContent = `page ${state.page}`;

  try{
    startTimer();
    const [pageRows, allRows] = await Promise.all([
      fetchRows(uid, state.page, state.limit),
      fetchRows(uid, 1, 500)
    ]);
    stopTimer();
    state.lastSearchRows = pageRows;
    renderSummary(allRows.length ? allRows : pageRows);
    // ê´€ë¦¬ í…Œì´ë¸”ë„ ê²€ìƒ‰ ê²°ê³¼ ê¸°ë°˜ìœ¼ë¡œ ë³´ì—¬ì£¼ë„ë¡ ì´ˆê¸°í™”
    state.editRows = (allRows.length ? allRows : pageRows).map(r => ({...r, _id:null}));
    state.inserts = []; state.updates={}; state.deletes.clear?.();
    renderEditTable();
  }catch(e){
    stopTimer();
    qs('summaryBox').innerHTML = `<p class="error">ì˜¤ë¥˜: ${escapeHtml(e.message)}</p>`;
  }
}

function prevPage(){ if(state.page>1) searchByUID(state.page-1); }
function nextPage(){ searchByUID(state.page+1); }
function changeLimit(){ state.limit = Number(qs('limitSel').value || 500); state.page=1; searchByUID(1); }

/** =========================
 *  ê´€ë¦¬ì ì¡°íšŒ(/admin/records) & ë°˜ì˜(/admin/records/bulk)
 *  ========================= */
async function loadForEdit(){
  const uid = toUpper(qs('uidInput').value);
  if(!uid){ alert('ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  const u = new URL(apiAdminList);
  u.searchParams.set('unique_id', uid);

  const res = await fetch(u, {
    method: 'GET',
    headers: { 'X-Admin-Token': ADMIN_TOKEN },
    mode: 'cors'
  });
  if(!res.ok){ alert('ê´€ë¦¬ ì¡°íšŒ ì‹¤íŒ¨(í† í°/ì„œë²„ í™•ì¸)'); return; }
  const j = await res.json();
  const rows = (j.rows||[]).map(r => ({
    _id: r._id || null,
    unique_id: r.unique_id || uid,
    'ë‚ ì§œ': r['ë‚ ì§œ'] || '',
    'ì‹œê°„': r['ì‹œê°„'] || '',
    'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„': r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'] || r['ì¸ì¦ìƒ·ì‹œë¦¬ì–¼ë„˜ë²„'] || ''
  }));
  state.editRows = rows;
  state.inserts = []; state.updates={}; state.deletes = new Set();
  renderEditTable();
  renderSummary(rows);
  flash('ê´€ë¦¬ ë°ì´í„° ë¶ˆëŸ¬ì˜´');
}

async function applyBulk(){
  const payload = {
    insert: state.inserts.map(x => ({
      unique_id: toUpper(x.unique_id),
      'ë‚ ì§œ': v(x['ë‚ ì§œ']),
      'ì‹œê°„': v(x['ì‹œê°„']),
      'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„': v(x['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'])
    })),
    update: Object.values(state.updates).map(x => ({
      _id: x._id,
      unique_id: toUpper(x.unique_id),
      'ë‚ ì§œ': v(x['ë‚ ì§œ']),
      'ì‹œê°„': v(x['ì‹œê°„']),
      'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„': v(x['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'])
    })),
    delete: Array.from(state.deletes)
  };

  const res = await fetch(apiBulk, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Admin-Token': ADMIN_TOKEN
    },
    body: JSON.stringify(payload),
    mode: 'cors'
  });
  if(!res.ok){ alert('DB ë°˜ì˜ ì‹¤íŒ¨'); return; }
  const r = await res.json();
  flash(`ë°˜ì˜ ì™„ë£Œ (matched:${r.matched||0} / modified:${r.modified||0} / upserts:${r.upserts||0} / deleted:${r.deleted||0})`);

  // ë°˜ì˜ í›„ ìµœì‹  ë°ì´í„°ë¡œ ì¬ì¡°íšŒ â†’ ìš”ì•½/ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  await loadForEdit();
  generateMessage(); // ìµœì‹  rows ê¸°ì¤€ ë©”ì‹œì§€ ìë™ ìƒì„±
}

/** =========================
 *  ìš”ì•½ ë Œë” & ë©”ì‹œì§€ ìƒì„±
 *  ========================= */
function renderSummary(rows){
  // 1) ë‚ ì§œ ë²”ìœ„
  const df = '2025.09.19', dt = '2025.09.25', day25 = '2025.09.25';
  const days = getDateRange(df, dt);

  // 2) ì§‘ê³„
  const counts = Object.fromEntries(days.map(d => [d, 0]));
  let count25_first=0, countLive=0;
  rows.forEach(r=>{
    const d = String(r['ë‚ ì§œ']||'').trim();
    const t = String(r['ì‹œê°„']||'').trim();
    if(!d || !counts.hasOwnProperty(d)) return;
    if(d===day25){
      const mins = timeToMinutes(t);
      if(mins!==null){
        if(mins<=9*60+59) count25_first += 1;
        else if(mins>=12*60) countLive += 1;
      }
    }else{
      counts[d]+=1;
    }
  });

  // 3) í‘œ
  const headerLabels=[], headerKeys=[];
  days.forEach(d=>{
    if(d===day25){ headerLabels.push('9/25(1ì°¨)'); headerKeys.push(d+'_first'); headerLabels.push('ìƒë°©'); headerKeys.push(d+'_live'); }
    else { headerLabels.push(toMD(d)); headerKeys.push(d); }
  });
  const summaryCells = headerKeys.map(k=>{
    if(k.endsWith('_first')) return count25_first;
    if(k.endsWith('_live'))  return countLive;
    return counts[k]||0;
  });

  let perfect = true;
  for(const d of days){ if(d===day25) continue; if((counts[d]||0)<1){ perfect=false; break; } }
  if(count25_first<1) perfect=false;

  let html = '<table><thead><tr><th style="min-width:140px">ì°¸ì—¬ ìš”ì•½(ìµœì‹ )</th>';
  headerLabels.forEach(lbl=> html+=`<th>${lbl}</th>`);
  html += '</tr></thead><tbody>';
  html += `<tr><td>ê±´ìˆ˜</td>${summaryCells.map(c=>`<td class="center">${c}</td>`).join('')}</tr>`;
  html += `<tr><td>ê°œê·¼</td><td class="center strong" colspan="${headerLabels.length}">${perfect?'o':'x'}</td></tr>`;
  html += '</tbody></table>';

  qs('summaryBox').innerHTML = html;

  // ë©”ì‹œì§€ìš© ìƒíƒœ ì €ì¥
  state.summaryForMsg = {
    a: counts['2025.09.19']||0, b: counts['2025.09.20']||0, c: counts['2025.09.21']||0,
    d: counts['2025.09.22']||0, e: counts['2025.09.23']||0, f: counts['2025.09.24']||0,
    g: count25_first, n: countLive, perfect
  };
}

function generateMessage(){
  const uid = toUpper(qs('uidInput').value) || 'ê³ ìœ ë²ˆí˜¸';
  const s = state.summaryForMsg || {a:0,b:0,c:0,d:0,e:0,f:0,g:0,n:0,perfect:false};
  const k = s.a+s.b+s.c+s.d+s.e+s.f+s.g;
  const weight = s.perfect ? (s.n*8) : s.n;

  const msg =
`ğŸ“¢ ${uid} ë‹˜, ìµœì¢… ì§‘ê³„ ì•ˆë‚´ì…ë‹ˆë‹¤.

âœ”ì „ì²´ íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­
(09.19 - 09.25)
19ì¼ - ${s.a}ê±´ 
20ì¼ - ${s.b}ê±´ 
21ì¼ - ${s.c}ê±´ 
22ì¼ - ${s.d}ê±´ 
23ì¼ - ${s.e}ê±´ 
24ì¼ - ${s.f}ê±´ 
25ì¼ ì‚¬ì „íˆ¬í‘œ - ${s.g}ê±´ 
25ì¼ ìƒë°©íˆ¬í‘œ - ${s.n}ê±´

ğŸ€ ì‚¬ì „ íˆ¬í‘œê¸°ê°„ ì´ ëˆ„ì íˆ¬í‘œìˆ˜ : ${k}ê±´ 
(ìƒë°© íˆ¬í‘œëŠ” ëˆ„ì íˆ¬í‘œìˆ˜ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

${uid} ë‹˜ì€ ${s.perfect ? 'ê°œê·¼ì— í•´ë‹¹ë©ë‹ˆë‹¤.' : 'ê°œê·¼ì— í•´ë‹¹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}
ê°œê·¼ì€ 19ì¼ íˆ¬í‘œë¶€í„° 25ì¼ ì˜¤ì „ íˆ¬í‘œê¹Œì§€ ëª¨ë‘ í•´ì£¼ì‹  ë¶„ë“¤ë§Œ í•´ë‹¹ë©ë‹ˆë‹¤.

25ì¼ ìƒë°© íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­ì€ ${s.n}ê±´ì…ë‹ˆë‹¤.
ê°œê·¼ ì—¬ë¶€ì— ë”°ë¥¸ ìƒë°© ì´ë²¤íŠ¸ ì´ ê°€ì¤‘ì¹˜ëŠ” ${s.perfect ? `${s.n}â†’ 8Ã—${s.n} = ${weight}` : `${weight}`} ì…ë‹ˆë‹¤.

ì”¬ë¡±ì´ì—ê²Œ íˆ¬í‘œí•´ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤ğŸ˜º
ì›í™œí•œ ê²€ìˆ˜ë¥¼ ìœ„í•´ ë‹µì¥ì€ ë³´ë‚´ì§€ ë§ì•„ì£¼ì„¸ìš”ğŸ™

ëˆ„ë½ ë° ì •ì • ë¬¸ì˜ëŠ” ì´ê³³ì´ ì•„ë‹Œ ë¬¸ì˜ ì±„ë„ "í—ˆì”¬ë¡± ê°¤ëŸ¬ë¦¬ Q&A"ë¡œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ë°˜ë“œì‹œ ë¬¸ì˜ ì „ ë¬¸ì˜ ì±„ë„ í•˜ë‹¨ì˜ ì–‘ì‹ì„ ì°¸ê³ í•´ì„œ ë¬¸ì˜í•´ì£¼ì„¸ìš”ğŸ™
ë¬¸ì˜ ì±„ë„ ë§í¬ ğŸ“ 
http://pf.kakao.com/_cFxexcn `;
  qs('messageBox').value = msg;
}

function copyMessage(){
  const ta = qs('messageBox');
  ta.select(); ta.setSelectionRange(0, 99999);
  document.execCommand('copy');
  flash('ë©”ì‹œì§€ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
}
function generateAndCopy(){ generateMessage(); setTimeout(copyMessage, 80); }

/** =========================
 *  ê´€ë¦¬ í…Œì´ë¸” ë Œë”/ì¡°ì‘
 *  ========================= */
function renderEditTable(){
  const rows = state.editRows;
  let html = '<table><thead><tr>' +
    '<th><input type="checkbox" id="chkAll" onchange="toggleAll(this)"/></th>' +
    '<th>ê³ ìœ ë²ˆí˜¸</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„</th><th>_id</th>' +
    '</tr></thead><tbody>';

  rows.forEach((r, idx)=>{
    html += `<tr>
      <td><input type="checkbox" class="rowchk" data-idx="${idx}" ${state.deletes.has(r._id)?'checked':''}></td>
      <td><input value="${escapeHtml(r.unique_id||'')}" oninput="onCellEdit(${idx}, 'unique_id', this.value)" /></td>
      <td><input value="${escapeHtml(r['ë‚ ì§œ']||'')}" oninput="onCellEdit(${idx}, 'ë‚ ì§œ', this.value)" /></td>
      <td><input value="${escapeHtml(r['ì‹œê°„']||'')}" oninput="onCellEdit(${idx}, 'ì‹œê°„', this.value)" /></td>
      <td><input value="${escapeHtml(r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']||'')}" oninput="onCellEdit(${idx}, 'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„', this.value)" /></td>
      <td>${r._id ? escapeHtml(r._id) : ''}</td>
    </tr>`;
  });
  html += '</tbody></table>';

  qs('editTableWrap').innerHTML = html;
  const applyBtn = qs('applyBtn'); if(applyBtn) applyBtn.disabled = false;
}

function toggleAll(box){
  const chks = document.querySelectorAll('.rowchk');
  chks.forEach(c => { c.checked = box.checked; const idx = Number(c.dataset.idx); const r=state.editRows[idx]; if(r._id){ if(c.checked) state.deletes.add(r._id); else state.deletes.delete(r._id);} });
}

function onCellEdit(idx, key, value){
  const row = state.editRows[idx];
  row[key] = value;
  if(row._id){ // ê¸°ì¡´í–‰ â†’ ì—…ë°ì´íŠ¸ í
    state.updates[row._id] = {
      _id: row._id,
      unique_id: toUpper(row.unique_id),
      'ë‚ ì§œ': v(row['ë‚ ì§œ']),
      'ì‹œê°„': v(row['ì‹œê°„']),
      'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„': v(row['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'])
    };
  }else{
    // ì‹ ê·œí–‰ì€ inserts ë°°ì—´ ë‚´ë¶€ ì›ë³¸ì„ ê°±ì‹ 
    const found = state.inserts.find(x=>x._tmpId===row._tmpId);
    if(found){ found[key]=value; } // ë™ì¼ ì°¸ì¡° ë³´ì¥ ì•ˆë¼ì„œ ë™ê¸°í™”
  }
}

function addBlankRow(){
  const uid = toUpper(qs('uidInput').value);
  if(!uid){ alert('ê³ ìœ ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const tmpId = 'tmp_'+Math.random().toString(36).slice(2,8);
  const row = {_tmpId: tmpId, _id:null, unique_id: uid, 'ë‚ ì§œ':'', 'ì‹œê°„':'', 'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„':''};
  state.editRows.push(row);
  state.inserts.push({...row});
  renderEditTable();
}

function deleteChecked(){
  const chks = document.querySelectorAll('.rowchk:checked');
  if(chks.length===0){ alert('ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  // í‘œì‹œìƒ ì œê±° + í ë°˜ì˜
  const toDeleteIdx = new Set(Array.from(chks).map(c=>Number(c.dataset.idx)));
  const remain = [];
  state.editRows.forEach((r,i)=>{
    if(toDeleteIdx.has(i)){
      if(r._id) state.deletes.add(r._id);
      // ì‹ ê·œí–‰ì¸ ê²½ìš° insertsì—ì„œ ì œê±°
      if(r._tmpId) state.inserts = state.inserts.filter(x=>x._tmpId!==r._tmpId);
      delete state.updates[r._id];
    }else{
      remain.push(r);
    }
  });
  state.editRows = remain;
  renderEditTable();
}

/** =========================
 *  OCR: ë¶™ì—¬ë„£ê¸°/íŒŒì¼ â†’ OCR.space â†’ íŒŒì‹± â†’ í‘œ ìë™ ì¶”ê°€
 *  ========================= */
function chatAdd(text, who='bot'){
  const box = qs('chatBox');
  const d = document.createElement('div');
  d.className = 'msg ' + (who==='me' ? 'me' : 'bot');
  d.textContent = text;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}
function chatAddImage(url){
  const box = qs('chatBox');
  const d = document.createElement('div'); d.className='msg me';
  const img = new Image(); img.src=url; d.appendChild(img);
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}

async function toPngBlob(file){
  if(file.type==='image/png') return file;
  const bmp = await createImageBitmap(file);
  const canvas = document.createElement('canvas'); canvas.width=bmp.width; canvas.height=bmp.height;
  const ctx = canvas.getContext('2d'); ctx.drawImage(bmp,0,0);
  return await new Promise(res => canvas.toBlob(b => res(b),'image/png',0.95));
}

async function ocrWithOCRSpace(origFile){
  const pngBlob = await toPngBlob(origFile);
  const form = new FormData();
  form.append('apikey', OCRSPACE_KEY);
  form.append('language', 'eng');
  form.append('scale', 'true');
  form.append('detectOrientation', 'true');
  form.append('OCREngine','2');
  form.append('file', pngBlob, 'paste.png');

  const res = await fetch('https://api.ocr.space/parse/image', { method:'POST', body: form });
  if(!res.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜(' + res.status + ')');
  const data = await res.json();
  if(data.IsErroredOnProcessing){
    const em = Array.isArray(data.ErrorMessage) ? data.ErrorMessage.join(', ') : (data.ErrorMessage || 'ì²˜ë¦¬ ì—ëŸ¬');
    throw new Error(em);
  }
  const text = (data?.ParsedResults?.[0]?.ParsedText || '').trim();
  if(!text) throw new Error('ë¹ˆ ê²°ê³¼');
  return text;
}

function parseOCRText(raw){
  const text = raw.replace(/^RAW:\s*/,'');
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let date = '', time = '', serial='';

  for(const l of lines){
    const m = l.match(/(\d{4}\.\d{2}\.\d{2})\s+(\d{1,2}:\d{2})/);
    if(m){ date=m[1]; time=m[2]; }
    const srl = l.match(/No\.\s*([A-Za-z0-9\-\_]+)/i);
    if(srl){ serial=srl[1]; }
  }
  return { date, time, serial };
}

function autoAddOCRRow({ date, time, serial }){
  const uid = toUpper(qs('uidInput').value);
  if(!uid){ chatAdd('âš ï¸ ê³ ìœ ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.', 'bot'); return; }
  if(!date || !time || !serial){ chatAdd('âš ï¸ OCRì—ì„œ í•„ë“œ ì¶”ì¶œ ì‹¤íŒ¨(ë‚ ì§œ/ì‹œê°„/ì‹œë¦¬ì–¼).', 'bot'); return; }

  const tmpId = 'ocr_'+Math.random().toString(36).slice(2,8);
  const row = {_tmpId:tmpId,_id:null,unique_id:uid,'ë‚ ì§œ':date,'ì‹œê°„':time,'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„':serial};
  state.editRows.push(row);
  state.inserts.push({...row});
  renderEditTable();
  chatAdd(`âœ… OCR ì¶”ê°€: ${date} ${time} / ${serial}`, 'bot');
}

const chatBox = qs('chatBox');
const observer = new MutationObserver(()=>{ /* hook reserved */ });
observer.observe(chatBox,{childList:true});

window.addEventListener('paste', async (e)=>{
  const item = [...(e.clipboardData?.items || [])].find(i => i.kind==='file' && i.type.startsWith('image/'));
  if(!item) return;
  const file = item.getAsFile();
  const url = URL.createObjectURL(file);
  chatAddImage(url);
  chatAdd('ì´ë¯¸ì§€ ì ‘ìˆ˜ë¨. OCR ì²˜ë¦¬ ì¤‘â€¦', 'bot');
  try{
    const text = await ocrWithOCRSpace(file);
    const shown = text.length>500 ? text.slice(0,500)+' â€¦' : text;
    chatAdd('RAW: ' + shown, 'bot');
    const p = parseOCRText(text);
    autoAddOCRRow(p);
  }catch(err){
    chatAdd('OCR ì—ëŸ¬: ' + (err?.message || String(err)), 'bot');
  }finally{
    setTimeout(()=>URL.revokeObjectURL(url),3000);
  }
});

async function ocrFromFile(){
  const inp = qs('fileInput');
  const file = inp.files?.[0];
  if(!file){ alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const url = URL.createObjectURL(file);
  chatAddImage(url);
  chatAdd('íŒŒì¼ OCR ì²˜ë¦¬ ì¤‘â€¦', 'bot');
  try{
    const text = await ocrWithOCRSpace(file);
    chatAdd('RAW: ' + (text.length>500?text.slice(0,500)+' â€¦':text), 'bot');
    autoAddOCRRow(parseOCRText(text));
  }catch(e){
    chatAdd('OCR ì—ëŸ¬: ' + (e?.message||String(e)), 'bot');
  }finally{
    setTimeout(()=>URL.revokeObjectURL(url),3000);
  }
}

/** ì´ˆê¸° ëª¨ë“œ ë±ƒì§€/ì—”í„° í‚¤ */
document.addEventListener('DOMContentLoaded', ()=>{
  qs('modeBadge').textContent = 'ê´€ë¦¬ì ëª¨ë“œ(ë³´ì•ˆ ë¬´ì‹œ)';
  qs('uidInput').addEventListener('keydown', e=>{ if(e.key==='Enter') searchByUID(1); });
});
  </script>
</body>
</html>
