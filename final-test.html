<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>이벤트 데이터 조회 + OCR</title>
<style>
  :root{
    --bg:#f4f7f9; --fg:#333; --card:#fff; --border:#e5e7eb; --muted:#64748b;
    --brand:#2563eb; --brand2:#1f6feb; --ok:#16a34a; --err:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,SegoeUI,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif}
  .page{display:flex;gap:16px;align-items:flex-start;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .left{flex:1 1 0; padding:16px}
  .right{width:540px;padding:16px;position:sticky;top:12px;align-self:flex-start}
  h1{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:8px;align-items:center;margin:6px 0 10px}
  input,select,button,textarea{font-size:14px}
  input,select,textarea{border:1px solid var(--border);border-radius:8px;padding:9px 10px}
  textarea{width:100%;min-height:180px;font-family:inherit}
  .btn{border:none;border-radius:8px;background:var(--brand);color:#fff;padding:9px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.alt{background:#6b7280}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:#eef2ff;color:#374151;border:1px solid #dbeafe}
  .badge{display:inline-block;padding:4px 8px;border:1px solid #dbeafe;background:#eef6ff;border-radius:999px;color:#1f6feb;font-size:12px}
  .muted{color:var(--muted);font-size:12px}
  .hint{color:var(--muted);font-size:13px}
  .err{color:var(--err)}
  .ok{color:var(--ok)}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
  table{width:100%;border-collapse:collapse;min-width:760px}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;white-space:nowrap;text-align:left}
  th{background:#f8fafc;font-weight:600}
  tr:nth-child(even) td{background:#fafafa}
  td.editing{background:#fffbe6}
  .imgbox{width:100%;max-width:420px;margin:0 auto;border:1px dashed #cbd5e1;border-radius:12px;padding:8px;display:flex;justify-content:center;align-items:center}
  .imgbox img{max-width:100%;border-radius:8px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0}
  .chips .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#f8fafc}
  .flex{display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .right .footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .table-actions{display:flex;gap:8px}
  .pending td{background:#fff7ed!important}
</style>
</head>
<body>
<div class="page">

  <!-- LEFT: 검색/표/반영 -->
  <section class="left card">
    <h1>이벤트 데이터 조회</h1>
    <div class="row">
      <input id="uidInput" placeholder="고유번호(unique_id)" style="width:220px"/>
      <button class="btn" id="btnSearch">검색</button>
      <span class="hint" id="pageInfo">page 1</span>
      <button class="btn ghost" id="btnPrev">◀</button>
      <button class="btn ghost" id="btnNext">▶</button>
      <select id="limitSel">
        <option value="100">100</option>
        <option value="200">200</option>
        <option value="500" selected>500</option>
      </select>
      <span id="loader" class="muted" style="display:none">검색 중… <span id="timer">0.0</span>s</span>
    </div>

    <div class="row table-actions">
      <button class="btn ghost" id="btnAdd">행 추가</button>
      <button class="btn alt" id="btnDelete">선택 삭제</button>
      <button class="btn ok" id="btnApply">DB 반영(업서트)</button>
      <span class="muted">※ 삭제의 DB 반영은 지원 안 함(검색 응답에 _id 없음). 반영은 모두 upsert.</span>
    </div>

    <div class="table-wrap" id="tableWrap"></div>
  </section>

  <!-- RIGHT: OCR -->
  <aside class="right card">
    <h1>인증서 OCR 업로드 (붙여넣기)</h1>
    <div class="imgbox"><img id="ocrPreview" alt="미리보기"/></div>

    <div class="row">
      <select id="visionMode">
        <option value="DOCUMENT_TEXT_DETECTION" selected>Google Vision (DOCUMENT_TEXT_DETECTION)</option>
        <option value="TEXT_DETECTION">Google Vision (TEXT_DETECTION)</option>
      </select>
      <button class="btn ghost" id="btnKo">ko / en</button>
      <button class="btn alt" id="btnClear">지우기</button>
      <button class="btn" id="btnPushLeft">왼쪽 표로 추가</button>
    </div>

    <textarea id="ocrLog" placeholder="여기에 OCR 원문이 표시됩니다. (이미지를 붙여넣으세요)"></textarea>

    <div class="chips">
      <span class="chip">date: <span id="chipDate" class="muted">-</span></span>
      <span class="chip">time: <span id="chipTime" class="muted">-</span></span>
      <span class="chip">serial: <span id="chipSerial" class="muted">-</span></span>
    </div>

    <div class="flex">
      <input id="ocrDateInput"  class="grow" placeholder="YYYY.MM.DD">
      <input id="ocrTimeInput"  class="grow" placeholder="HH:MM">
      <input id="ocrSerialInput" class="grow" placeholder="M-...">
    </div>
    <div class="footer">
      <span class="hint" id="ocrHint">이미지 붙여넣기(Ctrl/⌘+V) → 자동 인식. 못 잡히면 직접 입력.</span>
      <span class="badge" id="ocrStatus">idle</span>
    </div>
  </aside>

</div>

<script>
/* ===================== 설정 ===================== */
const baseUrl      = 'https://my-search-backend.onrender.com'; // 백엔드
const apiSearch    = `${baseUrl}/search`;
const apiBulk      = `${baseUrl}/admin/records/bulk`;
const ADMIN_TOKEN  = 'PHMsVsRmR1ONtsaI';       // ← 문자열로!
const VISION_API_KEY = 'AIzaSyCVDnT8-FoaSFG3VJKRsz0O_g8XNpJWS-w';

let state = { page:1, limit:500, lastData:[], allRows:[], timer:null };

/* ===================== 유틸 ===================== */
const qs = id => document.getElementById(id);
function startTimer(){ const t=qs('timer'); qs('loader').style.display='inline'; const s=Date.now(); state.timer=setInterval(()=>{ t.textContent=((Date.now()-s)/1000).toFixed(1) },100) }
function stopTimer(){ clearInterval(state.timer); qs('loader').style.display='none' }
function escapeHtml(x){return String(x).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}

/* 날짜/시간 파서 */
function normalizeTime(s) {
  if (!s) return null;
  const m = String(s).trim().match(/^(\d{1,2})\s*[:시]\s*(\d{1,2})$/);
  if (!m) return null;
  let h=+m[1], mm=+m[2];
  if (h<0||h>23||mm<0||mm>59) return null;
  return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
}
function extractTimesColon2(text){
  const out = new Set(), s=String(text||'');
  for(let i=0;i<s.length;i++){
    if (s[i]!==':') continue;
    const pre = s.slice(Math.max(0,i-2), i).match(/\d{1,2}$/)?.[0];
    const post= s.slice(i+1, i+3);
    if(!pre || !/^\d{2}$/.test(post)) continue;
    const ok = normalizeTime(`${pre}:${post}`);
    if (ok) out.add(ok);
  }
  return [...out];
}
function extractDates(text){
  const re = /\b20\d{2}\.(0[1-9]|1[0-2])\.(0[1-9]|[12]\d|3[01])\b/g;
  return [...new Set([...String(text||'').matchAll(re)].map(m=>m[0]))];
}
function extractSerials(text){
  const re = /No\.\s*(M-[A-Za-z0-9\-_]+)/g;
  return [...new Set([...String(text||'').matchAll(re)].map(m=>m[1]))];
}

/* ===================== 표 렌더 ===================== */
function renderTable(rows){
  const wrap = qs('tableWrap');
  if (!rows || !rows.length) { wrap.innerHTML = '<div class="hint" style="padding:12px">검색 결과가 없습니다.</div>'; return; }
  let html = '<table><thead><tr>'+
    '<th style="width:36px"><input type="checkbox" id="checkAll"/></th>'+
    '<th>고유번호</th><th>날짜</th><th>시간</th><th>인증샷 시리얼넘버</th>'+
    '</tr></thead><tbody>';
  rows.forEach((r,i)=>{
    const serial = r['인증샷 시리얼넘버'] ?? r['인증샷시리얼넘버'] ?? '';
    const cls = r._pending ? ' class="pending"' : '';
    html += `<tr${cls} data-idx="${i}">
      <td><input type="checkbox" class="rowcheck"/></td>
      <td contenteditable="true"   data-k="unique_id">${escapeHtml(r.unique_id||'')}</td>
      <td contenteditable="true"   data-k="날짜">${escapeHtml(r['날짜']||'')}</td>
      <td contenteditable="true"   data-k="시간">${escapeHtml(r['시간']||'')}</td>
      <td contenteditable="true"   data-k="인증샷 시리얼넘버">${escapeHtml(serial)}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;

  // 편집 반영
  wrap.querySelectorAll('td[contenteditable]').forEach(td=>{
    td.addEventListener('input', ()=>{
      const tr = td.closest('tr');
      const idx = +tr.dataset.idx;
      const key = td.dataset.k;
      const val = td.innerText.trim();
      if (key==='unique_id') state.lastData[idx][key] = val.toUpperCase();
      else state.lastData[idx][key] = val;
      tr.classList.add('pending');
    });
  });

  // 체크박스 전체선택
  const ca = qs('checkAll');
  if (ca) ca.addEventListener('change', e=>{
    wrap.querySelectorAll('.rowcheck').forEach(c=> c.checked = e.target.checked );
  });
}

/* ===================== 검색 ===================== */
async function fetchRows(uid, page, limit){
  const u = new URL(apiSearch);
  u.searchParams.set('unique_id', uid);
  u.searchParams.set('page', page);
  u.searchParams.set('limit', Math.min(500, Math.max(1, limit)));
  const res = await fetch(u,{mode:'cors'});
  if(!res.ok) throw new Error('서버 오류');
  return await res.json();
}
async function doSearch(goPage=null){
  const raw = qs('uidInput').value.trim();
  if(!raw) return alert('고유번호를 입력하세요');
  const uid = raw.toUpperCase();
  if (goPage!=null) state.page = goPage;
  qs('pageInfo').textContent = `page ${state.page}`;
  try{
    startTimer();
    const [pageRows, allRows] = await Promise.all([
      fetchRows(uid, state.page, state.limit),
      fetchRows(uid, 1, 500)
    ]);
    state.lastData = pageRows.map(x=>({...x}));
    state.allRows  = allRows;
    renderTable(state.lastData);
  }catch(e){
    alert(e.message||String(e));
  }finally{ stopTimer(); }
}

/* ===================== 행추가/삭제/반영 ===================== */
qs('btnAdd').addEventListener('click', ()=>{
  const uid = (qs('uidInput').value||'').trim().toUpperCase();
  state.lastData.push({ unique_id: uid, '날짜':'', '시간':'', '인증샷 시리얼넘버':'', _pending:true });
  renderTable(state.lastData);
});
qs('btnDelete').addEventListener('click', ()=>{
  const wrap = qs('tableWrap');
  const keep=[]; state.lastData.forEach((r,i)=>{
    const tr = wrap.querySelector(`tr[data-idx="${i}"]`);
    const chk = tr?.querySelector('.rowcheck')?.checked;
    if (!chk) keep.push(r);
  });
  state.lastData = keep;
  renderTable(state.lastData);
});

qs('btnApply').addEventListener('click', async ()=>{
  // 모두 upsert(insert)로 보냄
  const payload = { insert: state.lastData.map(r=>({
    unique_id: (r.unique_id||'').trim().toUpperCase(),
    '날짜': (r['날짜']||'').trim(),
    '시간': normalizeTime((r['시간']||'').trim()) || (r['시간']||'').trim(),
    '인증샷 시리얼넘버': (r['인증샷 시리얼넘버'] ?? r['인증샷시리얼넘버'] || '').trim()
  })) };
  // 간단 검증
  const bad = payload.insert.find(x=> !x.unique_id || !x['날짜'] || !x['시간'] || !x['인증샷 시리얼넘버']);
  if (bad) return alert('빈 칸 없이(고유번호/날짜/시간/시리얼) 채워주세요.');

  try{
    const res = await fetch(apiBulk,{
      method:'POST',
      headers:{'Content-Type':'application/json','X-Admin-Token':ADMIN_TOKEN},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error||'반영 실패');
    alert(`반영 완료: upserts ${j.upserts}, matched ${j.matched}, modified ${j.modified}`);
    // 재조회로 확정값 표시
    doSearch(state.page);
  }catch(e){ alert(e.message||String(e)); }
});

/* 페이지 이동/limit */
qs('btnSearch').addEventListener('click', ()=>doSearch(1));
qs('btnPrev').addEventListener('click', ()=>{ if(state.page>1) doSearch(state.page-1); });
qs('btnNext').addEventListener('click', ()=>doSearch(state.page+1));
qs('limitSel').addEventListener('change', e=>{ state.limit = +e.target.value; doSearch(1); });
qs('uidInput').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(1) });

/* ===================== Google Vision ===================== */
const VISION_ENDPOINT = 'https://vision.googleapis.com/v1/images:annotate?key='+encodeURIComponent(VISION_API_KEY);

async function blobToBase64(blob){
  const buf = await blob.arrayBuffer();
  const bytes = new Uint8Array(buf);
  let bin=''; const CH=0x8000;
  for(let i=0;i<bytes.length;i+=CH){ bin += String.fromCharCode.apply(null, bytes.subarray(i,i+CH)); }
  return btoa(bin);
}
async function visionOCRFromBlob(blob){
  const content = await blobToBase64(blob);
  const type = qs('visionMode').value;
  const body = { requests:[{ image:{content}, features:[{type}], imageContext:{languageHints:['ko','en']} }] };
  const resp = await fetch(VISION_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const raw = await resp.text(); let json=null; try{ json = JSON.parse(raw) }catch{}
  if(!resp.ok){ const e=json?.error; throw new Error(`HTTP ${resp.status} ${e?.status||''} ${e?.message||''}`) }
  return json?.responses?.[0]?.fullTextAnnotation?.text
      || json?.responses?.[0]?.textAnnotations?.[0]?.description
      || '';
}

/* 붙여넣기 핸들러 */
document.addEventListener('paste', async (e)=>{
  const items = [...(e.clipboardData?.items||[])];
  const it = items.find(x=>x.kind==='file' && x.type.startsWith('image/'));
  if(!it) return;
  e.preventDefault();
  const file = it.getAsFile();
  qs('ocrPreview').src = URL.createObjectURL(file);
  qs('ocrStatus').textContent='recognizing…';
  try{
    const text = await visionOCRFromBlob(file);
    qs('ocrLog').value = text;

    const dates=extractDates(text), times=extractTimesColon2(text), serials=extractSerials(text);
    const date = dates[0] || '';
    const time = times[0] || '';
    const serial = serials[0] || '';

    qs('chipDate').textContent = date||'-';
    qs('chipTime').textContent = time||'-';
    qs('chipSerial').textContent = serial||'-';

    qs('ocrDateInput').value = date;
    qs('ocrTimeInput').value = time;
    qs('ocrSerialInput').value = serial;

    qs('ocrStatus').textContent='done';
    qs('ocrHint').textContent='필요시 날짜/시간/시리얼을 수정하고 [왼쪽 표로 추가]를 누르세요.';
  }catch(err){
    qs('ocrStatus').textContent='error';
    qs('ocrLog').value = 'OCR 에러: ' + (err.message||String(err));
  }
},{capture:true});

/* 수동 추가 버튼 */
qs('btnPushLeft').addEventListener('click', ()=>{
  const uid = (qs('uidInput').value||'').trim().toUpperCase();
  if(!uid) return alert('왼쪽 상단에 고유번호를 먼저 입력하세요.');
  const date = qs('ocrDateInput').value.trim();
  const tRaw = qs('ocrTimeInput').value.trim();
  const time = normalizeTime(tRaw);
  const serial = qs('ocrSerialInput').value.trim();
  if(!date) return alert('날짜(YYYY.MM.DD)를 입력하세요.');
  if(!time) return alert('시간(HH:MM)을 입력하세요.');
  if(!serial) return alert('시리얼(M-...)을 입력하세요.');

  const newRow = { unique_id: uid, '날짜': date, '시간': time, '인증샷 시리얼넘버': serial, _pending:true };
  const arr = Array.isArray(state.lastData)?[...state.lastData]:[];
  arr.push(newRow);
  // 정렬(날짜+시간)
  arr.sort((a,b)=>{
    const ap=(a['시간']||''); const bp=(b['시간']||'');
    return (`${a['날짜']||''} ${ap.padStart(5,'0')}`).localeCompare(`${b['날짜']||''} ${bp.padStart(5,'0')}`);
  });
  state.lastData = arr;
  renderTable(arr);
  qs('ocrStatus').textContent='pushed';
});

/* 기타 버튼 */
qs('btnKo').addEventListener('click', ()=> alert('Vision은 ko/en 힌트를 동시에 줍니다.'));
qs('btnClear').addEventListener('click', ()=>{
  qs('ocrPreview').src=''; qs('ocrLog').value='';
  qs('ocrDateInput').value = qs('ocrTimeInput').value = qs('ocrSerialInput').value = '';
  qs('chipDate').textContent=qs('chipTime').textContent=qs('chipSerial').textContent='-';
  qs('ocrStatus').textContent='idle';
});

/* ?uid= 파라미터 자동조회 */
document.addEventListener('DOMContentLoaded', ()=>{
  const u = new URLSearchParams(location.search);
  const v = u.get('uid');
  if (v){ qs('uidInput').value=v.toUpperCase(); doSearch(1); }
});
</script>
</body>
</html>
