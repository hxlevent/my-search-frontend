<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ì´ë²¤íŠ¸ ë°ì´í„° ì¡°íšŒ + OCR</title>
<style>
  :root{--pri:#2563eb;--text:#2c3e50;--bg:#f4f7f9;--b:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#333;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif}
  .page{display:flex;gap:18px;padding:14px}
  .pane{flex:1;background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:14px}
  h2{margin:0 0 10px;color:var(--text);font-size:18px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input,select,button,textarea{font-size:14px}
  input,select,textarea{border:1px solid var(--b);border-radius:8px;padding:9px}
  button{background:var(--pri);color:#fff;border:0;border-radius:8px;padding:9px 12px;cursor:pointer}
  button.ghost{background:#eef2ff;color:#1f34a2}
  button.light{background:#e5e7eb;color:#333}
  .tag{background:#eef6ff;border:1px solid #cfe3ff;color:#1f6feb;border-radius:999px;padding:3px 8px;font-size:12px}
  .table-wrap{overflow:auto;border:1px solid var(--b);border-radius:8px}
  table{width:100%;border-collapse:collapse;min-width:720px}
  th,td{border-bottom:1px solid #f0f2f5;padding:8px;white-space:nowrap}
  th{background:#f6f8fa;text-align:left;font-weight:600;color:#334155}
  tr:nth-child(even) td{background:#fafafa}
  td input{width:100%;padding:7px;border:1px solid #e5e7eb;border-radius:6px;background:#fff}
  .chk{text-align:center;width:36px}
  .right{display:flex;flex-direction:column;gap:12px}
  .ocr-box{display:flex;gap:12px}
  .ocr-left{flex:0 0 260px;border:1px dashed var(--b);border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:360px;overflow:hidden;background:#fbfbfd}
  .ocr-left img{max-width:100%;max-height:100%}
  .ocr-right{flex:1;display:flex;flex-direction:column;gap:8px}
  textarea{width:100%;min-height:180px;resize:vertical}
  .small{font-size:12px;color:#64748b}
  .ok{color:#0a7a28}
  .err{color:#b91c1c}
  .pill{padding:3px 8px;border-radius:999px;background:#f1f5f9}
  .grid2{display:grid;grid-template-columns:1fr auto auto auto;gap:8px}
  .flex-gap{display:flex;gap:6px;align-items:center}
  .manual{display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:8px}
</style>
</head>
<body>

<div class="page">
  <!-- LEFT: DATA TABLE -->
  <div class="pane">
    <h2>ì´ë²¤íŠ¸ ë°ì´í„° ì¡°íšŒ</h2>

    <div class="row">
      <input id="uidInput" placeholder="ê³ ìœ ë²ˆí˜¸ (ì˜ˆ: AH1018)" style="width:220px"/>
      <button id="btnLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span class="tag" id="countTag" style="display:none"></span>
      <span class="small" id="loadInfo"></span>
    </div>

    <div class="row">
      <div class="flex-gap">
        <button class="ghost" id="btnAddRow">í–‰ ì¶”ê°€</button>
        <button class="light" id="btnDeleteSel">ì„ íƒ ì‚­ì œ</button>
        <button id="btnApply">DB ë°˜ì˜</button>
      </div>
      <span class="small">â€» í‘œì—ì„œ ê°’ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥(UID/ë‚ ì§œ/ì‹œê°„/ì‹œë¦¬ì–¼). â€˜DB ë°˜ì˜â€™ ëˆŒëŸ¬ì•¼ ì €ì¥ë©ë‹ˆë‹¤.</span>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th class="chk"><input type="checkbox" id="chkAll"/></th>
            <th>ê³ ìœ ë²ˆí˜¸</th>
            <th>ë‚ ì§œ(YYYY.MM.DD)</th>
            <th>ì‹œê°„(HH:MM)</th>
            <th>ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- rows -->
        </tbody>
      </table>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="light" id="btnMakeMsg">ë©”ì‹œì§€ ìƒì„±</button>
      <button class="ghost" id="btnCopyMsg">ë³µì‚¬</button>
      <span class="small" id="msgInfo"></span>
    </div>
    <textarea id="messageBox" placeholder="â€˜ë©”ì‹œì§€ ìƒì„±â€™ ëˆ„ë¥´ë©´ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤."></textarea>
  </div>

  <!-- RIGHT: OCR -->
  <div class="pane right">
    <h2>ì¸ì¦ì„œ OCR ì—…ë¡œë“œ (ë¶™ì—¬ë„£ê¸°)</h2>

    <div class="ocr-box">
      <div class="ocr-left" id="ocrPreview"><span class="small">ì—¬ê¸°ì— ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ê¸°(Ctrl+V)</span></div>
      <div class="ocr-right">
        <div class="grid2">
          <div class="small">ì—”ì§„: <span class="pill">Google Vision (DOCUMENT_TEXT_DETECTION)</span></div>
          <button class="ghost" id="btnPickLang">ko / en</button>
          <button class="light" id="btnClearOcr">ì§€ìš°ê¸°</button>
          <button id="btnPushToTable">ì™¼ìª½ í‘œë¡œ ì¶”ê°€</button>
        </div>

        <!-- OCR ì›ë¬¸/íŒŒì‹± ë¡œê·¸ -->
        <textarea id="ocrLog" placeholder="OCR ì›ë¬¸ê³¼ íŒŒì‹± ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>

        <!-- íŒŒì‹±ëœ ê°’ ë±ƒì§€ -->
        <div class="row" style="margin:0">
          <div class="flex-gap">
            <span class="small">íŒŒì‹±ê°’</span>
            <span class="tag" id="p_date">date: -</span>
            <span class="tag" id="p_time">time: -</span>
            <span class="tag" id="p_serial">serial: -</span>
          </div>
          <span class="small" id="ocrInfo"></span>
        </div>

        <!-- â˜… ìˆ˜ë™ ì…ë ¥ ë¼ì¸(ì¶”ê°€) -->
        <div class="manual">
          <input id="m_date"  placeholder="YYYY.MM.DD (ì—†ìœ¼ë©´ ì§ì ‘ ì…ë ¥)"/>
          <input id="m_time"  placeholder="HH:MM (ì˜ˆ: 0:1 â†’ 00:01 ìë™ë³´ì •)"/>
          <input id="m_serial" placeholder="M-... (ì‹œë¦¬ì–¼)"/>
          <button class="light" id="btnUseParsed">íŒŒì‹±ê°’ ì±„ìš°ê¸°</button>
        </div>
        <span class="small">â€» íŒŒì‹±ì´ í‹€ë¦¬ê±°ë‚˜ ë¹„ì—ˆë‹¤ë©´ ìœ„ ì¹¸ì„ ì§ì ‘ ì±„ìš°ê³  â€˜ì™¼ìª½ í‘œë¡œ ì¶”ê°€â€™ë¥¼ ëˆ„ë¥´ì„¸ìš”.</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= í•˜ë“œì½”ë”© ì„¤ì • ========= */
const BASE_URL     = 'https://my-search-backend.onrender.com';
const API_SEARCH   = BASE_URL + '/admin/records';
const API_BULK     = BASE_URL + '/admin/records/bulk';
const ADMIN_TOKEN  = 'PHMsVsRmR1ONtsaI';

/* Google Vision */
const VISION_API_KEY = 'AIzaSyCVDnT8-FoaSFG3VJKRsz0O_g8XNpJWS-w';
const VISION_ENDPOINT = 'https://vision.googleapis.com/v1/images:annotate?key=' + encodeURIComponent((VISION_API_KEY||'').trim());
let VISION_LANG = ['ko','en'];

/* ========= ìƒíƒœ ========= */
const $ = (id)=>document.getElementById(id);
const state = {
  rows: [], baseById: {}, uid: '',
  ocr: {text:'', date:null, time:null, serial:null, imgUrl:null}
};

/* ========= ë„ìš°ë¯¸ ========= */
function esc(s){ return String(s==null?'':s); }
function pad2(n){ return String(n).padStart(2,'0'); }
function isYmd(s){ return /^\d{4}\.(0[1-9]|1[0-2])\.(0[1-9]|[12]\d|3[01])$/.test(s||''); }
function isHm(s){ return /^([01]\d|2[0-3]):[0-5]\d$/.test(s||''); }
function renderCountTag(){
  if(!state.rows.length){ $('countTag').style.display='none'; return; }
  $('countTag').style.display='inline-block';
  $('countTag').textContent = `${state.uid} Â· ${state.rows.length}ê±´`;
}

/* ========= í…Œì´ë¸” ë Œë” ========= */
function renderTable(){
  const tb = $('tbody'); tb.innerHTML='';
  for(const row of state.rows){
    const tr = document.createElement('tr');
    tr.dataset.id = row._id || '';

    const tdChk = document.createElement('td'); tdChk.className='chk';
    const ck = document.createElement('input'); ck.type='checkbox'; ck.className='rowchk';
    tdChk.appendChild(ck);

    function mkCell(key, width){
      const td = document.createElement('td');
      const ip = document.createElement('input');
      ip.value = esc(row[key]||'');
      ip.oninput = e => row[key] = e.target.value;
      if(width) ip.style.width = width;
      td.appendChild(ip);
      return td;
    }

    tr.appendChild(tdChk);
    tr.appendChild(mkCell('unique_id','140px'));
    tr.appendChild(mkCell('ë‚ ì§œ','130px'));
    tr.appendChild(mkCell('ì‹œê°„','100px'));
    tr.appendChild(mkCell('ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„','320px'));

    tb.appendChild(tr);
  }
  renderCountTag();
}

/* ========= ë¡œë“œ ========= */
async function loadUID(){
  const raw = ($('uidInput').value||'').trim(); if(!raw){ alert('ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const uid = raw.toUpperCase(); state.uid = uid;
  $('loadInfo').textContent = 'ë¡œë”© ì¤‘â€¦';

  const url = new URL(API_SEARCH);
  url.searchParams.set('unique_id', uid);
  const res = await fetch(url.toString(), { headers: {'X-Admin-Token': ADMIN_TOKEN} });
  const j = await res.json();
  if(!j.ok){ $('loadInfo').textContent = 'ì˜¤ë¥˜'; alert(j.error||'ì¡°íšŒ ì‹¤íŒ¨'); return; }

  state.rows = j.rows.map(r=>({ ...r }));
  state.baseById = {};
  for(const r of j.rows){ if(r._id) state.baseById[r._id]=JSON.parse(JSON.stringify(r)); }
  renderTable();
  $('loadInfo').textContent = 'ì™„ë£Œ';
  dispatchUIDSearched(uid);
}

/* ========= í–‰ ì¶”ê°€/ì‚­ì œ ========= */
function addRow(prefill={}){
  const row = {_id:null, unique_id:prefill.unique_id||state.uid||'', ë‚ ì§œ:prefill.ë‚ ì§œ||'', ì‹œê°„:prefill.ì‹œê°„||'', 'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„':prefill['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']||''};
  state.rows.push(row);
  renderTable();
}
function deleteSelectedLocally(){
  const ids = [];
  document.querySelectorAll('.rowchk:checked').forEach(ck=>{
    const tr = ck.closest('tr'); const id=tr?.dataset?.id||'';
    const idx = Array.from($('tbody').children).indexOf(tr);
    if(idx>=0){ state.rows.splice(idx,1); if(id) ids.push(id); }
  });
  renderTable();
  if(ids.length) $('loadInfo').textContent = `ì‚­ì œí‘œì‹œ ${ids.length}ê±´ (DB ë°˜ì˜ì‹œ ì‹¤ì œ ì‚­ì œ)`;
}

/* ========= DB ë°˜ì˜ ========= */
async function applyChanges(){
  if(!state.uid){ alert('ë¨¼ì € ê³ ìœ ë²ˆí˜¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
  const inserts=[], updates=[], deletes=[];
  const currentIds = new Set(state.rows.map(r=>r._id).filter(Boolean));
  for(const _id of Object.keys(state.baseById)){ if(!currentIds.has(_id)) deletes.push(_id); }

  for(const r of state.rows){
    const uid=(r.unique_id||'').trim().toUpperCase();
    const d=(r['ë‚ ì§œ']||'').trim();
    const t=(r['ì‹œê°„']||'').trim();
    const s=(r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']||'').trim();
    if(!uid || !d || !t || !s){ continue; }

    if(!r._id){ inserts.push({unique_id:uid,'ë‚ ì§œ':d,'ì‹œê°„':t,'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„':s}); }
    else{
      const base = state.baseById[r._id]||{};
      const payload = {};
      if(uid !== (base.unique_id||'')) payload.unique_id = uid;
      if(d   !== (base['ë‚ ì§œ']||''))   payload['ë‚ ì§œ'] = d;
      if(t   !== (base['ì‹œê°„']||''))   payload['ì‹œê°„'] = t;
      if(s   !== (base['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']||'')) payload['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']=s;
      if(Object.keys(payload).length) updates.push({_id:r._id, ...payload});
    }
  }

  if(!inserts.length && !updates.length && !deletes.length){ alert('ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

  $('loadInfo').textContent = 'DB ë°˜ì˜ ì¤‘â€¦';
  const res = await fetch(API_BULK, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Admin-Token':ADMIN_TOKEN},
    body: JSON.stringify({ insert: inserts, update: updates, delete: deletes })
  });
  const j = await res.json();
  if(!j.ok){ $('loadInfo').textContent='ì˜¤ë¥˜'; alert(j.error||'ë°˜ì˜ ì‹¤íŒ¨'); return; }

  $('loadInfo').textContent = `ë°˜ì˜ë¨: upsert ${j.upserts}, update ${j.modified}, delete ${j.deleted}`;
  loadUID().catch(()=>{});
}

/* ========= ë©”ì‹œì§€ ìƒì„± ========= */
function hmToMin(s){ const m=(s||'').match(/^(\d{1,2}):(\d{2})$/); if(!m) return null; const h=+m[1], mm=+m[2]; if(h>23||mm>59) return null; return h*60+mm; }
function computeSummary(){
  const want = new Set(['2025.09.19','2025.09.20','2025.09.21','2025.09.22','2025.09.23','2025.09.24','2025.09.25']);
  const rows = state.rows.filter(r=>want.has((r['ë‚ ì§œ']||'').trim()));
  let cnt={'2025.09.19':0,'2025.09.20':0,'2025.09.21':0,'2025.09.22':0,'2025.09.23':0,'2025.09.24':0}, first25=0, live=0;
  for(const r of rows){
    const d=(r['ë‚ ì§œ']||'').trim(); const t=(r['ì‹œê°„']||'').trim();
    if(d==='2025.09.25'){ const m=hmToMin(t); if(m!=null){ if(m<=599) first25++; else if(m>=720) live++; } }
    else if(cnt.hasOwnProperty(d)){ cnt[d]++; }
  }
  const preTotal=Object.values(cnt).reduce((a,b)=>a+b,0)+first25;
  const perfect=Object.values(cnt).every(v=>v>0)&&first25>0;
  return {...cnt, first25, live, preTotal, perfect};
}
function makeMessage(){
  const uid=state.uid||'ê³ ìœ ë²ˆí˜¸';
  const S=computeSummary(); const w=S.perfect?(S.live*8):S.live;
  const msg =
`ğŸ“¢ ${uid} ë‹˜, ìµœì¢… ì§‘ê³„ ì•ˆë‚´ì…ë‹ˆë‹¤.

âœ”ì „ì²´ íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­
(09.19 - 09.25)
19ì¼ - ${S['2025.09.19']}ê±´
20ì¼ - ${S['2025.09.20']}ê±´
21ì¼ - ${S['2025.09.21']}ê±´
22ì¼ - ${S['2025.09.22']}ê±´
23ì¼ - ${S['2025.09.23']}ê±´
24ì¼ - ${S['2025.09.24']}ê±´
25ì¼ ì‚¬ì „íˆ¬í‘œ - ${S.first25}ê±´
25ì¼ ìƒë°©íˆ¬í‘œ - ${S.live}ê±´

ğŸ€ ì‚¬ì „ íˆ¬í‘œê¸°ê°„ ì´ ëˆ„ì íˆ¬í‘œìˆ˜ : ${S.preTotal}ê±´
(ìƒë°© íˆ¬í‘œëŠ” ëˆ„ì íˆ¬í‘œìˆ˜ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

${uid} ë‹˜ì€ ${S.perfect ? 'ê°œê·¼ì— í•´ë‹¹ë©ë‹ˆë‹¤.' : 'ê°œê·¼ì— í•´ë‹¹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}
ê°œê·¼ì€ 19ì¼ íˆ¬í‘œë¶€í„° 25ì¼ ì˜¤ì „ íˆ¬í‘œê¹Œì§€ ëª¨ë‘ í•´ì£¼ì‹  ë¶„ë“¤ë§Œ í•´ë‹¹ë©ë‹ˆë‹¤.

25ì¼ ìƒë°© íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­ì€ ${S.live}ê±´ì…ë‹ˆë‹¤.
ê°œê·¼ ì—¬ë¶€ì— ë”°ë¥¸ ìƒë°© ì´ë²¤íŠ¸ ì´ ê°€ì¤‘ì¹˜ëŠ” ${S.perfect ? `${S.live} â†’ 8Ã—${S.live} = ${w}` : `${w}`} ì…ë‹ˆë‹¤.

ì”¬ë¡±ì´ì—ê²Œ íˆ¬í‘œí•´ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤ğŸ˜º
ì›í™œí•œ ê²€ìˆ˜ë¥¼ ìœ„í•´ ë‹µì¥ì€ ë³´ë‚´ì§€ ë§ì•„ì£¼ì„¸ìš”ğŸ™

ëˆ„ë½ ë° ì •ì • ë¬¸ì˜ëŠ” ì´ê³³ì´ ì•„ë‹Œ ë¬¸ì˜ ì±„ë„ "í—ˆì”¬ë¡± ê°¤ëŸ¬ë¦¬ Q&A"ë¡œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ë°˜ë“œì‹œ ë¬¸ì˜ ì „ ë¬¸ì˜ ì±„ë„ í•˜ë‹¨ì˜ ì–‘ì‹ì„ ì°¸ê³ í•´ì„œ ë¬¸ì˜í•´ì£¼ì„¸ìš”ğŸ™
ë¬¸ì˜ ì±„ë„ ë§í¬ ğŸ“
http://pf.kakao.com/_cFxexcn`;
  $('messageBox').value = msg;
  $('msgInfo').textContent = 'ìƒì„± ì™„ë£Œ';
}
function copyMsg(){ const ta=$('messageBox'); ta.focus(); ta.select(); document.execCommand('copy'); $('msgInfo').textContent='ë³µì‚¬ë¨'; setTimeout(()=>$('msgInfo').textContent='',1200); }

/* ========= OCR: Google Vision ========= */
async function blobToBase64(blob){
  const arr = new Uint8Array(await blob.arrayBuffer());
  let bin=''; const CHUNK=0x8000;
  for(let i=0;i<arr.length;i+=CHUNK){ bin+=String.fromCharCode.apply(null, arr.subarray(i,i+CHUNK)); }
  return btoa(bin);
}
async function visionOCRFromBlob(blob){
  const content = await blobToBase64(blob);
  const body = { requests: [{ image:{ content }, features:[{type:'DOCUMENT_TEXT_DETECTION'}], imageContext:{ languageHints: VISION_LANG } }] };
  const resp = await fetch(VISION_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const raw = await resp.text(); let json=null; try{ json=JSON.parse(raw) }catch{}
  if(!resp.ok){ const ge=json?.error; throw new Error((ge?.message)||raw||`HTTP ${resp.status}`); }
  return json?.responses?.[0]?.fullTextAnnotation?.text
      || json?.responses?.[0]?.textAnnotations?.[0]?.description
      || '';
}

/* ì‹œê°„ í›„ë³´ ì¶”ì¶œ(ì½œë¡  ì•/ë’¤ ìˆ«ì 1~2ìë¦¬ â†’ HH:MM ë³´ì •) */
function extractTimesColon2(text){
  const out=new Set(); const s=String(text||'');
  for(let i=0;i<s.length;i++){
    if(s[i]!==':') continue;
    const preMatch = s.slice(Math.max(0,i-2), i).match(/\d{1,2}$/);
    const post = s.slice(i+1, i+3);
    if(!preMatch) continue;
    if(!/^\d{2}$/.test(post)) continue;
    const hh = parseInt(preMatch[0],10), mm = parseInt(post,10);
    if(hh>=0&&hh<=23 && mm>=0&&mm<=59) out.add(`${pad2(hh)}:${post}`);
  }
  return [...out];
}
function parseOCRText(allText){
  const text=String(allText||'');
  const dateRe=/\b20\d{2}\.(0[1-9]|1[0-2])\.(0[1-9]|[12]\d|3[01])\b/g;
  const serialRe=/No\.\s*(M-[A-Za-z0-9\-_]+)|\b(M-[A-Za-z0-9\-_]+)\b/g;
  const uniq=a=>[...new Set(a)];
  const dates = uniq([...text.matchAll(dateRe)].map(m=>m[0]));
  const times = extractTimesColon2(text);
  const ser   = uniq([...text.matchAll(serialRe)].map(m=>m[1]||m[2]).filter(Boolean));
  return {dates, times, serials:ser};
}
function setParsedBadges(p){
  $('p_date').textContent = 'date: ' + (p.dates[0]||'-');
  $('p_time').textContent = 'time: ' + (p.times[0]||'-');
  $('p_serial').textContent= 'serial: ' + (p.serials[0]||'-');
}

/* ë¶™ì—¬ë„£ê¸° í•¸ë“¤ëŸ¬ */
document.addEventListener('paste', async (e)=>{
  const cd = e.clipboardData || window.clipboardData;
  let file=null;
  if(cd?.items){ for(const it of cd.items){ if(it.type?.startsWith('image/')){ file = it.getAsFile?.(); break; } } }
  if(!file && cd?.files?.length){ const f=cd.files[0]; if(f.type?.startsWith('image/')) file=f; }
  if(!file) return;

  e.preventDefault();
  const url = URL.createObjectURL(file); state.ocr.imgUrl=url;
  $('ocrPreview').innerHTML = `<img src="${url}">`;
  $('ocrInfo').textContent = 'OCR ì²˜ë¦¬ ì¤‘â€¦';

  try{
    const fullText = await visionOCRFromBlob(file);
    const raw = fullText.trim();
    const parsed = parseOCRText(raw);

    $('ocrLog').value = `ã€RAWã€‘\n${raw}\n\nã€PARSEDã€‘\në‚ ì§œ: ${parsed.dates.join(', ')||'-'}\nì‹œê°„: ${parsed.times.join(', ')||'-'}\nì‹œë¦¬ì–¼: ${parsed.serials.join(', ')||'-'}`;
    setParsedBadges(parsed);

    // ê¸°ë³¸ê°’ ì €ì¥ + ìˆ˜ë™ ì…ë ¥ì¹¸ì— ì±„ìš°ê¸°
    state.ocr.text = raw;
    state.ocr.date = parsed.dates[0] || '';
    state.ocr.time = parsed.times[0] || '';
    state.ocr.serial = parsed.serials[0] || '';

    $('m_date').value  = state.ocr.date;
    $('m_time').value  = state.ocr.time;
    $('m_serial').value= state.ocr.serial;

    $('ocrInfo').textContent = 'ì™„ë£Œ. ê°’ì´ ë¹„ê±°ë‚˜ í‹€ë¦¬ë©´ ì•„ë˜ ì¹¸ì„ ìˆ˜ì • í›„ [ì™¼ìª½ í‘œë¡œ ì¶”ê°€]ë¥¼ ëˆ„ë¥´ì„¸ìš”.';
  }catch(err){
    $('ocrInfo').innerHTML = `<span class="err">${esc(err.message||String(err))}</span>`;
  }
}, {capture:true});

/* íŒŒì‹±ê°’ ì±„ìš°ê¸°(ë²„íŠ¼) */
$('btnUseParsed').onclick = ()=>{
  $('m_date').value  = state.ocr.date || '';
  $('m_time').value  = state.ocr.time || '';
  $('m_serial').value= state.ocr.serial || '';
};

/* ì‹œê°„ ë³´ì •: "H:M" / "H:MM" / "HH:M" â†’ "HH:MM" */
function normalizeHm(s){
  const m = String(s||'').trim().match(/^(\d{1,2})\s*[:ì‹œ]\s*(\d{1,2})$/);
  if(!m) return null;
  let h=+m[1], mm=+m[2];
  if(h<0||h>23||mm<0||mm>59) return null;
  return `${pad2(h)}:${pad2(mm)}`;
}

/* OCR â†’ í…Œì´ë¸”ë¡œ ì¶”ê°€ (ìˆ˜ë™ ì…ë ¥ ì§€ì›) */
function pushOcrToTable(){
  const uid = (state.uid||'').trim().toUpperCase();
  if(!uid){ alert('ë¨¼ì € ì™¼ìª½ì—ì„œ ê³ ìœ ë²ˆí˜¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }

  let d = $('m_date').value.trim() || state.ocr.date || '';
  let t = $('m_time').value.trim() || state.ocr.time || '';
  let s = $('m_serial').value.trim() || state.ocr.serial || '';

  // ë‚ ì§œ/ì‹œê°„ ìµœì¢… ê²€ì¦ + ë³´ì •
  if(!isYmd(d)){ alert('ë‚ ì§œë¥¼ YYYY.MM.DD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const tFix = normalizeHm(t);
  if(!tFix){ alert('ì‹œê°„ì„ HH:MM í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: 0:1 â†’ 00:01)'); return; }
  t = tFix;
  if(!s){ alert('ì‹œë¦¬ì–¼(M-...)ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  addRow({unique_id:uid,'ë‚ ì§œ':d,'ì‹œê°„':t,'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„':s});
  $('ocrInfo').innerHTML = `<span class="ok">ì™¼ìª½ í‘œì— 1í–‰ ì¶”ê°€ë¨</span>`;
}

/* ìœ í‹¸: ì „ì²´ ì„ íƒ */
$('chkAll').addEventListener('change', e=>{
  document.querySelectorAll('.rowchk').forEach(c=>c.checked=e.target.checked);
});

/* ë²„íŠ¼ ë°”ì¸ë”© */
$('btnLoad').onclick = loadUID;
$('btnAddRow').onclick = ()=>addRow({unique_id:state.uid});
$('btnDeleteSel').onclick = deleteSelectedLocally;
$('btnApply').onclick = applyChanges;
$('btnMakeMsg').onclick = makeMessage;
$('btnCopyMsg').onclick = copyMsg;
$('btnPushToTable').onclick = pushOcrToTable;
$('btnClearOcr').onclick = ()=>{
  state.ocr={text:'',date:'',time:'',serial:'',imgUrl:null};
  $('ocrPreview').innerHTML = `<span class="small">ì—¬ê¸°ì— ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ê¸°(Ctrl+V)</span>`;
  $('ocrLog').value=''; setParsedBadges({dates:[],times:[],serials:[]}); $('ocrInfo').textContent='';
  $('m_date').value=''; $('m_time').value=''; $('m_serial').value='';
};
$('btnPickLang').onclick = ()=>{
  VISION_LANG = (VISION_LANG[0]==='ko') ? ['en','ko'] : ['ko','en'];
  $('btnPickLang').textContent = VISION_LANG.join(' / ');
};

/* ë¸Œë¡œë“œìºìŠ¤íŠ¸(ì—°ë™ ëŒ€ë¹„) */
function dispatchUIDSearched(uid){
  window.dispatchEvent(new CustomEvent('uidSearched',{detail:{uid}}));
}

/* ì´ˆê¸° í¬ì»¤ìŠ¤ */
$('uidInput').focus();
</script>
</body>
</html>
