<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì´ë²¤íŠ¸ ë°ì´í„° ì¡°íšŒ + Vision OCR ì—…ë¡œë“œ</title>
  <style>
:root{--blue:#1f6feb;--border:#e5e7eb}
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;margin:0;padding:16px;background:#f4f7f9;color:#333}
.page{display:flex;gap:24px;align-items:flex-start;max-width:1200px;margin:0 auto}
.left,.right{flex:1 1 0}
.card{background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:16px}
h1{margin:0 0 12px;color:#2c3e50;font-size:22px}
h2{margin:0 0 10px;font-size:18px;color:#2c3e50}
.row{display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:10px}
input,select,textarea{padding:10px;font-size:14px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
.btn{padding:10px 14px;background:#3498db;color:#fff;border:0;border-radius:8px;cursor:pointer}
.btn:disabled{opacity:.6;cursor:default}
.btn:hover{background:#2980b9}
.meta{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-top:6px;color:#666;font-size:13px;gap:8px}
.pill{background:#eef6ff;color:#1f6feb;border:1px solid #d0e7ff;border-radius:999px;padding:4px 10px;font-size:12px}
.error{color:#d91e18}
.center{text-align:center}
.strong{font-weight:600}
.table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;min-width:640px}
th,td{border:1px solid #eee;padding:10px;text-align:left;white-space:nowrap}
th{background:#f6f8fa}
tr:nth-child(even){background:#fafafa}
.ocrDrop{border:2px dashed var(--border);border-radius:10px;background:#f9fafb;padding:12px;min-height:64px;display:flex;align-items:center;gap:8px}
.ocrDrop.k{border-color:#93c5fd;background:#eff6ff}
.log{height:200px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;background:#fcfcfd;font-family:ui-monospace, Menlo, Consolas, monospace;font-size:12px;white-space:pre-wrap}
.preview{max-width:220px;border-radius:8px;border:1px solid var(--border)}
.help{font-size:12px;color:#666}
.kv{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
@media (max-width:1024px){.page{flex-direction:column}}
  </style>
</head>
<body>
<div class="page">
  <!-- ì™¼ìª½: ê²€ìƒ‰/ìš”ì•½/ìƒì„¸/ë©”ì‹œì§€ -->
  <div class="left">
    <div class="card">
      <h1>ì´ë²¤íŠ¸ ë°ì´í„° ì¡°íšŒ</h1>
      <div class="row">
        <input id="uidInput" placeholder="ê³ ìœ ë²ˆí˜¸(unique_id) â€” ì˜ˆ: AA0001 (ëŒ€ë¬¸ì ê¶Œì¥)"/>
        <div class="kv">
          <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
          <span class="pill">í˜ì´ì§€</span>
          <button class="btn" id="prevBtn">â—€</button>
          <span class="pill" id="pageInfo">1</span>
          <button class="btn" id="nextBtn">â–¶</button>
          <select id="limitSel">
            <option>50</option><option>100</option><option>200</option>
            <option selected>500</option><option>1000</option>
          </select>
        </div>
      </div>

      <div class="meta">
        <div id="loader" style="display:none">ì¡°íšŒ ì¤‘â€¦ <span id="timer">0.0</span>s</div>
        <div class="kv">
          <span class="pill">ì‚¬ì „: 2025.09.19~24</span>
          <span class="pill">9/25 1ì°¨ â‰¤ 09:59</span>
          <span class="pill">ìƒë°© â‰¥ 12:00</span>
        </div>
      </div>

      <div id="uidSummary" class="table-wrap" style="margin-top:8px"></div>
      <div id="uidEditable" class="table-wrap" style="margin-top:8px"></div>
      <div id="uidDetails" class="table-wrap" style="margin-top:8px"></div>

      <div style="margin-top:14px">
        <h2>ìµœì¢… ì•ˆë‚´ ë©”ì‹œì§€</h2>
        <div class="meta">
          <div id="msgInfo" class="pill">â€”</div>
          <div class="kv">
            <button class="btn" id="btnMakeMsg">ë©”ì‹œì§€ ìƒì„±</button>
            <button class="btn" id="btnCopyMsg">ë³µì‚¬</button>
          </div>
        </div>
        <textarea id="messageBox" rows="10" placeholder="ì—¬ê¸°ì— ìë™ ìƒì„±ë©ë‹ˆë‹¤."></textarea>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½: Vision OCR â†’ íŒŒì‹± â†’ DB ì—…ë°ì´íŠ¸ -->
  <div class="right">
    <div class="card">
      <h2>ì¸ì¦ì„œ OCR ì—…ë¡œë“œ (ë¶™ì—¬ë„£ê¸°)</h2>
      <div class="help">í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ë¥¼ <b>ë¶™ì—¬ë„£ê¸°(Ctrl/Cmd+V)</b> í•˜ì„¸ìš”. (íŒŒì¼ ì„ íƒ X)</div>

      <div id="drop" class="ocrDrop" title="ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°">
        <img id="preview" class="preview" alt=""/>
        <div>
          <div class="help" id="ocrHint">ëŒ€ê¸° ì¤‘â€¦</div>
          <div class="kv" style="margin-top:6px">
            <span class="pill">OCR: Google Vision</span>
            <span class="pill">DOCUMENT_TEXT_DETECTION</span>
            <span class="pill">ko / en</span>
          </div>
        </div>
      </div>

      <div style="margin-top:10px" class="kv">
        <button class="btn" id="btnApply" disabled>DB ë°˜ì˜(ì—…ë¡œë“œ)</button>
        <span id="applyInfo" class="pill" style="display:none"></span>
      </div>

      <div style="margin-top:10px">
        <h3 style="margin:0 0 6px">OCR ì›ë¬¸ / íŒŒì‹± ë¡œê·¸</h3>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* =============== ì„¤ì • (ì´ 3ê°€ì§€ë§Œ ë°”ê¾¸ì„¸ìš”) =============== */
const BASE_URL     = 'https://my-search-backend.onrender.com'; // ë°±ì—”ë“œ
const ADMIN_TOKEN  = 'PASTE_ADMIN_TOKEN_HERE';                  // ê´€ë¦¬ì í† í°(í”„ëŸ°íŠ¸ í•˜ë“œì½”ë”©)
const VISION_API_KEY = 'AIzaSyCVDnT8-FoaSFG3VJKRsz0O_g8XNpJWS-w'; // Google Vision API Key
/* ========================================================= */

/* ===== ë‚´ë¶€ ìƒìˆ˜/ì—”ë“œí¬ì¸íŠ¸ ===== */
const apiSearch = `${BASE_URL}/search`;
const apiBulk   = `${BASE_URL}/admin/records/bulk`;
const VISION_ENDPOINT = 'https://vision.googleapis.com/v1/images:annotate?key=' + encodeURIComponent((VISION_API_KEY||'').trim());

/* ===== ìƒíƒœ ===== */
let timerInterval;
const state = {
  page:1, limit:500,
  lastPageRows:[], lastAllRows:[],
  lastSummary:null,
  ocr:{ text:'', parsedRows:[], imageURL:null }
};

/* ===== ìœ í‹¸ ===== */
const qs = id => document.getElementById(id);
const escapeHtml = s => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
function startTimer(){let s=Date.now();qs('timer').textContent='0.0';qs('loader').style.display='block';timerInterval=setInterval(()=>{qs('timer').textContent=((Date.now()-s)/1000).toFixed(1)},100)}
function stopTimer(){clearInterval(timerInterval);qs('loader').style.display='none'}
function getDateRange(a,b){const to=(s)=>{const [Y,M,D]=s.split('.').map(Number);return new Date(Y,M-1,D)};const fmt=(d)=>`${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;const res=[];let cur=to(a),end=to(b);while(cur<=end){res.push(fmt(cur));cur.setDate(cur.getDate()+1)}return res}
const toMD = s => {const [_,m,d]=s.split('.');return `${Number(m)}/${Number(d)}`;}
function timeToMinutes(t){if(!t)return null;const s=String(t).trim();const am=s.match(/ì˜¤ì „|ì˜¤í›„|AM|PM/i);const cleaned=s.replace(/\s+/g,'');const m=cleaned.match(/(\d{1,2})[:ì‹œ](\d{2})/);if(!m)return null;let h=parseInt(m[1],10),mm=parseInt(m[2],10);if(am){if(/pm|ì˜¤í›„/i.test(am[0])&&h<12)h+=12; if(/am|ì˜¤ì „/i.test(am[0])&&h===12)h=0;} if(h<0||h>23||mm<0||mm>59)return null;return h*60+mm}

/* ===== ê²€ìƒ‰ ===== */
async function fetchRows(uid, page, limit){
  const u=new URL(apiSearch);
  u.searchParams.set('unique_id', uid);
  u.searchParams.set('page', page);
  u.searchParams.set('limit', Math.max(1, Math.min(limit, 1000)));
  const res=await fetch(u,{mode:'cors'});
  if(!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
  return await res.json();
}
async function doSearch(page=null){
  const idRaw=(qs('uidInput').value||'').trim();
  if(!idRaw){alert('ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const uid=idRaw.toUpperCase();
  state.page=page ?? state.page;
  state.limit=Number(qs('limitSel').value||500);
  qs('pageInfo').textContent=String(state.page);
  try{
    startTimer();
    const [pageRows, allRows]=await Promise.all([fetchRows(uid, state.page, state.limit), fetchRows(uid, 1, 1000)]);
    stopTimer();
    state.lastPageRows=pageRows; state.lastAllRows=allRows;
    renderAll();
    // ì±„íŒ… ì˜ì—­ ê°™ì€ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ê°€ ë“£ê³  ìˆìœ¼ë©´ ì•Œë¦¼
    window.dispatchEvent(new CustomEvent('uidSearched', { detail: { uid } }));
  }catch(e){
    stopTimer();
    qs('uidSummary').innerHTML=`<p class="error">ì˜¤ë¥˜: ${escapeHtml(e.message)}</p>`;
    qs('uidEditable').innerHTML=''; qs('uidDetails').innerHTML='';
  }
}

/* ===== ë Œë” ===== */
function renderAll(){
  const pageRows=state.lastPageRows||[];
  const allRows=state.lastAllRows||[];
  const rowsForSummary=allRows.length?allRows:pageRows;

  // ì¹´ìš´íŠ¸
  const df='2025.09.19', dt='2025.09.25', days=getDateRange(df,dt), day25='2025.09.25';
  const counts=Object.fromEntries(days.map(d=>[d,0])); let c25=0, live=0;
  rowsForSummary.forEach(r=>{
    const d=String(r['ë‚ ì§œ']||'').trim(), t=String(r['ì‹œê°„']||'').trim();
    if(!d || !(d in counts)) return;
    if(d===day25){const m=timeToMinutes(t); if(m!==null){ if(m<=9*60+59)c25++; else if(m>=12*60)live++; }}
    else counts[d]++
  });

  // ìš”ì•½
  const hdr=[],keys=[];
  days.forEach(d=>{ if(d===day25){hdr.push('9/25(1ì°¨)');keys.push(d+'_f'); hdr.push('ìƒë°©');keys.push(d+'_l');} else {hdr.push(toMD(d));keys.push(d);} });
  const cells=keys.map(k=>k.endsWith('_f')?c25:k.endsWith('_l')?live:(counts[k]||0));
  let perfect=true; for(const d of days){ if(d===day25)continue; if((counts[d]||0)<1){perfect=false;break;} } if(c25<1)perfect=false;

  let summary='<table><thead><tr><th style="min-width:140px">ì°¸ì—¬ ìš”ì•½(ì›ë³¸)</th>';
  hdr.forEach(x=>summary+=`<th>${x}</th>`); summary+='</tr></thead><tbody>';
  summary+=`<tr><td>ê±´ìˆ˜</td>${cells.map(c=>`<td class="center">${c}</td>`).join('')}</tr>`;
  summary+=`<tr><td>ê°œê·¼(ì›ë³¸)</td><td colspan="${hdr.length}" class="center strong">${perfect?'o':'x'}</td></tr>`;
  summary+='</tbody></table>';
  qs('uidSummary').innerHTML=summary;

  // ìˆ˜ì • íŒ¨ë„(ìë™ ê³„ì‚° í‘œì‹œ)
  const v={'2025.09.19':counts['2025.09.19']||0,'2025.09.20':counts['2025.09.20']||0,'2025.09.21':counts['2025.09.21']||0,'2025.09.22':counts['2025.09.22']||0,'2025.09.23':counts['2025.09.23']||0,'2025.09.24':counts['2025.09.24']||0,'25_first':c25,'live':live};
  state.lastSummary=v;
  const k=v['2025.09.19']+v['2025.09.20']+v['2025.09.21']+v['2025.09.22']+v['2025.09.23']+v['2025.09.24']+v['25_first'];
  const n=v['live']; const weight=perfect?n*8:n;
  qs('uidEditable').innerHTML=`<div class="meta"><div class="pill">ì‚¬ì „ í•©ê³„: ${k}ê±´ Â· ìƒë°©: ${n}ê±´ Â· ê°œê·¼: ${perfect?'o':'x'} Â· ê°€ì¤‘ì¹˜: ${weight}</div><div class="help">* OCR ì—…ë¡œë“œ í›„ ìë™ ê°±ì‹ </div></div>`;

  // ìƒì„¸
  let detail='<table><thead><tr><th>ê³ ìœ ë²ˆí˜¸</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„</th></tr></thead><tbody>';
  pageRows.forEach(r=>{
    const s=r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„'] ?? r['ì¸ì¦ìƒ·ì‹œë¦¬ì–¼ë„˜ë²„'] ?? '';
    detail+=`<tr><td>${escapeHtml(r.unique_id||'')}</td><td>${escapeHtml(String(r['ë‚ ì§œ']||'').trim())}</td><td>${escapeHtml(String(r['ì‹œê°„']||'').trim())}</td><td>${escapeHtml(s)}</td></tr>`;
  });
  detail+='</tbody></table>'; qs('uidDetails').innerHTML=detail;

  qs('msgInfo').textContent=`ì‚¬ì „:${k} Â· ìƒë°©:${n} Â· ê°œê·¼:${perfect?'o':'x'} Â· ê°€ì¤‘ì¹˜:${weight}`;
}

/* ===== ë©”ì‹œì§€ ===== */
function generateMessage(){
  const uid=(qs('uidInput').value||'').trim().toUpperCase() || 'ê³ ìœ ë²ˆí˜¸';
  const v=state.lastSummary || {'2025.09.19':0,'2025.09.20':0,'2025.09.21':0,'2025.09.22':0,'2025.09.23':0,'2025.09.24':0,'25_first':0,'live':0};
  const a=v['2025.09.19'],b=v['2025.09.20'],c=v['2025.09.21'],d=v['2025.09.22'],e=v['2025.09.23'],f=v['2025.09.24'],g=v['25_first'],n=v['live'];
  const k=a+b+c+d+e+f+g; const perfect=[a,b,c,d,e,f].every(x=>x>=1)&&g>=1; const weight=perfect?n*8:n;
  const msg=
`ğŸ“¢ ${uid} ë‹˜, ìµœì¢… ì§‘ê³„ ì•ˆë‚´ì…ë‹ˆë‹¤.

âœ”ì „ì²´ íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­
(09.19 - 09.25)
19ì¼ - ${a}ê±´ 
20ì¼ - ${b}ê±´ 
21ì¼ - ${c}ê±´ 
22ì¼ - ${d}ê±´ 
23ì¼ - ${e}ê±´ 
24ì¼ - ${f}ê±´ 
25ì¼ ì‚¬ì „íˆ¬í‘œ - ${g}ê±´ 
25ì¼ ìƒë°©íˆ¬í‘œ - ${n}ê±´

ğŸ€ ì‚¬ì „ íˆ¬í‘œê¸°ê°„ ì´ ëˆ„ì íˆ¬í‘œìˆ˜ : ${k}ê±´ 
(ìƒë°© íˆ¬í‘œëŠ” ëˆ„ì íˆ¬í‘œìˆ˜ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

${uid} ë‹˜ì€ ${perfect?'ê°œê·¼ì— í•´ë‹¹ë©ë‹ˆë‹¤.':'ê°œê·¼ì— í•´ë‹¹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}
ê°œê·¼ì€ 19ì¼ íˆ¬í‘œë¶€í„° 25ì¼ ì˜¤ì „ íˆ¬í‘œê¹Œì§€ ëª¨ë‘ í•´ì£¼ì‹  ë¶„ë“¤ë§Œ í•´ë‹¹ë©ë‹ˆë‹¤.

25ì¼ ìƒë°© íˆ¬í‘œ ì°¸ì—¬ë‚´ì—­ì€ ${n}ê±´ì…ë‹ˆë‹¤.
ê°œê·¼ ì—¬ë¶€ì— ë”°ë¥¸ ìƒë°© ì´ë²¤íŠ¸ ì´ ê°€ì¤‘ì¹˜ëŠ” ${perfect?`${n}â†’ 8Ã—${n} = ${weight}`:`${weight}`} ì…ë‹ˆë‹¤.

ì”¬ë¡±ì´ì—ê²Œ íˆ¬í‘œí•´ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤ğŸ˜º
ì›í™œí•œ ê²€ìˆ˜ë¥¼ ìœ„í•´ ë‹µì¥ì€ ë³´ë‚´ì§€ ë§ì•„ì£¼ì„¸ìš”ğŸ™

ëˆ„ë½ ë° ì •ì • ë¬¸ì˜ëŠ” ì´ê³³ì´ ì•„ë‹Œ ë¬¸ì˜ ì±„ë„ "í—ˆì”¬ë¡± ê°¤ëŸ¬ë¦¬ Q&A"ë¡œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ë°˜ë“œì‹œ ë¬¸ì˜ ì „ ë¬¸ì˜ ì±„ë„ í•˜ë‹¨ì˜ ì–‘ì‹ì„ ì°¸ê³ í•´ì„œ ë¬¸ì˜í•´ì£¼ì„¸ìš”ğŸ™
ë¬¸ì˜ ì±„ë„ ë§í¬ ğŸ“ 
http://pf.kakao.com/_cFxexcn `;
  qs('messageBox').value=msg;
}
function copyMessage(){const ta=qs('messageBox');ta.select();ta.setSelectionRange(0,999999);document.execCommand('copy');const p=qs('msgInfo').textContent;qs('msgInfo').textContent='ë©”ì‹œì§€ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.';setTimeout(()=>qs('msgInfo').textContent=p,1500)}

/* ===== Vision OCR ===== */
async function blobToBase64(blob){
  const arr=new Uint8Array(await blob.arrayBuffer()); let bin=''; const CHUNK=0x8000;
  for(let i=0;i<arr.length;i+=CHUNK){bin+=String.fromCharCode.apply(null, arr.subarray(i,i+CHUNK));}
  return btoa(bin);
}
async function visionOCRFromBlob(blob){
  const content=await blobToBase64(blob);
  const body={requests:[{image:{content},features:[{type:'DOCUMENT_TEXT_DETECTION'}],imageContext:{languageHints:['en','ko']}}]};
  let resp, raw='', json=null;
  try{resp=await fetch(VISION_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});}catch(netErr){throw new Error(`ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨: ${String(netErr)}`);}
  try{raw=await resp.text(); json=raw?JSON.parse(raw):null;}catch{json=null;}
  if(!resp.ok){
    const gErr=json?.error, code=gErr?.code, status=gErr?.status, msg=gErr?.message||raw||`HTTP ${resp.status}`;
    throw new Error(`HTTP ${resp.status}${code?` / code ${code}`:''}${status?` (${status})`:''}\n${msg}`);
  }
  return json?.responses?.[0]?.fullTextAnnotation?.text
      || json?.responses?.[0]?.textAnnotations?.[0]?.description
      || '';
}

/* ===== ì‹œê°„ ì¶”ì¶œ(ì½œë¡  ê¸°ì¤€ 2ê¸€ì) â€“ ì‚¬ìš©ìì˜ ì»¤ìŠ¤í…€ ë¡œì§ ë°˜ì˜ ===== */
function extractTimesColon2(text){
  const out=new Set(), s=String(text||'');
  for(let i=0;i<s.length;i++){
    if(s[i]!==':') continue;
    const preMatch=s.slice(Math.max(0,i-2), i).match(/\d{1,2}$/);
    const post=s.slice(i+1, i+3);
    if(!preMatch) continue;
    const pre=preMatch[0];
    if(!/^\d{2}$/.test(post)) continue;
    let hh=parseInt(pre,10), mm=parseInt(post,10);
    if(hh>=0 && hh<=23 && mm>=0 && mm<=59) out.add(`${String(hh).padStart(2,'0')}:${post}`);
  }
  return [...out];
}

/* ===== ë¼ì¸ ê¸°ë°˜ íŒŒì„œ (DB ì—…ë¡œë“œìš©) =====
   í•œ ì¤„ì— ë‚ ì§œ/ì‹œê°„/ì‹œë¦¬ì–¼ì´ í•¨ê»˜ ìˆëŠ” ë¼ì¸ë§Œ rowsë¡œ ë§Œë“¦.
*/
function parseOCRTextToRows(allText){
  const text=String(allText||'');
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  // ë‚ ì§œ: 2025.09.19 / 2025-09-19 / 2025/09/19
  const dateRe=/20\d{2}[.\-\/](0[1-9]|1[0-2])[.\-\/](0[1-9]|[12]\d|3[01])/;
  // ì‹œê°„: ì½œë¡ 2ê¸€ì ê·œì¹™ê³¼ í˜¸í™˜(ì˜¤ì „/ì˜¤í›„/AM/PM í—ˆìš©)
  const timeRe=/((?:ì˜¤ì „|ì˜¤í›„|AM|PM)\s*)?(\d{1,2})[:ì‹œ](\d{2})/i;
  // ì‹œë¦¬ì–¼: ê³µë°±ì—†ëŠ” 6~32ì(ì˜ìˆ«ì/í•˜ì´í”ˆ/ë°‘ì¤„), ë˜ëŠ” 'No. M-...'
  const serialRe=/No\.\s*(M-[^\s]{1,30})|([A-Z0-9][A-Z0-9\-_]{5,32})/i;

  const rows=[];
  for(const ln of lines){
    const dM=ln.match(dateRe);
    const tM=ln.match(timeRe);
    const sM=ln.match(serialRe);
    if(!dM || !tM || !sM) continue;

    // ë‚ ì§œ ì •ê·œí™” â†’ YYYY.MM.DD
    const rawDate=dM[0].replaceAll('-', '.').replaceAll('/', '.');
    const [Y,M,D]=rawDate.split('.').map(x=>x.padStart(2,'0'));
    const date=[Y,M,D].join('.');

    // ì‹œê°„ ì •ê·œí™”
    let h=parseInt(tM[2],10), mm=tM[3], ampm=(tM[1]||'').toLowerCase();
    if(/pm|ì˜¤í›„/.test(ampm) && h<12) h+=12;
    if(/am|ì˜¤ì „/.test(ampm) && h===12) h=0;
    const time=`${String(h).padStart(2,'0')}:${mm}`;

    // ì‹œë¦¬ì–¼
    const serial = (sM[1] || sM[2] || '').toUpperCase();

    rows.push({'ë‚ ì§œ':date,'ì‹œê°„':time,'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„':serial});
  }

  // ì¤‘ë³µ ì œê±°(ë‚ ì§œ+ì‹œê°„+ì‹œë¦¬ì–¼)
  const seen=new Set(), uniq=[];
  for(const r of rows){
    const key=`${r['ë‚ ì§œ']}|${r['ì‹œê°„']}|${r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']}`;
    if(seen.has(key)) continue; seen.add(key); uniq.push(r);
  }
  return uniq;
}

/* ===== ë³´ì¡°: ì›ë³¸ í›„ë³´(ë¦¬ìŠ¤íŠ¸) ë¡œê¹… ===== */
function extractRawCandidates(text){
  const s=String(text||'');
  const dateLooseRe=/\b20\d{2}\.(?:0?[1-9]|1[0-2])\.(?:0?[1-9]|[12]\d|3[01])\b/g;
  const timeLooseRe=/(?<!\d)(\d{1,2}):(\d{1,2})(?!\d)/g;
  const serialLooseRe=/No\.\s*(M-[^\s]{1,30})|([A-Z0-9][A-Z0-9\-_]{5,32})/g;
  const uniq=a=>[...new Set(a)];
  const dates=uniq([...s.matchAll(dateLooseRe)].map(m=>m[0]));
  const times=uniq(extractTimesColon2(s));
  const serials=uniq([...s.matchAll(serialLooseRe)].map(m=>m[1]||m[2]).filter(Boolean));
  return {dates,times,serials};
}

/* ===== DB ë°˜ì˜ ===== */
async function applyToDB(uid, parsedRows){
  if(!uid) throw new Error('ê³ ìœ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
  if(!parsedRows.length) throw new Error('ì—…ë¡œë“œí•  í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
  const inserts=parsedRows.map(r=>({unique_id:uid,'ë‚ ì§œ':r['ë‚ ì§œ'],'ì‹œê°„':r['ì‹œê°„'],'ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„':r['ì¸ì¦ìƒ· ì‹œë¦¬ì–¼ë„˜ë²„']}));
  const body=JSON.stringify({insert:inserts,update:[],delete:[]});
  const res=await fetch(apiBulk+'?token='+encodeURIComponent(ADMIN_TOKEN),{
    method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':ADMIN_TOKEN},body
  });
  if(!res.ok){const t=await res.text().catch(()=> ''); throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨: HTTP '+res.status+' '+t);}
  return await res.json();
}

/* ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
qs('btnSearch').addEventListener('click', ()=>doSearch(1));
qs('prevBtn').addEventListener('click', ()=>{ if(state.page>1) doSearch(state.page-1); });
qs('nextBtn').addEventListener('click', ()=>{ doSearch(state.page+1); });
qs('limitSel').addEventListener('change', ()=>{ state.page=1; doSearch(1); });
qs('uidInput').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(1); });
qs('btnMakeMsg').addEventListener('click', generateMessage);
qs('btnCopyMsg').addEventListener('click', copyMessage);

qs('btnApply').addEventListener('click', async ()=>{
  const uid=(qs('uidInput').value||'').trim().toUpperCase();
  if(!uid){alert('ì¢Œì¸¡ ìƒë‹¨ì— ê³ ìœ ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(!state.ocr.parsedRows.length){alert('ì—…ë¡œë“œí•  í–‰ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ì–´ OCRì„ ìˆ˜í–‰í•˜ì„¸ìš”.');return;}
  qs('btnApply').disabled=true; qs('applyInfo').style.display='inline-block'; qs('applyInfo').textContent='ì—…ë¡œë“œ ì¤‘â€¦';
  try{
    const r=await applyToDB(uid, state.ocr.parsedRows);
    qs('applyInfo').textContent=`ë°˜ì˜ OK Â· upserts:${r.upserts} modified:${r.modified} matched:${r.matched} deleted:${r.deleted}`;
    await doSearch(1);
    generateMessage();
  }catch(e){
    qs('applyInfo').textContent='ì˜¤ë¥˜: '+(e?.message||String(e)); qs('applyInfo').classList.add('error');
  }finally{ qs('btnApply').disabled=false; }
});

/* ===== ë¶™ì—¬ë„£ê¸° í•¸ë“¤ëŸ¬ ===== */
window.addEventListener('paste', async (e)=>{
  const cd=e.clipboardData||window.clipboardData;
  const items=cd?.items?Array.from(cd.items):[]; const files=cd?.files?Array.from(cd.files):[];
  let file=null;
  for(const it of items){ if(it.type?.startsWith('image/')){ file=it.getAsFile?.(); if(file)break; } }
  if(!file){ for(const f of files){ if(f?.type?.startsWith?.('image/')){file=f;break;} } }
  if(!file) return;  // í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°ëŠ” ë¬´ì‹œ

  e.preventDefault();
  // í”„ë¦¬ë·°
  const url=URL.createObjectURL(file);
  qs('preview').src=url; qs('ocrHint').textContent='Vision OCR ì²˜ë¦¬ ì¤‘â€¦'; qs('drop').classList.add('k');
  state.ocr.text=''; state.ocr.parsedRows=[]; qs('log').textContent='';

  try{
    const fullText=await visionOCRFromBlob(file);
    state.ocr.text=fullText;
    // ì›ë³¸ í›„ë³´ ë¡œê·¸
    const raw=extractRawCandidates(fullText);
    const rawText=`ã€ì›ë³¸ ì¶”ì¶œê°’ã€‘
ë‚ ì§œ: ${raw.dates.join(', ')||'-'}
ì‹œê°„: ${raw.times.join(', ')||'-'}
ì‹œë¦¬ì–¼: ${raw.serials.join(', ')||'-'}

------ OCR RAW ------
${fullText}`;
    qs('log').textContent=rawText;

    // DB ì—…ë¡œë“œìš© ë¼ì¸ íŒŒì‹±
    const parsed=parseOCRTextToRows(fullText);
    state.ocr.parsedRows=parsed;

    if(parsed.length){
      qs('applyInfo').style.display='inline-block';
      qs('applyInfo').textContent=`íŒŒì‹± ${parsed.length}ê±´ ì¤€ë¹„ë¨`;
      qs('btnApply').disabled=false;
      qs('ocrHint').textContent='ì¸ì‹ ì™„ë£Œ. "DB ë°˜ì˜"ì„ ëˆ„ë¥´ì„¸ìš”.';
    }else{
      qs('applyInfo').style.display='inline-block';
      qs('applyInfo').textContent='íŒŒì‹± ê²°ê³¼ 0ê±´ (ë¼ì¸ì— ë‚ ì§œÂ·ì‹œê°„Â·ì‹œë¦¬ì–¼ì´ í•¨ê»˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)';
      qs('btnApply').disabled=true;
      qs('ocrHint').textContent='íŒ¨í„´ ë¯¸ì¼ì¹˜';
    }
  }catch(err){
    qs('ocrHint').textContent='OCR ì‹¤íŒ¨: '+(err?.message||String(err));
    qs('btnApply').disabled=true;
    qs('log').textContent='[OCR ERROR]\n'+(err?.stack||String(err));
  }finally{
    setTimeout(()=>{qs('drop').classList.remove('k')}, 600);
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
  }
});

/* ===== URL ?uid=AA0001 â†’ ìë™ ì¡°íšŒ ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const p=new URLSearchParams(location.search); const uid=p.get('uid');
  if(uid){ qs('uidInput').value=decodeURIComponent(uid).toUpperCase(); doSearch(1); }
});
</script>
</body>
</html>
