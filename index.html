<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>이벤트 데이터 조회</title>
  <style>
/* 바디/컨테이너 */
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;margin:0;padding:16px;background:#f4f7f9;color:#333}
.container{max-width:1100px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06)}

/* 제목/탭 */
h1{margin:0 0 12px;color:#2c3e50;font-size:22px}
.tabs{display:flex;flex-wrap:wrap;border-bottom:1px solid #e5e7eb;margin-bottom:12px;gap:6px}
.tab{padding:10px 14px;cursor:pointer;border-radius:8px 8px 0 0;font-size:14px}
.tab.active{background:#eaf3ff;color:#1f6feb;border:1px solid #cfe3ff;border-bottom-color:#eaf3ff}
.tabpanel{display:none}
.tabpanel.active{display:block}

/* 입력행 */
.row{display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:12px}
input,select{padding:10px;font-size:14px;border:1px solid #d1d5db;border-radius:8px;width:100%}
.btn{padding:10px 14px;background:#3498db;color:#fff;border:0;border-radius:8px;cursor:pointer}
.btn:hover{background:#2980b9}
.meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px;color:#666;font-size:13px;gap:8px}
.tag{background:#eef6ff;color:#1f6feb;border:1px solid #d0e7ff;border-radius:999px;padding:4px 10px;font-size:12px}
.error{color:#d91e18}
.center{text-align:center}
.strong{font-weight:600}

/* 테이블 + 래퍼(가로 스크롤) */
.table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;min-width:640px}
th,td{border:1px solid #eee;padding:10px;text-align:left;white-space:nowrap}
th{background:#f6f8fa}
tr:nth-child(even){background:#fafafa}

/* 반응형 */
@media (max-width: 900px){
  .row{grid-template-columns:1fr;grid-auto-rows:auto}
}
@media (max-width: 600px){
  body{padding:10px}
  .container{margin:10px auto;padding:14px}
  h1{font-size:18px}
  .tab{font-size:13px}
  table{min-width:520px}
  input,select,.btn{font-size:15px;padding:12px}
}
  </style>
</head>
<body>
  <div class="container">
    <h1>이벤트 데이터 조회</h1>

    <div class="tabs">
      <div class="tab active" data-tab="uid">고유번호 검색</div>
      <div class="tab" data-tab="serial">시리얼 검색</div>
    </div>

    <!-- 고유번호 검색 탭 -->
    <div id="panel-uid" class="tabpanel active">
      <div class="row">
        <input id="uidInput" placeholder="고유번호(unique_id)" />
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" onclick="searchByUID()">검색</button>
          <span class="tag" id="pageInfo">page 1</span>
          <button class="btn" onclick="prevPage()">◀</button>
          <button class="btn" onclick="nextPage()">▶</button>
          <select id="limitSel" onchange="changeLimit()">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500" selected>500</option>
          </select>
        </div>
      </div>
      <div class="meta">
        <div id="loader" style="display:none">검색 중… <span id="timer">0.0</span>초</div>
      </div>
      <div id="uidResults"></div>
    </div>

    <!-- 시리얼 검색 탭 -->
    <div id="panel-serial" class="tabpanel">
      <div class="row" style="grid-template-columns:1fr 1fr 1fr auto;">
        <input id="serialInput" placeholder="시리얼번호 정확히 입력" />
        <input id="serialDateFrom" placeholder="시작일자 YYYY.MM.DD (선택)" />
        <input id="serialDateTo" placeholder="종료일자 YYYY.MM.DD (선택)" />
        <button class="btn" onclick="searchBySerial()">검색</button>
      </div>
      <div id="serialInfo" class="tag" style="display:none;"></div>
      <div id="serialResults"></div>
    </div>
  </div>

  <script>
/* ===== 설정 ===== */
const baseUrl   = 'https://my-search-backend.onrender.com'; // ← 백엔드 주소
const apiSearch = `${baseUrl}/search`;         // unique_id 검색 (배열 반환)
const apiSerial = `${baseUrl}/search-serial`;  // 시리얼 검색

/* ===== 상태/유틸 ===== */
let timerInterval;
let state = { page:1, limit:500, lastData:null };

function wrapTable(html){ return `<div class="table-wrap">${html}</div>`; }
function qs(id){ return document.getElementById(id); }
function escapeHtml(x){ return String(x).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
function startTimer(){ let s=Date.now(); qs('timer').textContent='0.0'; qs('loader').style.display='block'; timerInterval=setInterval(()=>{ qs('timer').textContent=((Date.now()-s)/1000).toFixed(1); },100);} 
function stopTimer(){ clearInterval(timerInterval); qs('loader').style.display='none'; }

// 날짜 배열
function getDateRange(startStr, endStr) {
  const toDate = (s) => { const [Y, M, D] = s.split('.').map(Number); return new Date(Y, M - 1, D); };
  const fmt = (d) => { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}.${m}.${day}`; };
  const res = []; let cur = toDate(startStr); const end = toDate(endStr);
  while (cur <= end) { res.push(fmt(cur)); cur.setDate(cur.getDate() + 1); }
  return res;
}
// "YYYY.MM.DD" → "M/D"
function toMD(dateStr) { const parts = dateStr.split('.').map(Number); return `${parts[1]}/${parts[2]}`; }

// 강화된 시간 파서: 오전/오후/AM/PM/HH:MM[:SS]/공백/한글 구분자 허용
function timeToMinutes(t) {
  if (!t) return null;
  const s = String(t).trim();
  const ampmMatch = s.match(/오전|오후|AM|PM/i);
  const ampm = ampmMatch ? ampmMatch[0].toLowerCase() : null;
  // "HH:MM[:SS]" 또는 "HH시MM분" 등
  const cleaned = s.replace(/\s+/g,'');
  const m = cleaned.match(/(\d{1,2})[:시](\d{1,2})/);
  if (!m) return null;
  let h = parseInt(m[1], 10);
  let mm = parseInt(m[2], 10);
  if (Number.isNaN(h) || Number.isNaN(mm)) return null;
  if (ampm) {
    const isPM = /pm|오후/i.test(ampm);
    const isAM = /am|오전/i.test(ampm);
    if (isPM && h < 12) h += 12;
    if (isAM && h === 12) h = 0;
  }
  if (h < 0 || h > 23 || mm < 0 || mm > 59) return null;
  return h * 60 + mm;
}

/* ===== 탭 전환 ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tabpanel').forEach(x=>x.classList.remove('active'));
    t.classList.add('active'); qs('panel-'+t.dataset.tab).classList.add('active');
  });
});

/* ===== 공통 페치 ===== */
async function fetchRows(uid, page, limit) {
  const safeLimit = Math.max(1, Math.min(limit, 500)); // 1~500
  const u = new URL(apiSearch);
  u.searchParams.set('unique_id', uid);
  u.searchParams.set('page', page);
  u.searchParams.set('limit', safeLimit);
  const res = await fetch(u, { mode:'cors' });
  if (!res.ok) throw new Error('서버 오류');
  return await res.json();
}

/* ===== 고유번호 검색 ===== */
async function searchByUID(page=null){
  const idRaw = qs('uidInput').value.trim();
  if(!idRaw){ alert('고유번호를 입력하세요.'); return; }
  const uid = idRaw.toUpperCase(); // 대문자 통일 검색

  state.page = page ?? state.page;
  qs('limitSel').value = String(state.limit);
  qs('pageInfo').textContent = `page ${state.page}`;

  try{
    startTimer();
    // 상세 표(현재 페이지) + 요약(전체 1페이지 500행)
    const [pageRows, allRows] = await Promise.all([
      fetchRows(uid, state.page, state.limit),
      fetchRows(uid, 1, 500) // UID당 최대 400이라 가정
    ]);
    stopTimer();
    state.lastData = pageRows;
    renderUIDTable(pageRows, allRows);
  }catch(e){
    stopTimer();
    qs('uidResults').innerHTML = `<p class="error">오류: ${escapeHtml(e.message)}</p>`;
  }
}

function prevPage(){ if(state.page>1) searchByUID(state.page-1); }
function nextPage(){ searchByUID(state.page+1); }
function changeLimit(){ state.limit = Number(qs('limitSel').value || 500); state.page=1; searchByUID(1); }
qs('uidInput').addEventListener('keydown',e=>{ if(e.key==='Enter') searchByUID(1); });

/* ===== 요약+상세 렌더 ===== */
function renderUIDTable(pageRows, allRows){
  const wrap = qs('uidResults');
  const rowsForSummary = (allRows && allRows.length) ? allRows : pageRows;
  if ((!pageRows || pageRows.length===0) && (!rowsForSummary || rowsForSummary.length===0)) {
    wrap.innerHTML = '<p>검색 결과가 없습니다.</p>'; 
    return;
  }

  // 1) 날짜 범위
  const df = '2025.09.19';
  const dt = '2025.09.25';
  const days = getDateRange(df, dt);
  const day25 = '2025.09.25';

  // 2) 날짜별 카운트 + 9/25 분리 (요약은 전체 rows 기준)
  const counts = Object.fromEntries(days.map(d => [d, 0]));
  let count25_first = 0; // 00:00~09:59
  let countLive     = 0; // 12:00~23:59

  rowsForSummary.forEach(r => {
    const d = String(r['날짜'] ?? '').trim();
    const t = String(r['시간'] ?? '').trim();
    if (!d || !counts.hasOwnProperty(d)) return;

    if (d === day25) {
      const mins = timeToMinutes(t);
      if (mins !== null) {
        if (mins <= 9*60 + 59)      count25_first += 1;   // 1차
        else if (mins >= 12*60)     countLive     += 1;   // 생방
        // 10:00~11:59는 요약 미집계(상세에는 그대로 표기)
      }
    } else {
      counts[d] += 1;
    }
  });

  // 3) 요약(원본) 표
  const headerLabels = [];
  const headerKeys   = [];
  days.forEach(d => {
    if (d === day25) {
      headerLabels.push('9/25(1차)'); headerKeys.push(d + '_first');
      headerLabels.push('생방');       headerKeys.push(d + '_live');
    } else {
      headerLabels.push(toMD(d));      headerKeys.push(d);
    }
  });
  const summaryCells = headerKeys.map(key => {
    if (key.endsWith('_first')) return count25_first;
    if (key.endsWith('_live'))  return countLive;
    return counts[key] ?? 0;
  });

  let perfectOriginal = true;
  for (const d of days) {
    if (d === day25) continue;
    if ((counts[d] || 0) < 1) { perfectOriginal = false; break; }
  }
  if (count25_first < 1) perfectOriginal = false;

  let summary = '<table><thead><tr><th style="min-width:110px">참여 요약(원본)</th>';
  headerLabels.forEach(lbl => { summary += `<th>${lbl}</th>`; });
  summary += '</tr></thead><tbody>';
  summary += `<tr><td>건수</td>${summaryCells.map(c => `<td class="center">${c}</td>`).join('')}</tr>`;
  summary += `<tr><td>개근(원본)</td><td colspan="${headerLabels.length}" class="center strong">${perfectOriginal ? 'o' : 'x'}</td></tr>`;
  summary += '</tbody></table>';

  // 4) 수정 가능한 패널
  const editableHTML = renderEditPanel({
    days, day25,
    baseCounts: counts,
    base25First: count25_first,
    baseLive: countLive
  });

  // 5) 상세 표(현재 페이지 rows)
  let detail = '<table style="margin-top:12px"><thead><tr>' +
    '<th>고유번호</th><th>날짜</th><th>시간</th><th>인증샷 시리얼넘버</th>' +
    '</tr></thead><tbody>';
  pageRows.forEach(r => {
    const serial = r['인증샷 시리얼넘버'] ?? r['인증샷시리얼넘버'] ?? '';
    detail += `<tr>
      <td>${escapeHtml(r.unique_id ?? '')}</td>
      <td>${escapeHtml(String(r['날짜'] ?? '').trim())}</td>
      <td>${escapeHtml(String(r['시간'] ?? '').trim())}</td>
      <td>${escapeHtml(serial)}</td>
    </tr>`;
  });
  detail += '</tbody></table>';

  wrap.innerHTML = wrapTable(summary) + wrapTable(editableHTML) + wrapTable(detail);
}

/* ===== 수정 가능한 집계 패널 + 메시지 ===== */
function renderEditPanel({ days, day25, baseCounts, base25First, baseLive }) {
  const targetDays = ['2025.09.19','2025.09.20','2025.09.21','2025.09.22','2025.09.23','2025.09.24'];
  const values = {};
  targetDays.forEach(d => { values[d] = (d in baseCounts) ? baseCounts[d] : 0; });
  const v25 = base25First || 0;
  const vLive = baseLive || 0;

  let html = `
  <div style="margin-top:16px">
    <h3 style="margin:6px 0 4px; color:#2c3e50;">값 수정 & 메시지 생성</h3>
    <table>
      <thead>
        <tr>
          <th>9/19</th><th>9/20</th><th>9/21</th><th>9/22</th><th>9/23</th><th>9/24</th>
          <th>9/25(1차)</th><th>생방</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          ${targetDays.map(d => `<td class="center"><input type="number" min="0" id="edit_${d}" value="${values[d]}" style="width:70px;text-align:center;"></td>`).join('')}
          <td class="center"><input type="number" min="0" id="edit_25_first" value="${v25}" style="width:90px;text-align:center;"></td>
          <td class="center"><input type="number" min="0" id="edit_live" value="${vLive}" style="width:90px;text-align:center;"></td>
        </tr>
      </tbody>
    </table>

    <div class="meta" style="margin-top:8px">
      <div id="editedInfo" class="tag">합계/개근 계산 중…</div>
      <div>
        <button class="btn" onclick="generateMessage()">메시지 생성</button>
        <button class="btn" onclick="copyMessage()">복사</button>
      </div>
    </div>

    <textarea id="messageBox" rows="10" style="width:100%; margin-top:8px; font-family:inherit;"></textarea>
  </div>`;

  // 렌더 후 이벤트 연결
  setTimeout(() => {
    [...targetDays.map(d=>`edit_${d}`), 'edit_25_first','edit_live'].forEach(id=>{
      const el = qs(id); if (el) el.addEventListener('input', updateEditedSummary);
    });
    updateEditedSummary(); // 최초 1회
  });

  return html;
}

function getEditedCounts() {
  const d = k => Math.max(0, Number(qs(k)?.value || 0) | 0);
  return {
    '2025.09.19': d('edit_2025.09.19'),
    '2025.09.20': d('edit_2025.09.20'),
    '2025.09.21': d('edit_2025.09.21'),
    '2025.09.22': d('edit_2025.09.22'),
    '2025.09.23': d('edit_2025.09.23'),
    '2025.09.24': d('edit_2025.09.24'),
    '25_first':   d('edit_25_first'),
    'live':       d('edit_live'),
  };
}

function updateEditedSummary() {
  const v = getEditedCounts();
  const k = v['2025.09.19'] + v['2025.09.20'] + v['2025.09.21'] +
            v['2025.09.22'] + v['2025.09.23'] + v['2025.09.24'] +
            v['25_first']; // 사전 누적
  const n = v['live'];     // 생방
  const perfect = [v['2025.09.19'],v['2025.09.20'],v['2025.09.21'],v['2025.09.22'],v['2025.09.23'],v['2025.09.24']].every(x=>x>=1) && v['25_first']>=1;
  const weight = perfect ? (n*8) : n;
  qs('editedInfo').textContent = `사전 합계: ${k}건 · 생방: ${n}건 · 개근: ${perfect ? 'o' : 'x'} · 가중치: ${weight}`;
}

function generateMessage() {
  const uid = (qs('uidInput').value || '').trim().toUpperCase();
  const v = getEditedCounts();
  const a=v['2025.09.19'], b=v['2025.09.20'], c=v['2025.09.21'],
        d=v['2025.09.22'], e=v['2025.09.23'], f=v['2025.09.24'],
        g=v['25_first'],   n=v['live'];
  const k = a+b+c+d+e+f+g;
  const perfect = [a,b,c,d,e,f].every(x=>x>=1) && g>=1;
  const weight = perfect ? (n*8) : n;

  const msg =
`고유번호 님, 최종 집계 안내 메시지입니다.

사전 투표 참여내역(09.19 - 09.25 오전)
19일 - ${a}건 
20일 - ${b}건 
21일 - ${c}건 
22일 - ${d}건 
23일 - ${e}건 
24일 - ${f}건 
25일 - ${g}건 
사전 투표기간 총 누적투표수 : ${k}건 
고유번호 님은 ${perfect ? '개근에 해당됩니다.' : '개근에 해당되지 않습니다.'}

생방 투표 참여내역은 ${n}건입니다.
개근 여부에 따른 생방 이벤트 총 가중치는 ${perfect ? `${n}→ 8×${n} = ${weight}` : `${weight}`} 입니다.`;

  qs('messageBox').value = msg.replaceAll('고유번호', uid || '고유번호');
}

function copyMessage(){
  const ta = qs('messageBox');
  ta.select(); ta.setSelectionRange(0, 99999);
  document.execCommand('copy');
  const prev = qs('editedInfo').textContent;
  qs('editedInfo').textContent = '메시지를 클립보드에 복사했습니다.';
  setTimeout(()=> qs('editedInfo').textContent = prev, 1500);
}

/* ===== 시리얼 검색 ===== */
async function searchBySerial(){
  const serial = qs('serialInput').value.trim();
  const df = qs('serialDateFrom').value.trim();
  const dt = qs('serialDateTo').value.trim();
  if(!serial){ alert('시리얼번호를 입력하세요.'); return; }
  const u = new URL(apiSerial);
  u.searchParams.set('serial', serial);
  if(df) u.searchParams.set('date_from', df);
  if(dt) u.searchParams.set('date_to', dt);
  qs('serialInfo').style.display='none';
  qs('serialResults').innerHTML = '조회 중…';
  try{
    const res = await fetch(u, {mode:'cors'});
    if(!res.ok) throw new Error('서버 오류');
    const arr = await res.json();
    renderSerial(arr);
    qs('serialInfo').textContent = `${serial} · ${arr.length}건`;
    qs('serialInfo').style.display='inline-block';
  }catch(e){
    qs('serialResults').innerHTML = `<p class="error">오류: ${escapeHtml(e.message)}</p>`;
  }
}

function renderSerial(rows){
  const div = qs('serialResults');
  if(!rows || rows.length===0){ div.innerHTML='<p>해당 시리얼번호로 조회된 결과가 없습니다.</p>'; return; }
  const byUID = {};
  rows.forEach(r=>{ const k = r.unique_id || '(unknown)'; (byUID[k] ||= []).push(r); });
  let html = '<table><thead><tr><th>고유번호</th><th>날짜·시간 목록</th></tr></thead><tbody>';
  Object.keys(byUID).sort().forEach(uid=>{
    const lines = byUID[uid].map(r=> `${escapeHtml((r['날짜']||'').trim())} ${escapeHtml((r['시간']||'').trim())}`).join('<br/>');
    html += `<tr><td>${escapeHtml(uid)}</td><td>${lines}</td></tr>`;
  });
  html += '</tbody></table>';
  div.innerHTML = wrapTable(html);
}

/* ===== URL ?uid=AA0001 → 자동 조회 ===== */
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);
  const uid = params.get('uid');
  if (uid) {
    const tabBtn = document.querySelector('.tab[data-tab="uid"]');
    if (tabBtn) tabBtn.click?.();
    const input = qs('uidInput');
    if (input) {
      input.value = decodeURIComponent(uid).toUpperCase();
      searchByUID(1);
    }
  }
});
  </script>
</body>
</html>
