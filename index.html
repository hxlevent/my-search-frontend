<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>이벤트 데이터 조회</title>
  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif; margin:0; padding:20px; background:#f4f7f9; color:#333; }
    .container { max-width: 1100px; margin: 40px auto; background:#fff; padding: 24px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 12px; color:#2c3e50; }
    .tabs { display:flex; border-bottom:1px solid #e5e7eb; margin-bottom:16px; gap:4px; }
    .tab { padding:10px 14px; cursor:pointer; border-radius:6px 6px 0 0; }
    .tab.active { background:#eaf3ff; color:#1f6feb; border:1px solid #cfe3ff; border-bottom-color:#eaf3ff; }
    .tabpanel { display:none; }
    .tabpanel.active { display:block; }
    .row { display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; margin-bottom:12px; }
    input, select { padding:10px; font-size:14px; border:1px solid #d1d5db; border-radius:6px; }
    .btn { padding:10px 14px; background:#3498db; color:#fff; border:0; border-radius:6px; cursor:pointer; }
    .btn:hover { background:#2980b9; }
    #loader { font-size:13px; color:#555; display:none; }
    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
    th, td { border:1px solid #eee; padding:10px; text-align:left; }
    th { background:#f6f8fa; }
    tr:nth-child(even){ background:#fafafa; }
    .meta { display:flex; justify-content:space-between; align-items:center; margin-top:8px; color:#666; font-size:13px; }
    .tag { background:#eef6ff; color:#1f6feb; border:1px solid #d0e7ff; border-radius:999px; padding:4px 10px; font-size:12px; }
    .error { color:#d91e18; }
    .center { text-align:center; }
    .strong { font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>이벤트 데이터 조회</h1>

    <div class="tabs">
      <div class="tab active" data-tab="uid">고유번호 검색</div>
      <div class="tab" data-tab="serial">시리얼 검색</div>
    </div>

    <!-- 고유번호 검색 탭 -->
    <div id="panel-uid" class="tabpanel active">
      <div class="row">
        <input id="uidInput" placeholder="고유번호(unique_id)" />
        <input id="uidDateFrom" placeholder="시작일자 YYYY.MM.DD (선택, 기본 2025.09.19)" />
        <input id="uidDateTo" placeholder="종료일자 YYYY.MM.DD (선택, 기본 2025.09.25)" />
        <button class="btn" onclick="searchByUID()">검색</button>
      </div>
      <div class="meta">
        <div id="loader">검색 중… <span id="timer">0.0</span>초</div>
        <div>
          <span class="tag" id="pageInfo">page 1</span>
          <button class="btn" onclick="prevPage()">◀</button>
          <button class="btn" onclick="nextPage()">▶</button>
          <select id="limitSel" onchange="changeLimit()">
            <option>50</option><option>100</option><option>200</option><option selected>200</option>
          </select>
        </div>
      </div>
      <div id="uidResults"></div>
    </div>

    <!-- 시리얼 검색 탭 (그대로 사용 가능) -->
    <div id="panel-serial" class="tabpanel">
      <div class="row">
        <input id="serialInput" placeholder="시리얼번호 정확히 입력" />
        <input id="serialDateFrom" placeholder="시작일자 YYYY.MM.DD (선택)" />
        <input id="serialDateTo" placeholder="종료일자 YYYY.MM.DD (선택)" />
        <button class="btn" onclick="searchBySerial()">검색</button>
      </div>
      <div id="serialInfo" class="tag" style="display:none;"></div>
      <div id="serialResults"></div>
    </div>
  </div>

  <script>
    /* ===== 환경설정 ===== */
    // ★ 여기만 네 백엔드 도메인으로 바꾸세요
    const baseUrl   = 'https://my-search-backend.onrender.com';
    const apiSearch = `${baseUrl}/search`;         // unique_id 검색 (배열 반환)
    const apiSerial = `${baseUrl}/search-serial`;  // 시리얼 검색

    /* ===== 공통 유틸 ===== */
    let timerInterval; 
    let state = { page:1, limit:200, lastData:null, dupData:[] };

    function qs(id){ return document.getElementById(id); }
    function escapeHtml(x){ return String(x).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
    function startTimer(){ let s=Date.now(); qs('timer').textContent='0.0'; qs('loader').style.display='block'; timerInterval=setInterval(()=>{ qs('timer').textContent=((Date.now()-s)/1000).toFixed(1); },100);} 
    function stopTimer(){ clearInterval(timerInterval); qs('loader').style.display='none'; }

    // 날짜 범위를 "YYYY.MM.DD" 배열로 생성
    function getDateRange(startStr, endStr) {
      const toDate = (s) => { const [Y, M, D] = s.split('.').map(Number); return new Date(Y, M - 1, D); };
      const fmt = (d) => { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}.${m}.${day}`; };
      const res = []; let cur = toDate(startStr); const end = toDate(endStr);
      while (cur <= end) { res.push(fmt(cur)); cur.setDate(cur.getDate() + 1); }
      return res;
    }
    // "YYYY.MM.DD" → "M/D"
    function toMD(dateStr) { const parts = dateStr.split('.').map(Number); return `${parts[1]}/${parts[2]}`; }
    // "H:MM"/"HH:MM" → 분
    function timeToMinutes(t) { if (!t) return null; const [h,m] = t.split(':').map(Number); if (Number.isNaN(h)||Number.isNaN(m)) return null; return h*60+m; }

    /* ===== 탭 전환 ===== */
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tabpanel').forEach(x=>x.classList.remove('active'));
        t.classList.add('active'); qs('panel-'+t.dataset.tab).classList.add('active');
      });
    });

    /* ===== 고유번호 검색 ===== */
    function buildUIDUrl(page=null){
      const u = new URL(apiSearch);
      const id = qs('uidInput').value.trim();
      const df = qs('uidDateFrom').value.trim();
      const dt = qs('uidDateTo').value.trim();
      if(!id){ alert('고유번호를 입력하세요.'); return null; }
      u.searchParams.set('unique_id', id); // 백엔드가 id/unique_id 둘 다 허용
      u.searchParams.set('page', page ?? state.page);
      u.searchParams.set('limit', state.limit);
      if(df) u.searchParams.set('date_from', df);
      if(dt) u.searchParams.set('date_to', dt);
      return u;
    }

    async function searchByUID(page=null){
      const url = buildUIDUrl(page); if(!url) return;
      state.page = Number(url.searchParams.get('page'));
      state.limit= Number(url.searchParams.get('limit'));
      qs('limitSel').value = String(state.limit);
      qs('pageInfo').textContent = `page ${state.page}`;

      try{
        startTimer();
        const res = await fetch(url, {mode:'cors'});
        if(!res.ok) throw new Error('서버 오류');
        const data = await res.json(); // 배열
        stopTimer(); state.lastData = data; renderUIDTable(data);
      }catch(e){
        stopTimer(); qs('uidResults').innerHTML = `<p class="error">오류: ${escapeHtml(e.message)}</p>`;
      }
    }

    function prevPage(){ if(state.page>1) searchByUID(state.page-1); }
    function nextPage(){ searchByUID(state.page+1); }
    function changeLimit(){ state.limit = Number(qs('limitSel').value || 200); state.page=1; searchByUID(1); }
    ['uidInput','uidDateFrom','uidDateTo'].forEach(id=>qs(id).addEventListener('keydown',e=>{ if(e.key==='Enter') searchByUID(1); }));

    // ★ 요약+상세 2단 테이블 렌더 (요구사항 반영: 25일 1차/생방 분리, 개근 o/x)
    function renderUIDTable(rows){
      const wrap = qs('uidResults');
      if (!rows || rows.length === 0) { wrap.innerHTML = '<p>검색 결과가 없습니다.</p>'; return; }

      // 1) 날짜 범위 (없으면 기본 9/19 ~ 9/25)
      const df = qs('uidDateFrom').value.trim() || '2025.09.19';
      const dt = qs('uidDateTo').value.trim()   || '2025.09.25';
      const days = getDateRange(df, dt);

      // 2) 날짜별 건수 + 9/25 특수 분리
      const counts = Object.fromEntries(days.map(d => [d, 0]));
      let count25_first = 0; // 00:00~09:59
      let countLive     = 0; // 12:00~23:59
      const day25 = days.find(d => d.endsWith('.09.25')); // 범위에 25일이 포함되면 분리

      rows.forEach(r => {
        const d = r['날짜']; const t = r['시간'];
        if (!d || !Object.prototype.hasOwnProperty.call(counts, d)) return;
        if (day25 && d === day25) {
          const mins = timeToMinutes(t);
          if (mins !== null) {
            if (mins <= 9*60 + 59)      count25_first += 1;  // 25일(1차)
            else if (mins >= 12*60)     countLive += 1;      // 생방
            // 10:00~11:59는 요약 미반영(상세엔 그대로)
          }
        } else {
          counts[d] += 1; // 일반 날짜 카운트
        }
      });

      // 3) 헤더: 9/19~24 + (25(1차), 생방)
      const headerLabels = [];
      const headerKeys   = [];
      days.forEach(d => {
        if (day25 && d === day25) {
          headerLabels.push(toMD(d) + '(1차)'); headerKeys.push(d + '_first');
          headerLabels.push('생방');            headerKeys.push(d + '_live');
        } else {
          headerLabels.push(toMD(d));           headerKeys.push(d);
        }
      });

      // 4) 셀 값
      const summaryCells = headerKeys.map(key => {
        if (key.endsWith('_first')) return count25_first;
        if (key.endsWith('_live'))  return countLive;
        return counts[key] ?? 0;
      });

      // 5) 개근: 19~24 모두 ≥1 && 25(1차) ≥1
      let perfect = true;
      const days_19_24 = days.filter(d => !(day25 && d === day25));
      for (const d of days_19_24) if ((counts[d] || 0) < 1) { perfect = false; break; }
      if (day25 && count25_first < 1) perfect = false;

      // 6) 요약 표
      let summary = '<table><thead><tr><th style="min-width:110px">참여 요약</th>';
      headerLabels.forEach(lbl => { summary += `<th>${lbl}</th>`; });
      summary += '</tr></thead><tbody>';
      summary += `<tr><td>건수</td>${summaryCells.map(c => `<td class="center">${c}</td>`).join('')}</tr>`;
      summary += `<tr><td>개근</td><td colspan="${headerLabels.length}" class="center strong">${perfect ? 'o' : 'x'}</td></tr>`;
      summary += '</tbody></table>';

      // 7) 상세 표
      let detail = '<table style="margin-top:12px"><thead><tr>' +
        '<th>고유번호</th><th>날짜</th><th>시간</th><th>인증샷 시리얼넘버</th>' +
        '</tr></thead><tbody>';
      rows.forEach(r => {
        const serial = r['인증샷 시리얼넘버'] ?? r['인증샷시리얼넘버'] ?? '';
        detail += `<tr>
          <td>${escapeHtml(r.unique_id ?? '')}</td>
          <td>${escapeHtml(r['날짜'] ?? '')}</td>
          <td>${escapeHtml(r['시간'] ?? '')}</td>
          <td>${escapeHtml(serial)}</td>
        </tr>`;
      });
      detail += '</tbody></table>';

      // 8) 렌더
      wrap.innerHTML = summary + detail;
    }

    /* ===== 시리얼 검색 (그대로) ===== */
    async function searchBySerial(){
      const serial = qs('serialInput').value.trim();
      const df = qs('serialDateFrom').value.trim();
      const dt = qs('serialDateTo').value.trim();
      if(!serial){ alert('시리얼번호를 입력하세요.'); return; }
      const u = new URL(apiSerial);
      u.searchParams.set('serial', serial);
      if(df) u.searchParams.set('date_from', df);
      if(dt) u.searchParams.set('date_to', dt);
      qs('serialInfo').style.display='none';
      qs('serialResults').innerHTML = '조회 중…';
      try{
        const res = await fetch(u, {mode:'cors'});
        if(!res.ok) throw new Error('서버 오류');
        const arr = await res.json();
        renderSerial(arr);
        qs('serialInfo').textContent = `${serial} · ${arr.length}건`;
        qs('serialInfo').style.display='inline-block';
      }catch(e){
        qs('serialResults').innerHTML = `<p class="error">오류: ${escapeHtml(e.message)}</p>`;
      }
    }

    function renderSerial(rows){
      const div = qs('serialResults');
      if(!rows || rows.length===0){ div.innerHTML='<p>해당 시리얼번호로 조회된 결과가 없습니다.</p>'; return; }
      const byUID = {};
      rows.forEach(r=>{ const k = r.unique_id || '(unknown)'; (byUID[k] ||= []).push(r); });
      let html = '<table><thead><tr><th>고유번호</th><th>날짜·시간 목록</th></tr></thead><tbody>';
      Object.keys(byUID).sort().forEach(uid=>{
        const lines = byUID[uid].map(r=> `${escapeHtml(r['날짜']||'')} ${escapeHtml(r['시간']||'')}`).join('<br/>');
        html += `<tr><td>${escapeHtml(uid)}</td><td>${lines}</td></tr>`;
      });
      html += '</tbody></table>';
      div.innerHTML = html;
    }
  </script>
</body>
</html>
