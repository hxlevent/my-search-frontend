<!doctype html>
<meta charset="utf-8" />
<title>관리자 요약 리스트</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#f6f7fb; margin:0; padding:24px;}
  .card{max-width:1200px; margin:0 auto; background:#fff; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:20px;}
  h1{margin:0 0 12px; font-size:20px}
  .row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
  input,button,select{font-size:14px; padding:10px; border:1px solid #d0d5dd; border-radius:8px}
  button{background:#2563eb; color:#fff; border:0; cursor:pointer}
  button:disabled{opacity:.5; cursor:not-allowed}
  table{width:100%; border-collapse:collapse; margin-top:10px; font-size:13px}
  th,td{border:1px solid #eef0f3; padding:8px; text-align:center}
  th{background:#f3f6fb}
  .meta{display:flex; justify-content:space-between; align-items:center; margin-top:8px; color:#555; font-size:12px}
  .tag{background:#eef6ff; color:#1f6feb; padding:4px 8px; border-radius:999px; border:1px solid #cde4ff}
</style>
<div class="card">
  <h1>관리자 요약 리스트</h1>
  <div class="row">
    <input id="token" type="password" placeholder="관리자 토큰" style="min-width:220px">
    <input id="q" placeholder="고유번호 prefix 검색 (예: AA)" />
    <select id="limit">
      <option value="50">50</option>
      <option value="100" selected>100</option>
      <option value="200">200</option>
      <option value="500">500</option>
    </select>
    <button onclick="load(1)">불러오기</button>
    <button onclick="exportCSV()">CSV 다운로드</button>
    <button onclick="showAll()">전체 보기</button>
    <button onclick="downloadAll()">전체 다운로드</button>


  </div>
  <div class="meta">
    <div id="stats" class="tag" style="display:none"></div>
    <div>
      <button onclick="prev()">◀</button>
      <span id="pageInfo" class="tag">page 1</span>
      <button onclick="next()">▶</button>
    </div>
  </div>
  <div id="wrap"></div>
</div>

<script>

const baseUrl = 'https://my-search-backend.onrender.com';   // ← 백엔드 주소
let curPage = 1, curRows = [], totalUnique = 0;

function qs(id){ return document.getElementById(id); }
function esc(s){ return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ① 페이지 최초 로드 시: 저장된 토큰 복구 → 자동 로드
document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('adminToken') || '';
  if (saved) {
    qs('token').value = saved;
    // 자동으로 전체 목록 1페이지 로딩
    showAll();
  }
});

// ② 토큰 입력 후 Enter로도 불러오기
qs('token').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') load(1);
});

// ③ 전체 보기: 검색어 비우고 1페이지 로딩
function showAll(){
  qs('q').value = '';
  load(1);
}

async function load(page){
  const t = qs('token').value.trim();
  if(!t){ alert('관리자 토큰을 입력하세요'); return; }
  localStorage.setItem('adminToken', t);      // 토큰 저장

  const q = qs('q').value.trim();             // 비어 있으면 전체
  const limit = qs('limit').value;

  const url = new URL(baseUrl + '/admin/summary');
  url.searchParams.set('token', t);
  url.searchParams.set('page', page);
  url.searchParams.set('limit', limit);
  if(q) url.searchParams.set('q', q);         // q가 비어 있으면 아예 안 붙여서 '전체' 요청

  qs('wrap').innerHTML = '로딩 중...';
  try{
    const res = await fetch(url);
    if(!res.ok){
      const txt = await res.text().catch(()=>String(res.status));
      qs('wrap').innerHTML = `<p style="color:#b91c1c">오류: ${res.status}<br>${esc(txt.slice(0,500))}</p>`;
      return;
    }
    const data = await res.json();
    if(!data.ok){
      qs('wrap').innerHTML = `<p style="color:#b91c1c">오류: ${esc(data.error||'unknown')}</p>`;
      return;
    }
    curPage = data.page; curRows = data.rows; totalUnique = data.total_unique ?? 0;
    renderTable(curRows);
    qs('pageInfo').textContent = `page ${curPage}`;
    qs('stats').textContent = `총 참가자: ${totalUnique||'-'}명 · 이 페이지: ${data.count}명`;
    qs('stats').style.display = 'inline-block';
  }catch(e){
    qs('wrap').innerHTML = `<p style="color:#b91c1c">오류: ${esc(e.message)}</p>`;
  }
}

function renderTable(rows){
  if(!rows || rows.length===0){ qs('wrap').innerHTML = '<p>데이터가 없습니다.</p>'; return; }
  let html = '<table><thead><tr>'+
    '<th>고유번호</th>'+
    '<th>9/19</th><th>9/20</th><th>9/21</th><th>9/22</th><th>9/23</th><th>9/24</th>'+
    '<th>9/25(1차)</th><th>생방</th>'+
    '<th>사전합계</th><th>개근</th>'+
    '</tr></thead><tbody>';
  rows.forEach(r=>{
    html += `<tr onclick="goDetail('${encodeURIComponent(r.unique_id)}')" style="cursor:pointer">
      <td style="text-align:left;padding-left:10px">${esc(r.unique_id)}</td>
      <td>${r.c19||0}</td><td>${r.c20||0}</td><td>${r.c21||0}</td>
      <td>${r.c22||0}</td><td>${r.c23||0}</td><td>${r.c24||0}</td>
      <td>${r.c25_first||0}</td><td>${r.c_live||0}</td>
      <td>${r.pre_total||0}</td>
      <td>${r.perfect ? 'O' : 'X'}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  qs('wrap').innerHTML = html;
}

// ✅ index.html로 이동하는 헬퍼
function goDetail(uidEnc){
  // admin-list.html과 index.html이 같은 폴더라면 ./index.html
  // 경로가 다르면 상대경로 맞춰서 바꿔줘.
  location.href = `./index.html?uid=${uidEnc}`;
}

function prev(){ if(curPage>1) load(curPage-1); }
function next(){ load(curPage+1); }

// 현재 페이지 CSV 다운로드
function exportCSV(){
  if(!curRows || curRows.length===0){ alert('데이터가 없습니다.'); return; }
  const header = ['unique_id','c19','c20','c21','c22','c23','c24','c25_first','c_live','pre_total','perfect'];
  const lines = [header.join(',')];
  curRows.forEach(r=>{
    lines.push([r.unique_id,r.c19||0,r.c20||0,r.c21||0,r.c22||0,r.c23||0,r.c24||0,r.c25_first||0,r.c_live||0,r.pre_total||0,(r.perfect?'O':'X')].join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `summary_page${curPage}.csv`;
  a.click();
}

function downloadAll(){
  const t = qs('token').value.trim();
  if(!t){ alert('관리자 토큰을 입력하세요'); return; }
  const q = qs('q').value.trim();
  const url = new URL(baseUrl + '/admin/summary-export');
  url.searchParams.set('token', t);
  if(q) url.searchParams.set('q', q);
  // 그냥 브라우저로 다운로드
  window.location.href = url.toString();
}


  
</script>
